(function(){var t,e=function(t,e){function n(){this.constructor=t}for(var r in e)i.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},i={}.hasOwnProperty;t="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Parallelio&&(this.Parallelio={}),null==this.Parallelio.DOM&&(this.Parallelio.DOM={}),this.Parallelio.DOM),function(e){t.Updater=e(),t.Updater.definition=e}(function(t){var i,n;return null==t&&(t={}),i=t.hasOwnProperty("BaseUpdater")?t.BaseUpdater:Parallelio.Spark.Updater,n=function(t){function i(){i.__super__.constructor.call(this),this.updateCallback=function(t){return function(){return t.update()}}(this),this.binded=!1}return e(i,t),i.prototype.update=function(){if(i.__super__.update.call(this),this.binded=!1,this.callbacks.length>0)return this.requestFrame()},i.prototype.requestFrame=function(){if(!this.binded)return window.requestAnimationFrame(this.updateCallback),this.binded=!0},i.prototype.addCallback=function(t){return i.__super__.addCallback.call(this,t),this.requestFrame()},i}(i),n.instance=new n,n}),function(e){t.Display=e(),t.Display.definition=e}(function(i){var n,r;return null==i&&(i={}),n=i.hasOwnProperty("Element")?i.Element:Parallelio.Element,r=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.include(EventEmitter.prototype),i.properties({displayContainer:{updater:r.instance,default:null,change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},cls:{updater:r.instance,change:function(t){if(this.getPropertyInstance("display").calculated&&(null!=t&&this.display.removeClass(t),null!=this.cls))return this.display.addClass(this.cls)}},display:{calcul:function(){var t,e;return e=document.createElement("div"),t=jQuery(e).addClass(this.baseCls).addClass(this.cls).css({top:this.displayY,left:this.displayX}),t.get(0)._parallelio_obj=this,t}},displayX:{updater:r.instance,default:0,change:function(t){if(this.getPropertyInstance("display").calculated)return this.display.css({left:this.displayX})}},displayY:{updater:r.instance,default:0,change:function(t){if(this.getPropertyInstance("display").calculated)return this.display.css({top:this.displayY})}}}),i.prototype.initDisplay=function(){return this.displayContainer},i.prototype.destroyDisplay=function(){if(null!=this._display)return this.display.remove()},i}(n)}),function(e){t.Tiled=e(),t.Tiled.definition=e}(function(i){var n,r;return null==i&&(i={}),n=i.hasOwnProperty("BaseTiled")?i.BaseTiled:Parallelio.Tiled,r=i.hasOwnProperty("Display")?i.Display:t.Display,function(t){function i(){i.__super__.constructor.call(this),this.initDisplay()}return e(i,t),i.extend(r),i.include(EventEmitter.prototype),i.properties({displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return t.prop("displayContainer",e)}},displayX:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayX+e.tileToDisplayX(t.prop("offsetX"))}},displayY:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayY+e.tileToDisplayY(t.prop("offsetY"))}}}),i}(n)}),function(e){t.Character=e(),t.Character.definition=e}(function(i){var n,r;return null==i&&(i={}),r=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,n=i.hasOwnProperty("BaseCharacter")?i.BaseCharacter:Parallelio.Character.definition({Tiled:r}),i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(){i.__super__.constructor.call(this),this.baseCls="character"}return e(i,t),i}(n)}),function(e){t.Damageable=e(),t.Damageable.definition=e}(function(i){var n,r,a;return null==i&&(i={}),n=i.hasOwnProperty("BaseDamageable")?i.BaseDamageable:Parallelio.Damageable,r=i.hasOwnProperty("Display")?i.Display:t.Display,a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(){i.__super__.constructor.call(this),this.healthCls(),this.initDisplay()}return e(i,t),i.extend(r),i.include(EventEmitter.prototype),i.properties({healthClsSteps:{default:10},healthCls:{updater:a.instance,active:function(t){return t.propInitiated("display")},calcul:function(t){return"health-"+Math.ceil(t.prop("health")/t.prop("maxHealth")*t.prop("healthClsSteps"))},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.healthCls)return this.display.addClass(this.healthCls)}}}),i}(n)}),function(e){t.Door=e(),t.Door.definition=e}(function(i){var n,r,a;return null==i&&(i={}),r=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,n=i.hasOwnProperty("BaseDoor")?i.BaseDoor:Parallelio.Door.definition({Tiled:r}),a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(t){this.baseCls="door",i.__super__.constructor.call(this,t)}return e(i,t),i.properties({direction:{updater:a.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.direction)return this.display.addClass(this.direction)}}}),i}(n)}),function(e){t.Projectile=e(),t.Projectile.definition=e}(function(i){var n,r,a;return null==i&&(i={}),n=i.hasOwnProperty("BaseProjectile")?i.BaseProjectile:Parallelio.Projectile,r=i.hasOwnProperty("Display")?i.Display:t.Display,a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.extend(r),i.prototype.init=function(){return i.__super__.init.call(this),this.baseCls="projectile",this.initDisplay()},i.properties({displayContainer:{calcul:function(t){var e;return e=t.prop("container"),(null!=e?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):t.prop("originTile").displayContainer}},displayX:{calcul:function(t){return this.originTile.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.originTile.tileToDisplayY(t.prop("y"))}},moving:{change:function(){return this.moving?a.instance.addCallback(this.callback("invalidatePrcPath")):a.instance.removeCallback(this.callback("invalidatePrcPath"))}}}),i.prototype.destroy=function(){return this.destroyDisplay(),a.instance.removeCallback(this.callback("invalidatePrcPath"))},i}(n)}),function(e){t.Tile=e(),t.Tile.definition=e}(function(i){var n,r,a,l;return null==i&&(i={}),n=i.hasOwnProperty("BaseTile")?i.BaseTile:Parallelio.Tile,a=i.hasOwnProperty("Floor")?i.Floor:Parallelio.Floor,r=i.hasOwnProperty("Display")?i.Display:t.Display,l=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.extend(r),i.size=20,i.prototype.init=function(){return i.__super__.init.call(this),this.baseCls="tile",this.initDisplay()},i.properties({container:{},displayContainer:{calcul:function(t){var e;return e=t.prop("container"),(null!=e?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):void 0}},displayX:{calcul:function(t){return this.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.tileToDisplayY(t.prop("y"))}}}),i.prototype.tileToDisplayX=function(t){return t*i.size},i.prototype.tileToDisplayY=function(t){return t*i.size},i}(n),l.Floor=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.init=function(){return i.__super__.init.call(this),this.cls="floor"},i}(a.definition({Tile:l})),l}),function(e){t.Ship=e(),t.Ship.definition=e}(function(i){var n,r,a,l,o;return null==i&&(i={}),l=i.hasOwnProperty("Tile")?i.Tile:t.Tile,o=i.hasOwnProperty("TileContainer")?i.TileContainer:Parallelio.TileContainer,n=i.hasOwnProperty("DefaultGenerator")?i.DefaultGenerator:Parallelio.RoomGenerator,r=i.hasOwnProperty("Door")?i.Door:t.Door,a=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.include(EventEmitter.prototype),i.prototype.init=function(){return i.__super__.init.call(this),this.displayContainer},i.properties({container:{},displayContainer:{calcul:function(t){var e;if(e=t.prop("container"),null!=e?e.getProperty("display"):void 0)return e.display},change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},display:{calcul:function(){var t;return t=$(document.createElement("div")).addClass("ship"),t.get(0)._parallelio_obj=this,t}}}),i.prototype.generate=function(t){return t=t||(new i.Generator).tap(function(){}),t.getTiles().forEach(function(t){return function(e){return t.addTile(e)}}(this))},i}(o),a.Generator=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.wallFactory=function(t){return new l(t.x,t.y).tap(function(){return this.cls="wall",this.walkable=!1})},i.prototype.floorFactory=function(t){return new l.Floor(t.x,t.y)},i.prototype.doorFactory=function(t){return new l.Floor(t.x,t.y).tap(function(){return this.addChild(new r(t.direction))})},i}(n),a}),function(e){t.View=e(),t.View.definition=e}(function(t){var i;return null==t&&(t={}),i=t.hasOwnProperty("Element")?t.Element:Parallelio.Element,function(t){function i(t){this.display=null!=t?t:null,this.hovered=!1,this.keysInterval={}}return e(i,t),i.directionkeys={38:{name:"top",x:0,y:-1},39:{name:"right",x:1,y:0},40:{name:"bottom",x:0,y:1},37:{name:"left",x:-1,y:0}},i.properties({x:{default:0,change:function(){return this.updateDisplayPos()}},y:{default:0,change:function(){return this.updateDisplayPos()}},display:{change:function(){return 0===$(".viewContent",this.display).length&&$(this.display).append('<div class="viewContent"></div>'),this.updateDisplayPos(),$(this.display).mouseenter(this.callback("mouseEnter")),$(this.display).mouseleave(this.callback("mouseLeave"))}}}),i.prototype.mouseEnter=function(){return this.hovered=!0,$("body").keydown(this.callback("keyDown")),$("body").keyup(this.callback("keyUp"))},i.prototype.mouseLeave=function(){var t,e,i,n;this.hovered=!1,$("body").off("keydown",this.callback("keyDown")),$("body").off("keyup",this.callback("keyUp")),i=this.keysInterval,n=[];for(t in i)e=i[t],n.push(clearInterval(e));return n},i.prototype.keyDown=function(t){var e;if(null!=i.directionkeys[t.which])return e=i.directionkeys[t.which],null!=this.keysInterval[e.name]&&clearInterval(this.keysInterval[e.name]),this.keysInterval[e.name]=setInterval(function(t){return function(){return t.x+=2*e.x,t.y+=2*e.y}}(this),10)},i.prototype.keyUp=function(t){var e;if(null!=i.directionkeys[t.which]&&(e=i.directionkeys[t.which],null!=this.keysInterval[e.name]))return clearInterval(this.keysInterval[e.name])},i.prototype.updateDisplayPos=function(){return $(".viewContent",this.display).css({left:this.x+"px",top:this.y+"px"})},i.prototype.containsPoint=function(t,e){var i;for(i=this.display[0];i;)t-=i.offsetLeft,e-=i.offsetTop,i=i.offsetParent;return 0<=t&&t<=this.display.width()&&0<=e&&e<=this.display.height()},i}(i)}),function(e){t.Weapon=e(),t.Weapon.definition=e}(function(i){var n,r,a,l,o;return null==i&&(i={}),l=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,a=i.hasOwnProperty("Projectile")?i.Projectile:t.Projectile,r=i.hasOwnProperty("Damageable")?i.Damageable:t.Damageable,n=i.hasOwnProperty("BaseWeapon")?i.BaseWeapon:Parallelio.Weapon.definition({Tiled:l,Damageable:r,Projectile:a}),o=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(t){function i(t){this.baseCls="weapon",i.__super__.constructor.call(this,t)}return e(i,t),i.properties({direction:{updater:o.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t.name),null!=this.direction.name)return this.display.addClass(this.direction.name)}}}),i}(n)})}).call(this);