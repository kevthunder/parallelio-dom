(function(){var l,t,e,i,n,r,a,o,s,p,u,c,d,h=function(t,e){for(var i in e)y.call(e,i)&&(t[i]=e[i]);function n(){this.constructor=t}return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},y={}.hasOwnProperty;l="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Parallelio&&(this.Parallelio={}),null==this.Parallelio.DOM&&(this.Parallelio.DOM={}),this.Parallelio.DOM),t=function(t){var i,e;return null==t&&(t={}),i=t.hasOwnProperty("BaseUpdater")?t.BaseUpdater:Parallelio.Spark.Updater,(e=function(t){function e(){var t;e.__super__.constructor.call(this),this.updateCallback=(t=this,function(){return t.update()}),this.binded=!1}return h(e,i),e.prototype.update=function(){if(e.__super__.update.call(this),this.binded=!1,0<this.callbacks.length)return this.requestFrame()},e.prototype.requestFrame=function(){if(!this.binded)return window.requestAnimationFrame(this.updateCallback),this.binded=!0},e.prototype.addCallback=function(t){return e.__super__.addCallback.call(this,t),this.requestFrame()},e}()).instance=new e,e},l.Updater=t(),l.Updater.definition=t,e=function(t){var i,n;return null==t&&(t={}),i=t.hasOwnProperty("Element")?t.Element:Parallelio.Element,n=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return h(e,i),e.include(EventEmitter.prototype),e.properties({displayContainer:{updater:n.instance,default:null,change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},cls:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.cls)return this.display.addClass(this.cls)}},display:{calcul:function(){var t,e;return e=document.createElement("div"),(t=jQuery(e).addClass(this.baseCls)).get(0)._parallelio_obj=this,t}},displayX:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){return this.display.css({left:this.displayX})}},displayY:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){return this.display.css({top:this.displayY})}}}),e.prototype.initDisplay=function(){return this.cls,this.displayX,this.displayY,this.displayContainer},e.prototype.destroyDisplay=function(){if(null!=this._display)return this.display.remove()},e}()},l.Display=e(),l.Display.definition=e,i=function(t){var i,n;return null==t&&(t={}),i=t.hasOwnProperty("BaseTiled")?t.BaseTiled:Parallelio.Tiled,n=t.hasOwnProperty("Display")?t.Display:l.Display,function(t){function e(){e.__super__.constructor.call(this),this.initDisplay()}return h(e,i),e.extend(n),e.include(EventEmitter.prototype),e.properties({displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return t.prop("displayContainer",e)}},displayX:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayX+e.tileToDisplayX(t.prop("offsetX"))}},displayY:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayY+e.tileToDisplayY(t.prop("offsetY"))}}}),e}()},l.Tiled=i(),l.Tiled.definition=i,n=function(t){var i,e;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:l.Tiled,i=t.hasOwnProperty("BaseCharacter")?t.BaseCharacter:Parallelio.Character.definition({Tiled:e}),t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(){e.__super__.constructor.call(this),this.baseCls="character"}return h(e,i),e}()},l.Character=n(),l.Character.definition=n,r=function(t){var i,n,r;return null==t&&(t={}),i=t.hasOwnProperty("BaseDamageable")?t.BaseDamageable:Parallelio.Damageable,n=t.hasOwnProperty("Display")?t.Display:l.Display,r=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(){e.__super__.constructor.call(this),this.healthCls(),this.initDisplay()}return h(e,i),e.extend(n),e.include(EventEmitter.prototype),e.properties({healthClsSteps:{default:10},healthCls:{updater:r.instance,active:function(t){return t.propInitiated("display")},calcul:function(t){return"health-"+Math.ceil(t.prop("health")/t.prop("maxHealth")*t.prop("healthClsSteps"))},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.healthCls)return this.display.addClass(this.healthCls)}}}),e}()},l.Damageable=r(),l.Damageable.definition=r,a=function(t){var i,e,n;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:l.Tiled,i=t.hasOwnProperty("BaseDoor")?t.BaseDoor:Parallelio.Door.definition({Tiled:e}),n=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(t){this.baseCls="door",e.__super__.constructor.call(this,t)}return h(e,i),e.properties({direction:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.direction)return this.display.addClass(this.direction)}}}),e}()},l.Door=a(),l.Door.definition=a,o=function(t){var i,n,r;return null==t&&(t={}),i=t.hasOwnProperty("BaseProjectile")?t.BaseProjectile:Parallelio.Projectile,n=t.hasOwnProperty("Display")?t.Display:l.Display,r=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return h(e,i),e.extend(n),e.prototype.init=function(){return e.__super__.init.call(this),this.baseCls="projectile",this.initDisplay()},e.properties({displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):t.prop("originTile").displayContainer}},displayX:{calcul:function(t){return this.originTile.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.originTile.tileToDisplayY(t.prop("y"))}},moving:{change:function(){return this.moving?r.instance.addCallback(this.callback("invalidatePrcPath")):r.instance.removeCallback(this.callback("invalidatePrcPath"))}}}),e.prototype.destroy=function(){return this.destroyDisplay(),r.instance.removeCallback(this.callback("invalidatePrcPath"))},e}()},l.Projectile=o(),l.Projectile.definition=o,s=function(t){var i,n,e,r;return null==t&&(t={}),i=t.hasOwnProperty("BaseTile")?t.BaseTile:Parallelio.Tile,e=t.hasOwnProperty("Floor")?t.Floor:Parallelio.Floor,n=t.hasOwnProperty("Display")?t.Display:l.Display,(r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return h(e,i),e.extend(n),e.size=20,e.prototype.init=function(){return e.__super__.init.call(this),this.baseCls="tile",this.initDisplay()},e.properties({container:{},displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):void 0}},displayX:{calcul:function(t){return this.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.tileToDisplayY(t.prop("y"))}}}),e.prototype.tileToDisplayX=function(t){return t*e.size},e.prototype.tileToDisplayY=function(t){return t*e.size},e}()).Floor=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return h(e,t),e.prototype.init=function(){return e.__super__.init.call(this),this.cls="floor"},e}(e.definition({Tile:r})),r},l.Tile=s(),l.Tile.definition=s,p=function(t){var i,n,e,r,a;return null==t&&(t={}),r=t.hasOwnProperty("Tile")?t.Tile:l.Tile,a=t.hasOwnProperty("TileContainer")?t.TileContainer:Parallelio.TileContainer,i=t.hasOwnProperty("DefaultGenerator")?t.DefaultGenerator:Parallelio.RoomGenerator,n=t.hasOwnProperty("Door")?t.Door:l.Door,(e=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return h(i,a),i.include(EventEmitter.prototype),i.prototype.init=function(){return i.__super__.init.call(this),this.displayContainer},i.properties({container:{},displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("container"))?e.getProperty("display"):void 0)return e.display},change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},display:{calcul:function(){var t;return(t=$(document.createElement("div")).addClass("ship")).get(0)._parallelio_obj=this,t}}}),i.prototype.generate=function(t){return(t=t||(new i.Generator).tap(function(){})).getTiles().forEach((e=this,function(t){return e.addTile(t)}));var e},i}()).Generator=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return h(e,i),e.prototype.wallFactory=function(t){return new r(t.x,t.y).tap(function(){return this.cls="wall",this.walkable=!1})},e.prototype.floorFactory=function(t){return new r.Floor(t.x,t.y)},e.prototype.doorFactory=function(t){return new r.Floor(t.x,t.y).tap(function(){return this.addChild(new n(t.direction))})},e}(),e},l.Ship=p(),l.Ship.definition=p,u=function(t){var e;return null==t&&(t={}),e=t.hasOwnProperty("Element")?t.Element:Parallelio.Element,function(t){function n(t){this.display=null!=t?t:null,this.hovered=!1,this.keysInterval={}}return h(n,e),n.directionkeys={38:{name:"top",x:0,y:-1},39:{name:"right",x:1,y:0},40:{name:"bottom",x:0,y:1},37:{name:"left",x:-1,y:0}},n.properties({x:{default:0,change:function(){return this.updateDisplayPos()}},y:{default:0,change:function(){return this.updateDisplayPos()}},display:{change:function(){return 0===$(".viewContent",this.display).length&&$(this.display).append('<div class="viewContent"></div>'),this.updateDisplayPos(),$(this.display).mouseenter(this.callback("mouseEnter")),$(this.display).mouseleave(this.callback("mouseLeave"))}}}),n.prototype.mouseEnter=function(){return this.hovered=!0,$("body").keydown(this.callback("keyDown")),$("body").keyup(this.callback("keyUp"))},n.prototype.mouseLeave=function(){var t,e,i,n;for(t in this.hovered=!1,$("body").off("keydown",this.callback("keyDown")),$("body").off("keyup",this.callback("keyUp")),n=[],i=this.keysInterval)e=i[t],n.push(clearInterval(e));return n},n.prototype.keyDown=function(t){var e,i;if(null!=n.directionkeys[t.which])return e=n.directionkeys[t.which],null!=this.keysInterval[e.name]&&clearInterval(this.keysInterval[e.name]),this.keysInterval[e.name]=setInterval((i=this,function(){return i.x+=2*e.x,i.y+=2*e.y}),10)},n.prototype.keyUp=function(t){var e;if(null!=n.directionkeys[t.which]&&(e=n.directionkeys[t.which],null!=this.keysInterval[e.name]))return clearInterval(this.keysInterval[e.name])},n.prototype.updateDisplayPos=function(){return $(".viewContent",this.display).css({left:this.x+"px",top:this.y+"px"})},n.prototype.containsPoint=function(t,e){var i;for(i=this.display[0];i;)t-=i.offsetLeft,e-=i.offsetTop,i=i.offsetParent;return 0<=t&&t<=this.display.width()&&0<=e&&e<=this.display.height()},n}()},l.View=u(),l.View.definition=u,c=function(t){var i,e,n,r,a;return null==t&&(t={}),r=t.hasOwnProperty("Tiled")?t.Tiled:l.Tiled,n=t.hasOwnProperty("Projectile")?t.Projectile:l.Projectile,e=t.hasOwnProperty("Damageable")?t.Damageable:l.Damageable,i=t.hasOwnProperty("BaseWeapon")?t.BaseWeapon:Parallelio.Weapon.definition({Tiled:r,Damageable:e,Projectile:n}),a=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(t){this.baseCls="weapon",e.__super__.constructor.call(this,t)}return h(e,i),e.properties({direction:{updater:a.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t.name),null!=this.direction.name)return this.display.addClass(this.direction.name)}}}),e}()},l.Weapon=c(),l.Weapon.definition=c,d=function(t){var i,e,n;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:l.Tiled,i=t.hasOwnProperty("BaseWire")?t.BaseWire:Parallelio.Wire.definition({Tiled:e}),n=t.hasOwnProperty("Updater")?t.Updater:l.Updater,function(t){function e(t){e.__super__.constructor.call(this,t),this.baseCls="wire",this.connectedDirections}return h(e,i),e.properties({display:{calcul:function(t,e){return e()}},connectedDirections:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){var e,i;return t&&t.forEach((e=this,function(t){return e.display.removeClass(e.getClassFromDirection(t))})),this.connectedDirections.forEach((i=this,function(t){return i.display.addClass(i.getClassFromDirection(t))}))}},wireType:{updater:n.instance,active:function(t){return t.propInitiated("display")},change:function(t){return t&&this.display.removeClass(t),this.display.addClass(this.wireType)}}}),e.prototype.getClassFromDirection=function(t){return"conn"+t.name.charAt(0).toUpperCase()+t.name.slice(1)},e}()},l.Wire=d(),l.Wire.definition=d}).call(this);