(function(){var p,t,e,n,i,r,o,a,s,l,u,c,h,d,f,y,g,v,m,b,T,w,k,_,x,P,C,S,O,E,D,A,I,M,F,R,j,L,B,U=[].slice,N=function(t,e){for(var n in e)q.call(e,n)&&(t[n]=e[n]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},q={}.hasOwnProperty,W=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};null==(p="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Parallelio&&(this.Parallelio={}),this.Parallelio)).Spark&&(p.Spark={}),p.strings={greekAlphabet:["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"],starNames:["Achernar","Maia","Atlas","Salm","Alnilam","Nekkar","Elnath","Thuban","Achird","Marfik","Auva","Sargas","Alnitak","Nihal","Enif","Torcularis","Acrux","Markab","Avior","Sarin","Alphard","Nunki","Etamin","Turais","Acubens","Matar","Azelfafage","Sceptrum","Alphekka","Nusakan","Fomalhaut","Tyl","Adara","Mebsuta","Azha","Scheat","Alpheratz","Peacock","Fornacis","Unukalhai","Adhafera","Megrez","Azmidiske","Segin","Alrai","Phad","Furud","Vega","Adhil","Meissa","Baham","Seginus","Alrisha","Phaet","Gacrux","Vindemiatrix","Agena","Mekbuda","Becrux","Sham","Alsafi","Pherkad","Gianfar","Wasat","Aladfar","Menkalinan","Beid","Sharatan","Alsciaukat","Pleione","Gomeisa","Wezen","Alathfar","Menkar","Bellatrix","Shaula","Alshain","Polaris","Graffias","Wezn","Albaldah","Menkent","Betelgeuse","Shedir","Alshat","Pollux","Grafias","Yed","Albali","Menkib","Botein","Sheliak","Alsuhail","Porrima","Grumium","Yildun","Albireo","Merak","Brachium","Sirius","Altair","Praecipua","Hadar","Zaniah","Alchiba","Merga","Canopus","Situla","Altarf","Procyon","Haedi","Zaurak","Alcor","Merope","Capella","Skat","Alterf","Propus","Hamal","Zavijah","Alcyone","Mesarthim","Caph","Spica","Aludra","Rana","Hassaleh","Zibal","Alderamin","Metallah","Castor","Sterope","Alula","Ras","Heze","Zosma","Aldhibah","Miaplacidus","Cebalrai","Sualocin","Alya","Rasalgethi","Hoedus","Aquarius","Alfirk","Minkar","Celaeno","Subra","Alzirr","Rasalhague","Homam","Aries","Algenib","Mintaka","Chara","Suhail","Ancha","Rastaban","Hyadum","Cepheus","Algieba","Mira","Chort","Sulafat","Angetenar","Regulus","Izar","Cetus","Algol","Mirach","Cursa","Syrma","Ankaa","Rigel","Jabbah","Columba","Algorab","Miram","Dabih","Tabit","Anser","Rotanev","Kajam","Coma","Alhena","Mirphak","Deneb","Talitha","Antares","Ruchba","Kaus","Corona","Alioth","Mizar","Denebola","Tania","Arcturus","Ruchbah","Keid","Crux","Alkaid","Mufrid","Dheneb","Tarazed","Arkab","Rukbat","Kitalpha","Draco","Alkalurops","Muliphen","Diadem","Taygeta","Arneb","Sabik","Kocab","Grus","Alkes","Murzim","Diphda","Tegmen","Arrakis","Sadalachbia","Kornephoros","Hydra","Alkurhah","Muscida","Dschubba","Tejat","Ascella","Sadalmelik","Kraz","Lacerta","Almaak","Naos","Dsiban","Terebellum","Asellus","Sadalsuud","Kuma","Mensa","Alnair","Nash","Dubhe","Thabit","Asterope","Sadr","Lesath","Maasym","Alnath","Nashira","Electra","Theemim","Atik","Saiph","Phoenix","Norma"]},t=function(){return function(){function n(t,e){this.property=t,this.obj=e,this.init()}return n.prototype.init=function(){return this.value=this.ingest(this.default),this.calculated=!1},n.prototype.get=function(){return this.calculated=!0,this.output()},n.prototype.set=function(t){return this.setAndCheckChanges(t)},n.prototype.callbackSet=function(t){return this.callOptionFunct("set",t),this},n.prototype.setAndCheckChanges=function(t){var e;return t=this.ingest(t),this.revalidated(),this.checkChanges(t,this.value)&&(e=this.value,this.value=t,this.manual=!0,this.changed(e)),this},n.prototype.checkChanges=function(t,e){return t!==e},n.prototype.destroy=function(){},n.prototype.callOptionFunct=function(){var t,e,n;return e=arguments[0],t=2<=arguments.length?U.call(arguments,1):[],"string"==typeof e&&(e=this.property.options[e]),"function"==typeof e.overrided&&t.push((n=this,function(){var t;return t=1<=arguments.length?U.call(arguments,0):[],n.callOptionFunct.apply(n,[e.overrided].concat(U.call(t)))})),e.apply(this.obj,t)},n.prototype.revalidated=function(){return this.calculated=!0,this.initiated=!0},n.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?this.callOptionFunct("ingest",t):t},n.prototype.output=function(){return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.value},n.prototype.changed=function(t){return this.callChangedFunctions(t),"function"==typeof this.obj.emitEvent&&(this.obj.emitEvent(this.updateEventName,[t]),this.obj.emitEvent(this.changeEventName,[t])),this},n.prototype.callChangedFunctions=function(t){if("function"==typeof this.property.options.change)return this.callOptionFunct("change",t)},n.prototype.hasChangedFunctions=function(){return"function"==typeof this.property.options.change},n.prototype.hasChangedEvents=function(){return"function"==typeof this.obj.getListeners&&0<this.obj.getListeners(this.changeEventName).length},n.compose=function(t){return null==t.instanceType&&(t.instanceType=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e}()),"function"==typeof t.options.set?t.instanceType.prototype.set=this.prototype.callbackSet:t.instanceType.prototype.set=this.prototype.setAndCheckChanges,t.instanceType.prototype.default=t.options.default,t.instanceType.prototype.initiated=void 0!==t.options.default,this.setEventNames(t)},n.setEventNames=function(t){return t.instanceType.prototype.changeEventName=t.options.changeEventName||t.name+"Changed",t.instanceType.prototype.updateEventName=t.options.updateEventName||t.name+"Updated",t.instanceType.prototype.invalidateEventName=t.options.invalidateEventName||t.name+"Invalidated"},n.bind=function(t,e){var n,i;return n=e.name.charAt(0).toUpperCase()+e.name.slice(1),!(i={configurable:!0,get:function(){return e.getInstance(this).get()}})!==e.options.set&&(i.set=function(t){return e.getInstance(this).set(t)}),Object.defineProperty(t,e.name,i),!(t["get"+n]=function(){return e.getInstance(this).get()})!==e.options.set&&(t["set"+n]=function(t){return e.getInstance(this).set(t),this}),t["invalidate"+n]=function(){return e.getInstance(this).invalidate(),this}},n}()},p.Spark.PropertyInstance=t(),p.Spark.PropertyInstance.definition=t,e=function(){var t;return t=function(){function t(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}return t.prototype.changed=function(){},t.prototype.checkChanges=function(n,t,i){return null==t&&(t=!0),null==i&&(i=null),null==i&&(i=function(t,e){return t===e}),n=this.copy(n.slice()),this.count()!==n.length||(t?this.some(function(t,e){return!i(n.get(e),t)}):this.some(function(e){return!n.pluck(function(t){return i(e,t)})}))},t.prototype.get=function(t){return this._array[t]},t.prototype.set=function(t,e){var n;return this._array[t]!==e&&(n=this.toArray(),this._array[t]=e,this.changed(n)),e},t.prototype.add=function(t){if(!this._array.includes(t))return this.push(t)},t.prototype.remove=function(t){var e,n;if(-1!==(e=this._array.indexOf(t)))return n=this.toArray(),this._array.splice(e,1),this.changed(n)},t.prototype.pluck=function(t){var e,n,i;return-1<(n=this._array.findIndex(t))?(i=this.toArray(),e=this._array[n],this._array.splice(n,1),this.changed(i),e):null},t.prototype.toArray=function(){return this._array.slice()},t.prototype.count=function(){return this._array.length},t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(n){return t.prototype[n]=function(){var t,e;return t=1<=arguments.length?U.call(arguments,0):[],(e=this._array)[n].apply(e,t)}}),t.readListFunctions.forEach(function(n){return t.prototype[n]=function(){var t,e;return t=1<=arguments.length?U.call(arguments,0):[],this.copy((e=this._array)[n].apply(e,t))}}),t.writefunctions.forEach(function(r){return t.prototype[r]=function(){var t,e,n,i;return t=1<=arguments.length?U.call(arguments,0):[],e=this.toArray(),i=(n=this._array)[r].apply(n,t),this.changed(e),i}}),t.newSubClass=function(t,e){var n;return"object"==typeof t?(n=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,t),e}(this),Object.assign(n.prototype,t),new n(e)):new this(e)},t.prototype.copy=function(t){return null==t&&(t=this.toArray()),new this.constructor(t)},t.prototype.equals=function(n){return this.count()===("function"==typeof n.count?n.count():n.length)&&this.every(function(t,e){return n[e]===t})},t.prototype.getAddedFrom=function(e){return this._array.filter(function(t){return!e.includes(t)})},t.prototype.getRemovedFrom=function(t){return t.filter((e=this,function(t){return!e.includes(t)}));var e},t}(),Object.defineProperty(t.prototype,"length",{get:function(){return this.count()}}),("undefined"!=typeof Symbol&&null!==Symbol?Symbol.iterator:void 0)&&(t.prototype[Symbol.iterator]=function(){return this._array[Symbol.iterator]()}),t},p.Spark.Collection=e(),p.Spark.Collection.definition=e,n=function(){return function(){function t(){}return t.prototype.bind=function(){return this.binded||null==this.callback||null==this.target||this.doBind(),this.binded=!0},t.prototype.doBind=function(){throw new Error("Not implemented")},t.prototype.unbind=function(){return this.binded&&null!=this.callback&&null!=this.target&&this.doUnbind(),this.binded=!1},t.prototype.doUnbind=function(){throw new Error("Not implemented")},t.prototype.equals=function(t){return this.constructor.compareRefered(t,this)},t.compareRefered=function(t,e){return t===e||null!=t&&null!=e&&t.constructor===e.constructor&&this.compareRef(t.ref,e.ref)},t.compareRef=function(n,i){return null!=n&&null!=i&&(n===i||Array.isArray(n)&&Array.isArray(n)&&n.every((r=this,function(t,e){return r.compareRefered(n[e],i[e])}))||"object"==typeof n&&"object"==typeof i&&Object.keys(n).join()===Object.keys(i).join()&&Object.keys(n).every((e=this,function(t){return e.compareRefered(n[t],i[t])})));var e,r},t}()},p.Spark.Binder=n(),p.Spark.Binder.definition=n,i=function(t){var n,e;return null==t&&(t={}),n=t.hasOwnProperty("Binder")?t.Binder:p.Spark.Binder,(e=function(){function t(){this.callbacks=[],this.next=[],this.updating=!1}return t.prototype.update=function(){for(this.updating=!0,this.next=this.callbacks.slice();0<this.callbacks.length;)this.callbacks.shift()();return this.callbacks=this.next,this.updating=!1,this},t.prototype.addCallback=function(t){if(this.callbacks.includes(t)||this.callbacks.push(t),this.updating&&!this.next.includes(t))return this.next.push(t)},t.prototype.nextTick=function(t){return this.updating?this.next.includes(t)?void 0:this.next.push(t):this.addCallback(t)},t.prototype.removeCallback=function(t){var e;if(-1!==(e=this.callbacks.indexOf(t))&&this.callbacks.splice(e,1),-1!==(e=this.next.indexOf(t)))return this.next.splice(e,1)},t.prototype.getBinder=function(){return new t.Binder(this)},t.prototype.destroy=function(){return this.callbacks=[],this.next=[]},t}()).Binder=function(t){function e(t,e){this.target=t,this.callback=e,this.ref={target:this.target,callback:this.callback}}return N(e,n),e.prototype.doBind=function(){return this.target.addCallback(this.callback)},e.prototype.doUnbind=function(){return this.target.removeCallback(this.callback)},e}(),e},p.Spark.Updater=i(),p.Spark.Updater.definition=i,r=function(t){var r,o;return null==t&&(t={}),r=t.hasOwnProperty("BaseUpdater")?t.BaseUpdater:p.Spark.Updater,(o=function(){function t(t){this.running=null==t||t,this.children=[]}return t.prototype.addChild=function(t){var e;return e=this.children.indexOf(t),this.updater&&(t.updater.dispatcher=this.updater),-1===e&&this.children.push(t),t.parent=this},t.prototype.removeChild=function(t){var e;return-1<(e=this.children.indexOf(t))&&this.children.splice(e,1),t.parent===this&&(t.parent=null),this},t.prototype.toggle=function(e){return void 0===e&&(e=!this.running),this.running=e,this.children.forEach(function(t){return t.toggle(e)})},t.prototype.setTimeout=function(t,e){var n;return n=new this.constructor.Timer(e,t,this.running),this.addChild(n),n},t.prototype.setInterval=function(t,e){var n;return n=new this.constructor.Timer(e,t,this.running,!0),this.addChild(n),n},t.prototype.pause=function(){return this.toggle(!1)},t.prototype.unpause=function(){return this.toggle(!0)},t}()).Timer=function(){function t(t,e,n,i){this.time=t,this.running=null==n||n,this.repeat=null!=i&&i,this.remainingTime=this.time,this.updater=new o.Updater(this),this.dispatcher=new r,e&&this.dispatcher.addCallback(e),this.running&&this._start()}return t.now=function(){var t;return null!=("undefined"!=typeof window&&null!==window&&null!=(t=window.performance)?t.now:void 0)?window.performance.now():null!=("undefined"!=typeof process&&null!==process?process.uptime:void 0)?1e3*process.uptime():Date.now()},t.prototype.toggle=function(t){return void 0===t&&(t=!this.running),t?this._start():this._stop()},t.prototype.pause=function(){return this.toggle(!1)},t.prototype.unpause=function(){return this.toggle(!0)},t.prototype.getElapsedTime=function(){return this.running?this.constructor.now()-this.startTime+this.time-this.remainingTime:this.time-this.remainingTime},t.prototype.setElapsedTime=function(t){return this._stop(),this.remainingTime=this.time-t,this._start()},t.prototype.getPrc=function(){return this.getElapsedTime()/this.time},t.prototype.setPrc=function(t){return this.setElapsedTime(this.time*t)},t.prototype._start=function(){return this.running=!0,this.updater.forwardCallbacks(),this.startTime=this.constructor.now(),this.repeat&&!this.interupted?this.id=setInterval(this.tick.bind(this),this.remainingTime):this.id=setTimeout(this.tick.bind(this),this.remainingTime)},t.prototype._stop=function(){var t;return t=this.interupted,this.running=!1,this.updater.unforwardCallbacks(),this.remainingTime=this.time-(this.constructor.now()-this.startTime),this.interupted=this.remainingTime!==this.time,this.repeat&&!t?clearInterval(this.id):clearTimeout(this.id)},t.prototype.tick=function(){var t;return t=this.interupted,this.interupted=!1,this.repeat?this.remainingTime=this.time:this.remainingTime=0,this.dispatcher.update(),this.repeat?t?this._start():this.startTime=this.constructor.now():this.destroy()},t.prototype.destroy=function(){if(this.repeat?clearInterval(this.id):clearTimeout(this.id),this.updater.destroy(),this.dispatcher.destroy(),this.running=!1,this.parent)return this.parent.removeChild(this)},t}(),o.Updater=function(){function t(t){this.parent=t,this.dispatcher=new r,this.callbacks=[]}return t.prototype.addCallback=function(t){if(this.callbacks.includes(t)||this.callbacks.push(t),this.parent.running&&this.dispatcher)return this.dispatcher.addCallback(t)},t.prototype.removeCallback=function(t){var e;if(-1!==(e=this.callbacks.indexOf(t))&&this.callbacks.splice(e,1),this.dispatcher)return this.dispatcher.removeCallback(t)},t.prototype.getBinder=function(){if(this.dispatcher)return new r.Binder(this)},t.prototype.forwardCallbacks=function(){if(this.dispatcher)return this.callbacks.forEach((e=this,function(t){return e.dispatcher.addCallback(t)}));var e},t.prototype.unforwardCallbacks=function(){if(this.dispatcher)return this.callbacks.forEach((e=this,function(t){return e.dispatcher.removeCallback(t)}));var e},t.prototype.destroy=function(){return this.unforwardCallbacks(),this.callbacks=[],this.parent=null},t}(),o},p.Timing=r(),p.Timing.definition=r,o=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Binder")?t.Binder:p.Spark.Binder,function(t){function e(t,e,n){this.event=t,this.target=e,this.callback=n,this.ref={event:this.event,target:this.target,callback:this.callback}}return N(e,n),e.prototype.doBind=function(){if("function"==typeof this.target.addEventListener)return this.target.addEventListener(this.event,this.callback);if("function"==typeof this.target.addListener)return this.target.addListener(this.event,this.callback);if("function"==typeof this.target.on)return this.target.on(this.event,this.callback);throw new Error("No function to add event listeners was found")},e.prototype.doUnbind=function(){if("function"==typeof this.target.removeEventListener)return this.target.removeEventListener(this.event,this.callback);if("function"==typeof this.target.removeListener)return this.target.removeListener(this.event,this.callback);if("function"==typeof this.target.off)return this.target.off(this.event,this.callback);throw new Error("No function to remove event listeners was found")},e.prototype.equals=function(t){return e.__super__.equals.call(this,t)&&t.event===this.event},e.prototype.match=function(t,e){return t===this.event&&e===this.target},e.checkEmitter=function(t,e){if(null==e&&(e=!0),"function"==typeof t.addEventListener||"function"==typeof t.addListener||"function"==typeof t.on)return!0;if(e)throw new Error("No function to add event listeners was found");return!1},e}()},p.Spark.EventBind=o(),p.Spark.EventBind.definition=o,a=function(t){var e,i,n;return null==t&&(t={}),e=t.hasOwnProperty("Binder")?t.Binder:p.Spark.Binder,i=t.hasOwnProperty("EventBind")?t.EventBind:p.Spark.EventBind,n=function(t,e){var n,i;return-1<(i=t.findIndex(e))?(n=t[i],t.splice(i,1),n):null},function(t){function o(t,e){var n;this.property=t,this.obj=null!=e?e:null,this.invalidationEvents=[],this.recycled=[],this.unknowns=[],this.strict=this.constructor.strict,this.invalidated=!1,this.invalidateCallback=(n=this,function(){return n.invalidate(),null})}return N(o,e),o.strict=!0,o.prototype.invalidate=function(){var t;return this.invalidated=!0,"function"==typeof this.property?this.property():"function"==typeof this.callback?this.callback():null!=this.property&&"function"==typeof this.property.invalidate?this.property.invalidate():"string"==typeof this.property?(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null):void 0},o.prototype.unknown=function(){return"function"==typeof this.property.unknown?this.property.unknown():this.invalidate()},o.prototype.addEventBind=function(t,e,n){return this.addBinder(new i(t,e,n))},o.prototype.addBinder=function(e){if(null==e.callback&&(e.callback=this.invalidateCallback),!this.invalidationEvents.some(function(t){return t.equals(e)}))return this.invalidationEvents.push(n(this.recycled,function(t){return t.equals(e)})||e)},o.prototype.getUnknownCallback=function(t,e){var n,i;return i=this,(n=function(){return i.addUnknown(function(){return e[t]},t,e)}).ref={maker:arguments.callee,prop:t,target:e},n},o.prototype.addUnknown=function(t,e,n){if(!this.findUnknown(e,n))return t.ref={prop:e,target:n},this.unknowns.push(t),this.unknown()},o.prototype.findUnknown=function(e,n){if(null!=e||null!=n)return this.unknowns.find(function(t){return t.ref.prop===e&&t.ref.target===n})},o.prototype.event=function(t,e){if(null==e&&(e=this.obj),this.checkEmitter(e))return this.addEventBind(t,e)},o.prototype.value=function(t,e,n){return null==n&&(n=this.obj),this.event(e,n),t},o.prototype.prop=function(t,e){if(null==e&&(e=this.obj),"string"!=typeof t)throw new Error("Property name must be a string");return this.checkEmitter(e)?(this.addEventBind(t+"Invalidated",e,this.getUnknownCallback(t,e)),this.value(e[t],t+"Updated",e)):e[t]},o.prototype.propInitiated=function(t,e){var n;return null==e&&(e=this.obj),!(n=e.getPropertyInstance(t).initiated)&&this.checkEmitter(e)&&this.event(t+"Updated",e),n},o.prototype.funct=function(e){var n,i,r;return n=new o((r=this,function(){return r.addUnknown(function(){var t;if(t=e(n),i!==t)return r.invalidate()},n)})),i=e(n),this.invalidationEvents.push(n),i},o.prototype.validateUnknowns=function(t,e){var n;return null==e&&(e=this.obj),n=this.unknowns,this.unknowns=[],n.forEach(function(t){return t()})},o.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},o.prototype.bind=function(){return this.invalidated=!1,this.invalidationEvents.forEach(function(t){return t.bind()})},o.prototype.recycle=function(t){var e,n,i;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],i=this,e=function(){return i.recycled.forEach(function(t){return t.unbind()}),i.recycled=[]},"function"==typeof t?1<t.length?t(this,e):(n=t(this),e(),n):e},o.prototype.checkEmitter=function(t){return i.checkEmitter(t,this.strict)},o.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},o}()},p.Spark.Invalidator=a(),p.Spark.Invalidator.definition=a,s=function(t){var e;return null==t&&(t={}),t.hasOwnProperty("Invalidator")?t.Invalidator:p.Spark.Invalidator,e=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:p.Spark.PropertyInstance,function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return N(n,e),n.prototype.init=function(){return n.__super__.init.call(this),this.initRevalidate()},n.prototype.initRevalidate=function(){return this.revalidateCallback=(t=this,function(){return t.get()});var t},n.prototype.callbackGet=function(){var t;return t=this.callOptionFunct("get"),this.revalidated(),t},n.prototype.invalidate=function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()),this},n.prototype.revalidate=function(){return n.__super__.revalidate.call(this),this.revalidateUpdater()},n.prototype.revalidateUpdater=function(){if(null!=this.getUpdater())return this.getUpdater().unbind()},n.prototype._invalidateNotice=function(){return this.isImmediate()?(this.get(),!1):("function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.invalidateEventName),null!=this.getUpdater()&&this.getUpdater().bind(),!0)},n.prototype.getUpdater=function(){return void 0===this.updater&&(null!=this.property.options.updater?(this.updater=this.property.options.updater,"function"==typeof this.updater.getBinder&&(this.updater=this.updater.getBinder()),"function"!=typeof this.updater.bind||"function"!=typeof this.updater.unbind?this.updater=null:this.updater.callback=this.revalidateCallback):this.updater=null),this.updater},n.prototype.isImmediate=function(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||("function"==typeof this.property.options.immediate?this.callOptionFunct("immediate"):null==this.getUpdater()&&(this.hasChangedEvents()||this.hasChangedFunctions())))},n.compose=function(t){if("function"!=typeof t.options.get&&"function"!=typeof t.options.calcul&&"function"!=typeof t.options.active||null==t.instanceType&&(t.instanceType=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e}()),"function"==typeof t.options.get)return t.instanceType.prototype.get=this.prototype.callbackGet},n}()},p.Spark.DynamicProperty=s(),p.Spark.DynamicProperty.definition=s,l=function(t){var i,n;return null==t&&(t={}),i=t.hasOwnProperty("Invalidator")?t.Invalidator:p.Spark.Invalidator,n=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:p.Spark.PropertyInstance,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.activableGet=function(){return this.get()},e.prototype.activableGet=function(){var t;return this.isActive()?(t=this.activeGet(),this.pendingChanges&&this.changed(this.pendingOld),t):void(this.initiated=!0)},e.prototype.isActive=function(){return!0},e.prototype.manualActive=function(){return this.active},e.prototype.callbackActive=function(){var n;return(this.activeInvalidator||new i(this,this.obj)).recycle((n=this,function(t,e){return n.active=n.callOptionFunct(n.activeFunct,t),e(),n.active||t.isEmpty()?(t.unbind(),n.activeInvalidator=null):(n.invalidator=t,(n.activeInvalidator=t).bind())})),this.active},e.prototype.activeChanged=function(t){return this.changed(t)},e.prototype.activableChanged=function(t){return this.isActive()?(this.pendingChanges=!1,this.pendingOld=void 0,this.activeChanged()):(this.pendingChanges=!0,void 0===this.pendingOld&&(this.pendingOld=t)),this},e.compose=function(t){if(void 0!==t.options.active){if(t.instanceType.prototype.activeGet=t.instanceType.prototype.get,t.instanceType.prototype.get=this.prototype.activableGet,t.instanceType.prototype.activeChanged=t.instanceType.prototype.changed,t.instanceType.prototype.changed=this.prototype.activableChanged,"boolean"==typeof t.options.active)return t.instanceType.prototype.active=t.options.active,t.instanceType.prototype.isActive=this.prototype.manualActive;if("function"==typeof t.options.active)return t.instanceType.prototype.activeFunct=t.options.active,t.instanceType.prototype.isActive=this.prototype.callbackActive}},e}()},p.Spark.ActivableProperty=l(),p.Spark.ActivableProperty.definition=l,u=function(t){var i,e;return null==t&&(t={}),e=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:p.Spark.DynamicProperty,i=t.hasOwnProperty("Collection")?t.Collection:p.Spark.Collection,function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return N(o,e),o.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest&&(t=this.callOptionFunct("ingest",t)),null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]},o.prototype.checkChangedItems=function(t,e){var n;return"function"==typeof this.collectionOptions.compare&&(n=this.collectionOptions.compare),new i(t).checkChanges(e,this.collectionOptions.ordered,n)},o.prototype.output=function(){var t,e,n;return n=this.value,"function"==typeof this.property.options.output&&(n=this.callOptionFunct("output",this.value)),e=this,(t=i.newSubClass(this.collectionOptions,n)).changed=function(t){return e.changed(t)},t},o.prototype.callChangedFunctions=function(n){var i,r;return"function"==typeof this.property.options.itemAdded&&this.value.forEach((i=this,function(t,e){if(!n.includes(t))return i.callOptionFunct("itemAdded",t,e)})),"function"==typeof this.property.options.itemRemoved&&n.forEach((r=this,function(t,e){if(!r.value.includes(t))return r.callOptionFunct("itemRemoved",t,e)})),o.__super__.callChangedFunctions.call(this,n)},o.prototype.hasChangedFunctions=function(){return o.__super__.hasChangedFunctions.call(this)||"function"==typeof this.property.options.itemAdded||"function"==typeof this.property.options.itemRemoved},o.defaultCollectionOptions={compare:!1,ordered:!0},o.compose=function(t){if(null!=t.options.collection&&(t.instanceType=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,o),e}(),t.instanceType.prototype.collectionOptions=Object.assign({},this.defaultCollectionOptions,"object"==typeof t.options.collection?t.options.collection:{}),null!=t.options.collection.compare))return t.instanceType.prototype.checkChanges=this.prototype.checkChangedItems},o}()},p.Spark.CollectionProperty=u(),p.Spark.CollectionProperty.definition=u,c=function(t){var n,i;return null==t&&(t={}),i=t.hasOwnProperty("Invalidator")?t.Invalidator:p.Spark.Invalidator,n=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:p.Spark.DynamicProperty,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.calculatedGet=function(){var t,e;return this.invalidator&&this.invalidator.validateUnknowns(),this.calculated||(e=this.value,t=this.initiated,this.calcul(),this.checkChanges(this.value,e)&&(t?this.changed(e):"function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.updateEventName,[e]))),this.output()},e.prototype.calcul=function(){return this.revalidated(),this.value},e.prototype.callbackCalcul=function(){return this.value=this.callOptionFunct(this.calculFunct),this.manual=!1,this.revalidated(),this.value},e.prototype.invalidatedCalcul=function(){var n;return this.invalidator||(this.invalidator=new i(this,this.obj)),this.invalidator.recycle((n=this,function(t,e){return n.value=n.callOptionFunct(n.calculFunct,t),n.manual=!1,e(),t.isEmpty()?n.invalidator=null:t.bind()})),this.revalidated(),this.value},e.prototype.unknown=function(){return(this.calculated||!1===this.active)&&this._invalidateNotice(),this},e.prototype.destroyWhithoutInvalidator=function(){return this.destroy()},e.prototype.destroyInvalidator=function(){if(this.destroyWhithoutInvalidator(),null!=this.invalidator)return this.invalidator.unbind()},e.prototype.invalidateInvalidator=function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()&&null!=this.invalidator&&this.invalidator.unbind()),this},e.compose=function(t){if("function"==typeof t.options.calcul)return t.instanceType.prototype.calculFunct=t.options.calcul,t.instanceType.prototype.get=this.prototype.calculatedGet,0<t.options.calcul.length?(t.instanceType.prototype.calcul=this.prototype.invalidatedCalcul,t.instanceType.prototype.destroyWhithoutInvalidator=t.instanceType.prototype.destroy,t.instanceType.prototype.destroy=this.prototype.destroyInvalidator,t.instanceType.prototype.invalidate=this.prototype.invalidateInvalidator,t.instanceType.prototype.unknown=this.prototype.unknown):t.instanceType.prototype.calcul=this.prototype.callbackCalcul},e}()},p.Spark.CalculatedProperty=c(),p.Spark.CalculatedProperty.definition=c,h=function(t){var i,n,e,r;return null==t&&(t={}),i=t.hasOwnProperty("CalculatedProperty")?t.CalculatedProperty:p.Spark.CalculatedProperty,r=t.hasOwnProperty("Invalidator")?t.Invalidator:p.Spark.Invalidator,n=t.hasOwnProperty("Collection")?t.Collection:p.Spark.Collection,(e=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return N(n,i),n.prototype.init=function(){return n.__super__.init.call(this),this.initComposed()},n.prototype.initComposed=function(){var e;return this.property.options.hasOwnProperty("default")?this.default=this.property.options.default:this.default=this.value=!0,this.members=new n.Members(this.property.options.members),this.members.changed=(e=this,function(t){return e.invalidate()}),this.join="function"==typeof this.property.options.composed?this.property.options.composed:!1===this.property.options.default?n.joinFunctions.or:n.joinFunctions.and},n.prototype.calcul=function(){var i;return this.invalidator||(this.invalidator=new r(this,this.obj)),this.invalidator.recycle((i=this,function(t,e){return i.value=i.members.reduce(function(t,e){var n;return n="function"==typeof e?e(i.invalidator):e,i.join(t,n)},i.default),e(),t.isEmpty()?i.invalidator=null:t.bind()})),this.revalidated(),this.value},n.compose=function(t){if(null!=t.options.composed)return t.instanceType=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e}(),t.instanceType.prototype.get=this.prototype.calculatedGet},n.bind=function(t,e){return i.bind(t,e),Object.defineProperty(t,e.name+"Members",{configurable:!0,get:function(){return e.getInstance(this).members}})},n.joinFunctions={and:function(t,e){return t&&e},or:function(t,e){return t||e}},n}()).Members=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.addPropertyRef=function(e,n){var t;if(-1===this.findRefIndex(e,n))return(t=function(t){return t.prop(e,n)}).ref={name:e,obj:n},this.push(t)},e.prototype.addValueRef=function(e,t,n){var i;if(-1===this.findRefIndex(t,n))return(i=function(t){return e}).ref={name:t,obj:n,val:e},this.push(i)},e.prototype.setValueRef=function(e,t,n){var i,r;return-1===(r=this.findRefIndex(t,n))?this.addValueRef(e,t,n):this.get(r).ref.val!==e?((i=function(t){return e}).ref={name:t,obj:n,val:e},this.set(r,i)):void 0},e.prototype.getValueRef=function(t,e){return this.findByRef(t,e).ref.val},e.prototype.addFunctionRef=function(t,e,n){if(-1===this.findRefIndex(e,n))return t.ref={name:e,obj:n},this.push(t)},e.prototype.findByRef=function(t,e){return this._array[this.findRefIndex(t,e)]},e.prototype.findRefIndex=function(e,n){return this._array.findIndex(function(t){return null!=t.ref&&t.ref.obj===n&&t.ref.name===e})},e.prototype.removeRef=function(t,e){var n,i;if(-1!==(n=this.findRefIndex(t,e)))return i=this.toArray(),this._array.splice(n,1),this.changed(i)},e}(),e},p.Spark.ComposedProperty=h(),p.Spark.ComposedProperty.definition=h,d=function(t){var e,n,i,r,a,s;return null==t&&(t={}),s=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:p.Spark.PropertyInstance,i=t.hasOwnProperty("CollectionProperty")?t.CollectionProperty:p.Spark.CollectionProperty,r=t.hasOwnProperty("ComposedProperty")?t.ComposedProperty:p.Spark.ComposedProperty,a=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:p.Spark.DynamicProperty,n=t.hasOwnProperty("CalculatedProperty")?t.CalculatedProperty:p.Spark.CalculatedProperty,e=t.hasOwnProperty("ActivableProperty")?t.ActivableProperty:p.Spark.ActivableProperty,function(){function o(t,e){this.name=t,this.options=null!=e?e:{}}return o.prototype.composers=[r,i,a,s,n,e],o.prototype.bind=function(t){var e;return this,"function"==typeof t.getProperty&&t.getProperty(this.name)===this||("function"==typeof t.getProperty&&null!=(e=t.getProperty(this.name))&&this.override(e),this.getInstanceType().bind(t,this),t._properties=(t._properties||[]).concat([this]),null!=e&&(t._properties=t._properties.filter(function(t){return t!==e})),this.checkFunctions(t),this.checkAfterAddListener(t)),this},o.prototype.override=function(t){var e,n,i,r;if(null==this.options.parent){for(e in this.options.parent=t.options,i=[],n=t.options)r=n[e],"function"==typeof this.options[e]&&"function"==typeof r?i.push(this.options[e].overrided=r):void 0===this.options[e]?i.push(this.options[e]=r):i.push(void 0);return i}},o.prototype.checkFunctions=function(t){var e,n,i,r;for(n in this.checkAfterAddListener(t),r=[],i=o.fn)e=i[n],void 0===t[n]?r.push(t[n]=e):r.push(void 0);return r},o.prototype.checkAfterAddListener=function(t){var e;if("function"==typeof t.addListener&&void 0===t.afterAddListener&&void 0===t.addListener.overrided)return t.afterAddListener=o.optionalFn.afterAddListener,e=t.addListener,t.addListener=function(t,e){return this.addListener.overrided.call(this,t,e),this.afterAddListener(t)},t.addListener.overrided=e},o.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},o.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},o.prototype.getInstance=function(t){var e,n;return n=this.getInstanceVarName(),this.isInstantiated(t)||(e=this.getInstanceType(),t[n]=new e(this,t)),t[n]},o.prototype.getInstanceType=function(){var e;return this.instanceType||this.composers.forEach((e=this,function(t){return t.compose(e)})),this.instanceType},o.fn={getProperty:function(e){return this._properties&&this._properties.find(function(t){return t.name===e})},getPropertyInstance:function(t){var e;if(e=this.getProperty(t))return e.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map((e=this,function(t){return t.getInstance(e)}));var e},getInstantiatedProperties:function(){return this._properties.filter((n=this,function(t){return t.isInstantiated(n)})).map((e=this,function(t){return t.getInstance(e)}));var e,n},getManualDataProperties:function(){return this._properties.reduce((i=this,function(t,e){var n;return e.isInstantiated(i)&&(n=e.getInstance(i)).calculated&&n.manual&&(t[e.name]=n.value),t}),{});var i},setProperties:function(t,e){var n,i,r;for(n in null==e&&(e={}),t)r=t[n],null!=e.whitelist&&-1===e.whitelist.indexOf(n)||null!=e.blacklist&&-1!==e.blacklist.indexOf(n)||null!=(i=this.getPropertyInstance(n))&&i.set(r);return this},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return t.destroy()}),this._properties=[],!0}},o.optionalFn={afterAddListener:function(e){return this._properties.forEach((n=this,function(t){if(t.getInstanceType().prototype.changeEventName===e)return t.getInstance(n).get()}));var n}},o}()},p.Spark.Property=d(),p.Spark.Property.definition=d,f=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Property")?t.Property:p.Spark.Property,function(){function r(){}return r.elementKeywords=["extended","included","__super__","constructor"],r.prototype.tap=function(t){var e;return e=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,e.slice(1)):this[t].apply(this,e.slice(1)),this},r.prototype.callback=function(e){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[e]?this._callbacks[e]:this._callbacks[e]=(n=this,function(){var t;return t=1<=arguments.length?U.call(arguments,0):[],n[e].apply(n,t),null});var n},r.extend=function(t){var e,n,i;for(e in t)i=t[e],W.call(r.elementKeywords,e)<0&&(this[e]=i);return null!=t.prototype&&this.include(t.prototype),null!=(n=t.extended)&&n.apply(this),this},r.getIncludableProperties=function(t){var n,i;for(n=r.elementKeywords,null!=t._properties&&(n=n.concat(t._properties.map(function(t){return t.name}))).push("_properties"),i=[];i=i.concat(Object.getOwnPropertyNames(t).filter(function(e){return function(t){return!e.prototype.hasOwnProperty(t)&&"__"!==t.substr(0,2)&&W.call(n,t)<0&&W.call(i,t)<0}}(this))),(t=Object.getPrototypeOf(t))&&t!==Object&&t!==r.prototype;);return i},r.include=function(t){var e,n,i,r,o,a,s,l,u;for(e=0,r=(s=this.getIncludableProperties(t)).length;e<r;e++)n=s[e],this.prototype[n]=t[n];if(null!=t._properties)for(i=0,o=(l=t._properties).length;i<o;i++)a=l[i],this.property(a.name,Object.assign({},a.options));return null!=(u=t.included)&&u.apply(this),this},r.property=function(t,e){return new n(t,e).bind(this.prototype)},r.properties=function(t){var e,n,i;for(n in i=[],t)e=t[n],i.push(this.property(n,e));return i},r}()},p.Spark.Element=f(),p.Spark.Element.definition=f,y=function(t){var e,n;return null==t&&(t={}),e=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,(n=function(t){function s(t,e,n,i){this.tilesContainer=t,this.from=e,this.to=n,null==i&&(i={}),this.reset(),null!=i.validTile&&(this.validTileCallback=i.validTile)}return N(s,e),s.properties({validTileCallback:{}}),s.prototype.reset=function(){return this.queue=[],this.paths={},this.solution=null,this.started=!1},s.prototype.calcul=function(){for(;!this.solution&&(!this.started||this.queue.length);)this.step();return this.getPath()},s.prototype.step=function(){var t;return this.queue.length?(t=this.queue.pop(),this.addNextSteps(t),!0):this.started?void 0:(this.started=!0,this.addNextSteps(),!0)},s.prototype.getPath=function(){var t,e;if(this.solution){for(t=[this.solution],e=this.solution;null!=e.prev;)t.unshift(e.prev),e=e.prev;return t}},s.prototype.getPosAtPrc=function(t){if(isNaN(t))throw new Error("Invalid number");if(this.solution)return this.getPosAtTime(this.solution.getTotalLength()*t)},s.prototype.getPosAtTime=function(t){var e,n;if(this.solution){if(t>=this.solution.getTotalLength())return this.solution.posToTileOffset(this.solution.getExit().x,this.solution.getExit().y);for(n=this.solution;n.getStartLength()>t&&null!=n.prev;)n=n.prev;return e=(t-n.getStartLength())/n.getLength(),n.posToTileOffset(n.getEntry().x+(n.getExit().x-n.getEntry().x)*e,n.getEntry().y+(n.getExit().y-n.getEntry().y)*e)}},s.prototype.tileIsValid=function(t){return null!=this.validTileCallback?this.validTileCallback(t):!t.emulated||0!==t.tile&&!1!==t.tile},s.prototype.getTile=function(t,e){var n;return null!=this.tilesContainer.getTile?this.tilesContainer.getTile(t,e):null!=(null!=(n=this.tilesContainer[e])?n[t]:void 0)?{x:t,y:e,tile:this.tilesContainer[e][t],emulated:!0}:void 0},s.prototype.getConnectedToTile=function(t){var e,n;return null!=t.getConnected?t.getConnected():(e=[],(n=this.getTile(t.x+1,t.y))&&e.push(n),(n=this.getTile(t.x-1,t.y))&&e.push(n),(n=this.getTile(t.x,t.y+1))&&e.push(n),(n=this.getTile(t.x,t.y-1))&&e.push(n),e)},s.prototype.addNextSteps=function(t){var e,n,i,r,o,a;for(null==t&&(t=null),a=null!=t?t.nextTile:this.from,o=[],e=0,n=(r=this.getConnectedToTile(a)).length;e<n;e++)i=r[e],this.tileIsValid(i)?o.push(this.addStep(new s.Step(this,null!=t?t:null,a,i))):o.push(void 0);return o},s.prototype.tileEqual=function(t,e){return t===e||(t.emulated||e.emulated)&&t.x===e.x&&t.y===e.y},s.prototype.addStep=function(t){if(null==this.paths[t.getExit().x]&&(this.paths[t.getExit().x]={}),!(null!=this.paths[t.getExit().x][t.getExit().y]&&this.paths[t.getExit().x][t.getExit().y].getTotalLength()<=t.getTotalLength())&&(null!=this.paths[t.getExit().x][t.getExit().y]&&this.removeStep(this.paths[t.getExit().x][t.getExit().y]),this.paths[t.getExit().x][t.getExit().y]=t,this.queue.splice(this.getStepRank(t),0,t),this.tileEqual(t.nextTile,this.to)&&!(null!=this.solution&&this.solution.prev.getTotalLength()<=t.getTotalLength())))return this.solution=new s.Step(this,t,t.nextTile,null)},s.prototype.removeStep=function(t){var e;if(-1<(e=this.queue.indexOf(t)))return this.queue.splice(e,1)},s.prototype.best=function(){return this.queue[this.queue.length-1]},s.prototype.getStepRank=function(t){return 0===this.queue.length?0:this._getStepRank(t.getEfficiency(),0,this.queue.length-1)},s.prototype._getStepRank=function(t,e,n){var i,r;return r=Math.floor((n-e)/2)+e,(i=this.queue[r].getEfficiency())===t?r:t<i?r===e?e:this._getStepRank(t,e,r-1):r===n?n+1:this._getStepRank(t,r+1,n)},s}()).Step=function(){function t(t,e,n,i){this.pathFinder=t,this.prev=e,this.tile=n,this.nextTile=i}return t.prototype.posToTileOffset=function(t,e){var n;return{x:t,y:e,tile:n=Math.floor(t)===this.tile.x&&Math.floor(e)===this.tile.y?this.tile:null!=this.nextTile&&Math.floor(t)===this.nextTile.x&&Math.floor(e)===this.nextTile.y?this.nextTile:null!=this.prev&&Math.floor(t)===this.prev.tile.x&&Math.floor(e)===this.prev.tile.y?this.prev.tile:console.log("Math.floor("+t+") == "+this.tile.x,"Math.floor("+e+") == "+this.tile.y,this),offsetX:t-n.x,offsetY:e-n.y}},t.prototype.getExit=function(){return null==this.exit&&(null!=this.nextTile?this.exit={x:(this.tile.x+this.nextTile.x+1)/2,y:(this.tile.y+this.nextTile.y+1)/2}:this.exit={x:this.tile.x+.5,y:this.tile.y+.5}),this.exit},t.prototype.getEntry=function(){return null==this.entry&&(null!=this.prev?this.entry={x:(this.tile.x+this.prev.tile.x+1)/2,y:(this.tile.y+this.prev.tile.y+1)/2}:this.entry={x:this.tile.x+.5,y:this.tile.y+.5}),this.entry},t.prototype.getLength=function(){return null==this.length&&(this.length=null==this.nextTile||null==this.prev?.5:this.prev.tile.x===this.nextTile.x||this.prev.tile.y===this.nextTile.y?1:Math.sqrt(.5)),this.length},t.prototype.getStartLength=function(){return null==this.startLength&&(this.startLength=null!=this.prev?this.prev.getTotalLength():0),this.startLength},t.prototype.getTotalLength=function(){return null==this.totalLength&&(this.totalLength=this.getStartLength()+this.getLength()),this.totalLength},t.prototype.getEfficiency=function(){return null==this.efficiency&&(this.efficiency=1.1*-this.getRemaining()-this.getTotalLength()),this.efficiency},t.prototype.getRemaining=function(){var t,e,n,i;return null==this.remaining&&(t=this.getExit(),n=(e={x:this.pathFinder.to.x+.5,y:this.pathFinder.to.y+.5}).x-t.x,i=e.y-t.y,this.remaining=Math.sqrt(n*n+i*i)),this.remaining},t}(),n},p.PathFinder=y(),p.PathFinder.definition=y,g=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({tile:{change:function(t){if(null!=t&&t.removeChild(this),this.tile)return this.tile.addChild(this)}},offsetX:{default:0},offsetY:{default:0}}),e}()},p.Tiled=g(),p.Tiled.definition=g,v=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Tiled")?t.Tiled:p.Tiled,function(t){function e(t){this.direction=null!=t?t:e.directions.horizontal,e.__super__.constructor.call(this)}return N(e,n),e.properties({tile:{change:function(t,e){return e(),this.updateTileMembers(t)}},open:{default:!1},direction:{}}),e.prototype.updateTileMembers=function(t){var e,n,i,r;if(null!=t&&(null!=(e=t.walkableMembers)&&e.removeRef("open",this),null!=(n=t.transparentMembers)&&n.removeRef("open",this)),this.tile)return null!=(i=this.tile.walkableMembers)&&i.addPropertyRef("open",this),null!=(r=this.tile.transparentMembers)?r.addPropertyRef("open",this):void 0},e.directions={horizontal:"horizontal",vertical:"vertical"},e}()},p.Door=v(),p.Door.definition=v,m=function(t){var e,n;return null==t&&(t={}),e=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,n=t.hasOwnProperty("Timing")?t.Timing:p.Timing,function(t){function i(t,e,n){this.walker=t,this.path=e,this.setProperties(n),i.__super__.constructor.call(this)}return N(i,e),i.properties({speed:{default:5},timing:{calcul:function(){return new n}},pathLength:{calcul:function(){return this.path.solution.getTotalLength()}},totalTime:{calcul:function(){return this.pathLength/this.speed*1e3}}}),i.prototype.start=function(){if(this.path.solution||this.path.calcul(),this.path.solution)return this.pathTimeout=this.timing.setTimeout((t=this,function(){return t.end()}),this.totalTime),this.pathTimeout.updater.addCallback(this.callback("update"));var t},i.prototype.stop=function(){return this.pathTimeout.pause()},i.prototype.update=function(){var t;return t=this.path.getPosAtPrc(this.pathTimeout.getPrc()),this.walker.tile=t.tile,this.walker.offsetX=t.offsetX,this.walker.offsetY=t.offsetY},i.prototype.end=function(){return this.update(),this.destroy()},i.prototype.destroy=function(){return this.pathTimeout.destroy(),this.destroyProperties()},i}()},p.PathWalk=m(),p.PathWalk.definition=m,b=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({damageable:{default:!0},maxHealth:{default:1e3},health:{default:1e3,change:function(){if(0===this.health)return this.whenNoHealth()}}}),e.prototype.damage=function(t){return this.health=Math.max(0,this.health-t)},e.prototype.whenNoHealth=function(){},e}()},p.Damageable=b(),p.Damageable.definition=b,T=function(t){var n,i,r,o;return null==t&&(t={}),o=t.hasOwnProperty("Tiled")?t.Tiled:p.Tiled,i=t.hasOwnProperty("PathFinder")?t.PathFinder:p.PathFinder,r=t.hasOwnProperty("PathWalk")?t.PathWalk:p.PathWalk,n=t.hasOwnProperty("Damageable")?t.Damageable:p.Damageable,function(t){function e(t){this.name=t,e.__super__.constructor.call(this)}return N(e,o),e.extend(n),e.prototype.walkTo=function(t){var e;return null!=this.walk&&this.walk.end(),e=new i(this.tile.container,this.tile,t,{validTile:function(t){return t.walkable}}),this.walk=new r(this,e),this.walk.start()},e}()},p.Character=T(),p.Character.definition=T,w=function(t){var n,i;return null==t&&(t={}),i=t.hasOwnProperty("Door")?t.Door:p.Door,n=t.hasOwnProperty("Character")?t.Character:p.Character,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,i),e.properties({open:{calcul:function(t){return!t.prop("locked")&&this.isActivatorPresent(t)}},locked:{default:!1},unlocked:{calcul:function(t){return!t.prop("locked")}}}),e.prototype.updateTileMembers=function(t){var e,n,i,r;if(null!=t&&(null!=(e=t.walkableMembers)&&e.removeRef("unlocked",this),null!=(n=t.transparentMembers)&&n.removeRef("open",this)),this.tile)return null!=(i=this.tile.walkableMembers)&&i.addPropertyRef("unlocked",this),null!=(r=this.tile.transparentMembers)?r.addPropertyRef("open",this):void 0},e.prototype.init=function(){return e.__super__.init.call(this),this.open},e.prototype.isActivatorPresent=function(e){return this.getReactiveTiles().some((n=this,function(t){return(e?e.prop("children",t):t.children).some(function(t){return n.canBeActivatedBy(t)})}));var n},e.prototype.canBeActivatedBy=function(t){return t instanceof n},e.prototype.getReactiveTiles=function(){return this.direction===i.directions.horizontal?[this.tile,this.tile.getRelativeTile(0,1),this.tile.getRelativeTile(0,-1)].filter(function(t){return null!=t}):[this.tile,this.tile.getRelativeTile(1,0),this.tile.getRelativeTile(-1,0)].filter(function(t){return null!=t})},e}()},p.AutomaticDoor=w(),p.AutomaticDoor.definition=w,k=function(){var t;return(t=function(){function t(t,e,n,i){this.name=t,this.x=e,this.y=n,this.inverseName=i}return t.prototype.getInverse=function(){return this.constructor[this.inverseName]},t}()).up=new t("up",0,-1,"down"),t.down=new t("down",0,1,"up"),t.left=new t("left",-1,0,"right"),t.right=new t("right",1,0,"left"),t.adjacents=[t.up,t.down,t.left,t.right],t.topLeft=new t("topLeft",-1,-1,"bottomRight"),t.topRight=new t("topRight",1,-1,"bottomLeft"),t.bottomRight=new t("bottomRight",1,1,"topLeft"),t.bottomLeft=new t("bottomLeft",-1,1,"topRight"),t.corners=[t.topLeft,t.topRight,t.bottomRight,t.bottomLeft],t.all=[t.up,t.down,t.left,t.right,t.topLeft,t.topRight,t.bottomRight,t.bottomLeft],t},p.Direction=k(),p.Direction.definition=k,_=function(){return function(){function t(t,e,n,i,r){this.tiles=t,this.x1=null!=e?e:0,this.y1=null!=n?n:0,this.x2=null!=i?i:0,this.y2=null!=r?r:0}return t.prototype.setX1=function(t){return this.x1=t,this.invalidade()},t.prototype.setY1=function(t){return this.y1=t,this.invalidade()},t.prototype.setX2=function(t){return this.x2=t,this.invalidade()},t.prototype.setY2=function(t){return this.y2=t,this.invalidade()},t.prototype.invalidade=function(){return this.endPoint=null,this.success=null,this.calculated=!1},t.prototype.testTile=function(t,e,n){return null!=this.traversableCallback?this.traversableCallback(t,e,n):null!=t&&("function"==typeof t.getTransparent?t.getTransparent():void 0===typeof t.transparent||t.transparent)},t.prototype.testTileAt=function(t,e,n,i){return this.testTile(this.tiles.getTile(Math.floor(t),Math.floor(e)),n,i)},t.prototype.calcul=function(){var t,e,n,i,r,o,a,s,l,u;for(r=(this.x2-this.x1)/(this.y2-this.y1),s=Math.abs(this.x2-this.x1)+Math.abs(this.y2-this.y1),n=0<=this.x2-this.x1,i=0<=this.y2-this.y1,o=l=this.x1,a=u=this.y1;s>Math.abs(l-this.x1)+Math.abs(u-this.y1)&&this.testTileAt(o,a,l,u);)t=n?Math.floor(l)+1:Math.ceil(l)-1,e=i?Math.floor(u)+1:Math.ceil(u)-1,this.x2-this.x1==0?u=e:this.y2-this.y1==0?l=t:Math.abs((t-l)/(this.x2-this.x1))<Math.abs((e-u)/(this.y2-this.y1))?u=((l=t)-this.x1)/r+this.y1:(l=(e-this.y1)*r+this.x1,u=e),o=n?l:Math.ceil(l)-1,a=i?u:Math.ceil(u)-1;return s<=Math.abs(l-this.x1)+Math.abs(u-this.y1)?(this.endPoint={x:this.x2,y:this.y2,tile:this.tiles.getTile(Math.floor(this.x2),Math.floor(this.y2))},this.success=!0):(this.endPoint={x:l,y:u,tile:this.tiles.getTile(Math.floor(o),Math.floor(a))},this.success=!1)},t.prototype.getSuccess=function(){return this.calculated||this.calcul(),this.success},t.prototype.getEndPoint=function(){return this.calculated||this.calcul(),this.endPoint},t}()},p.LineOfSight=_(),p.LineOfSight.definition=_,x=function(t){var n,v,i,s;return null==t&&(t={}),i=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,s=t.hasOwnProperty("LineOfSight")?t.LineOfSight:p.LineOfSight,v=t.hasOwnProperty("Direction")?t.Direction:p.Direction,(n=function(t){function e(t){this.setProperties(t)}return N(e,i),e.properties({tile:{default:null},power:{default:10},range:{default:1},type:{default:null}}),e.prototype.getTileContainer=function(){return this.tile.container},e.prototype.apply=function(){var t,e,n,i,r;for(r=[],e=0,n=(i=this.getDamaged()).length;e<n;e++)t=i[e],r.push(t.target.damage(t.damage));return r},e.prototype.getInitialTiles=function(){return this.getTileContainer().inRange(this.tile,this.range)},e.prototype.getInitialDamages=function(){var t,e,n,i,r,o;for(t=[],n=0,i=(o=this.getInitialTiles()).length;n<i;n++)(r=o[n]).damageable&&(e=this.initialDamage(r,o.length))&&t.push(e);return t},e.prototype.getDamaged=function(){var t;if(null==this._damaged)for(t=null;t=this.step(t););return this._damaged},e.prototype.step=function(t){return null==t?this._damaged=this.getInitialDamages():null!=this.extendedDamage?(t=this.extend(t),this._damaged=t.concat(this._damaged),0<t.length&&t):void 0},e.prototype.inDamaged=function(t,e){var n,i,r;for(n=i=0,r=e.length;i<r;n=++i)if(e[n].target===t)return n;return!1},e.prototype.extend=function(t){var e,n,i,r,o,a,s,l,u,p,c,h,d,f,y,g;for(n=this.getTileContainer(),e=[],s=0,u=t.length;s<u;s++){if(h=[],null!=(i=t[s]).target.x)for(l=0,p=(f=v.adjacents).length;l<p;l++)r=f[l],null!=(g=n.getTile(i.target.x+r.x,i.target.y+r.y))&&g.damageable&&!1===this.inDamaged(g,this._damaged)&&h.push(g);for(d=0,c=h.length;d<c;d++)y=h[d],(o=this.extendedDamage(y,i,h.length))&&(!1===(a=this.inDamaged(y,e))?e.push(o):e[a]=this.mergeDamage(e[a],o))}return e},e.prototype.mergeDamage=function(t,e){return{target:t.target,power:t.power+e.power,damage:t.damage+e.damage}},e.prototype.modifyDamage=function(t,e){return"function"==typeof t.modifyDamage?Math.floor(t.modifyDamage(e,this.type)):Math.floor(e)},e}()).Normal=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.initialDamage=function(t,e){var n;if(0<(n=this.modifyDamage(t,this.power)))return{target:t,power:this.power,damage:n}},e}(),n.Thermic=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.extendedDamage=function(t,e,n){var i,r;if(r=(e.damage-1)/2/n*Math.min(1,e.target.health/e.target.maxHealth*5),0<(i=this.modifyDamage(t,r)))return{target:t,power:r,damage:i}},e.prototype.initialDamage=function(t,e){var n,i;if(i=this.power/e,0<(n=this.modifyDamage(t,i)))return{target:t,power:i,damage:n}},e}(),n.Kinetic=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.prototype.extendedDamage=function(t,e,n){var i,r;if(r=(e.power-e.damage)*Math.min(1,e.target.health/e.target.maxHealth*2)-1,0<(i=this.modifyDamage(t,r)))return{target:t,power:r,damage:i}},e.prototype.initialDamage=function(t,e){var n;if(0<(n=this.modifyDamage(t,this.power)))return{target:t,power:this.power,damage:n}},e.prototype.modifyDamage=function(t,e){return"function"==typeof t.modifyDamage?Math.floor(t.modifyDamage(e,this.type)):Math.floor(.25*e)},e.prototype.mergeDamage=function(t,e){return{target:t.target,power:Math.floor((t.power+e.power)/2),damage:Math.floor((t.damage+e.damage)/2)}},e}(),n.Explosive=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({rng:{default:Math.random},traversableCallback:{default:function(t){return!("function"==typeof t.getSolid&&t.getSolid())}}}),e.prototype.getDamaged=function(){var t,e,n,i,r,o,a;for(this._damaged=[],o=Math.pow(this.range+1,2),r=this.power/o,(e=this.tile.health<=this.modifyDamage(this.tile,r))&&(r*=4),n=0,i=o;0<=i?n<=i:i<=n;0<=i?++n:--n)t=this.rng()*Math.PI*2,null!=(a=this.getTileHitByShard(e,t))&&this._damaged.push({target:a,power:r,damage:this.modifyDamage(a,r)});return this._damaged},e.prototype.getTileHitByShard=function(e,t){var n,i,r,o,a;return n=this.getTileContainer(),i=this.range*this.rng(),r={x:this.tile.x+.5+i*Math.cos(t),y:this.tile.y+.5+i*Math.sin(t)},e?((o=new s(n,this.tile.x+.5,this.tile.y+.5,r.x,r.y)).traversableCallback=(a=this,function(t){return!e||null!=t&&a.traversableCallback(t)}),o.getEndPoint().tile):n.getTile(Math.floor(r.x),Math.floor(r.y))},e}(),n},p.DamagePropagation=x(),p.DamagePropagation.definition=x,P=function(t){return null==t&&(t={}),t.hasOwnProperty("Element")?t.Element:p.Spark.Element},p.Element=P(),p.Element.definition=P,C=function(t){var i,n;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,i=t.hasOwnProperty("Direction")?t.Direction:p.Direction,function(t){function e(t,e){this.x=t,this.y=e,this.init()}return N(e,n),e.prototype.init=function(){return null},e.properties({children:{collection:!0},container:{change:function(){return this.adjacentTiles.forEach(function(t){return t.invalidateAdjacentTiles()})}},adjacentTiles:{calcul:function(t){if(null!=this.container)return i.adjacents.map((e=this,function(t){return e.getRelativeTile(t.x,t.y)})).filter(function(t){return null!=t});var e},collection:!0}}),e.prototype.getRelativeTile=function(t,e){if(null!=this.container)return this.container.getTile(this.x+t,this.y+e)},e.prototype.findDirectionOf=function(e){if(e.tile&&(e=e.tile),null!=e.x&&null!=e.y)return i.all.find((n=this,function(t){return t.x===e.x-n.x&&t.y===e.y-n.y}));var n},e.prototype.addChild=function(t,e){return null==e&&(e=!0),-1===this.children.indexOf(t)&&this.children.push(t),e&&(t.tile=this),t},e.prototype.removeChild=function(t,e){var n;if(null==e&&(e=!0),-1<(n=this.children.indexOf(t))&&this.children.splice(n,1),e&&t.tile===this)return t.tile=null},e.prototype.dist=function(t){var e,n,i,r;return null==(null!=t?t.x:void 0)||null==t.y||null==this.x||null==this.y||this.container!==t.container&&!(e=null!=(n=this.container)&&"function"==typeof n.dist?n.dist(t.container):void 0)?null:(i=t.x-this.x,r=t.y-this.y,e&&(i+=e.x,r+=e.y),{x:i,y:r,length:Math.sqrt(i*i+r*r)})},e}()},p.Tile=C(),p.Tile.definition=C,S=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Tile")?t.Tile:p.Tile,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({walkable:{composed:!0},transparent:{composed:!0}}),e}()},p.Floor=S(),p.Floor.definition=S,O=function(t){var n,i;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,i=t.hasOwnProperty("Timing")?t.Timing:p.Timing,function(t){function e(t){this.setProperties(t),this.init()}return N(e,n),e.prototype.init=function(){},e.properties({origin:{default:null},target:{default:null},power:{default:10},blastRange:{default:1},propagationType:{default:null},speed:{default:10},pathLength:{calcul:function(){var t;return null!=this.originTile&&null!=this.targetTile&&(t=this.originTile.dist(this.targetTile))?t.length:100}},originTile:{calcul:function(t){var e;if(null!=(e=t.prop("origin")))return e.tile||e}},targetTile:{calcul:function(t){var e;if(null!=(e=t.prop("target")))return e.tile||e}},container:{calcul:function(t){var e,n;return e=t.prop("originTile"),n=t.prop("targetTile"),e.container===n.container?e.container:.5<t.prop("prcPath")?n.container:e.container}},x:{calcul:function(t){var e;return e=t.prop("startPos"),(t.prop("targetPos").x-e.x)*t.prop("prcPath")+e.x}},y:{calcul:function(t){var e;return e=t.prop("startPos"),(t.prop("targetPos").y-e.y)*t.prop("prcPath")+e.y}},startPos:{calcul:function(t){var e,n,i,r;return r=t.prop("originTile"),e=t.prop("container"),i=this.startOffset,r.container!==e&&(n=e.dist(r.container),i.x+=n.x,i.y+=n.y),{x:r.x+i.x,y:r.y+i.y}},output:function(t){return Object.assign({},t)}},targetPos:{calcul:function(t){var e,n,i,r;return r=t.prop("targetTile"),e=t.prop("container"),i=this.targetOffset,r.container!==e&&(n=e.dist(r.container),i.x+=n.x,i.y+=n.y),{x:r.x+i.x,y:r.y+i.y}},output:function(t){return Object.assign({},t)}},startOffset:{default:{x:.5,y:.5},output:function(t){return Object.assign({},t)}},targetOffset:{default:{x:.5,y:.5},output:function(t){return Object.assign({},t)}},prcPath:{calcul:function(){var t;return(null!=(t=this.pathTimeout)?t.getPrc():void 0)||0}},timing:{calcul:function(){return new i}},moving:{default:!1}}),e.prototype.launch=function(){return this.moving=!0,this.pathTimeout=this.timing.setTimeout((t=this,function(){return t.deliverPayload(),t.moving=!1}),this.pathLength/this.speed*1e3);var t},e.prototype.deliverPayload=function(){var t;return(t=new this.propagationType({tile:this.target.tile||this.target,power:this.power,range:this.blastRange})).apply(),this.payloadDelivered(),t},e.prototype.payloadDelivered=function(){return this.destroy()},e.prototype.destroy=function(){return this.destroyProperties()},e}()},p.Projectile=O(),p.Projectile.definition=O,E=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,function(t){function e(){this.init()}return N(e,n),e.properties({boundaries:{calcul:function(){var e,n;return e={top:null,left:null,bottom:null,right:null},this.tiles.forEach((n=this,function(t){return n._addToBondaries(t,e)})),e},output:function(t){return Object.assign({},t)}}}),e.prototype._addToBondaries=function(t,e){if((null==e.top||t.y<e.top)&&(e.top=t.y),(null==e.left||t.x<e.left)&&(e.left=t.x),(null==e.bottom||t.y>e.bottom)&&(e.bottom=t.y),null==e.right||t.x>e.right)return e.right=t.x},e.prototype.init=function(){return this.coords={},this.tiles=[]},e.prototype.addTile=function(t){var e;return this.tiles.includes(t)||(this.tiles.push(t),null==this.coords[t.x]&&(this.coords[t.x]={}),(null!=(e=((this.coords[t.x][t.y]=t).container=this)._boundaries)?e.calculated:void 0)&&this._addToBondaries(t,this._boundaries.value)),this},e.prototype.removeTile=function(t){var e,n;if(-1<(e=this.tiles.indexOf(t))&&(this.tiles.splice(e,1),delete this.coords[t.x][t.y],((t.container=null)!=(n=this._boundaries)?n.calculated:void 0)&&(this.boundaries.top===t.y||this.boundaries.bottom===t.y||this.boundaries.left===t.x||this.boundaries.right===t.x)))return this.invalidateBoundaries()},e.prototype.removeTileAt=function(t,e){var n;if(n=this.getTile(t,e))return this.removeTile(n)},e.prototype.getTile=function(t,e){var n;if(null!=(null!=(n=this.coords[t])?n[e]:void 0))return this.coords[t][e]},e.prototype.loadMatrix=function(t){var e,n,i,r,o;for(o in t)for(r in n=t[o])i=n[r],e={x:parseInt(r),y:parseInt(o)},"function"==typeof i?this.addTile(i(e)):(i.x=e.x,i.y=e.y,this.addTile(i));return this},e.prototype.inRange=function(t,e){var n,i,r,o,a,s,l,u,p,c;for(u=[],e--,p=i=o=t.x-e,a=t.x+e;o<=a?i<=a:a<=i;p=o<=a?++i:--i)for(c=r=s=t.y-e,l=t.y+e;s<=l?r<=l:l<=r;c=s<=l?++r:--r)Math.sqrt((p-t.x)*(p-t.x)+(c-t.y)*(c-t.y))<=e&&null!=(n=this.getTile(p,c))&&u.push(n);return u},e.prototype.allTiles=function(){return this.tiles.slice()},e.prototype.clearAll=function(){var t,e,n;for(t=0,e=(n=this.tiles).length;t<e;t++)n[t].container=null;return this.coords={},this.tiles=[],this},e}()},p.TileContainer=E(),p.TileContainer.definition=E,D=function(t){var s,n,e,l,u;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,u=t.hasOwnProperty("TileContainer")?t.TileContainer:p.TileContainer,l=t.hasOwnProperty("Tile")?t.Tile:p.Tile,s=t.hasOwnProperty("Door")?t.Door:p.Door,(e=function(t){function e(t){this.setProperties(t),this.directions=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],this.corners=[{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}],this.allDirections=this.directions.concat(this.corners)}return N(e,n),e.properties({rng:{default:Math.random},maxVolume:{default:25},minVolume:{default:50},width:{default:30},height:{default:15},tiles:{calcul:function(){var t,e,n,i,r,o,a;for(r=new u,o=t=0,n=this.width;0<=n?t<=n:n<=t;o=0<=n?++t:--t)for(a=e=0,i=this.height;0<=i?e<=i:i<=e;a=0<=i?++e:--e)r.addTile(new l(o,a));return r}},floorFactory:{default:function(t){return new l(t.x,t.y)}},wallFactory:{default:null},doorFactory:{calcul:function(){return this.floorFactory}}}),e.prototype.init=function(){return this.finalTiles=null,this.rooms=[],this.free=this.tiles.allTiles().filter((o=this,function(t){var e,n,i,r;for(n=0,i=(r=o.allDirections).length;n<i;n++)if(e=r[n],null==o.tiles.getTile(t.x+e.x,t.y+e.y))return!1;return!0}));var o},e.prototype.calcul=function(){for(this.init(),0;this.step()||this.newRoom();)0;return this.createDoors(),this.rooms,this.makeFinalTiles()},e.prototype.makeFinalTiles=function(){return this.finalTiles=this.tiles.allTiles().map(function(t){var e;if(null!=t.factory)return e={x:t.x,y:t.y},null!=t.factoryOptions&&(e=Object.assign(e,t.factoryOptions)),t.factory(e)}).filter(function(t){return null!=t})},e.prototype.getTiles=function(){return null==this.finalTiles&&this.calcul(),this.finalTiles},e.prototype.newRoom=function(){if(this.free.length)return this.volume=Math.floor(this.rng()*(this.maxVolume-this.minVolume))+this.minVolume,this.room=new e.Room},e.prototype.randomDirections=function(){var t,e,n,i;for(i=e=void 0,t=(n=this.directions.slice()).length;t;)e=Math.floor(this.rng()*t),i=n[--t],n[t]=n[e],n[e]=i;return n},e.prototype.step=function(){var t,e;if(this.room){if(this.free.length&&this.room.tiles.length<this.volume-1){if(this.room.tiles.length){for(e=this.randomDirections(),t=!1;e.length&&!t;)t=this.expand(this.room,e.pop(),this.volume);return t||this.roomDone(),t}return this.allocateTile(this.randomFreeTile(),this.room),!0}return this.roomDone(),!1}},e.prototype.roomDone=function(){return this.rooms.push(this.room),this.allocateWalls(this.room),this.room=null},e.prototype.expand=function(t,e,n){var i,r,o,a,s,l,u;for(null==n&&(n=0),l=!1,i=0,r=(a=t.tiles).length;i<r;i++)u=a[i],(0===n||t.tiles.length<n)&&((o=this.tileOffsetIsFree(u,e))&&(this.allocateTile(o,t),l=!0),(s=this.tileOffsetIsFree(u,e,2))&&!this.tileOffsetIsFree(u,e,3)&&this.allocateTile(s,t));return l},e.prototype.allocateWalls=function(r){var o,t,e,a,s,l,n,i,u;for(i=[],t=0,e=(n=r.tiles).length;t<e;t++)u=n[t],i.push(function(){var t,e,n,i;for(i=[],t=0,e=(n=this.allDirections).length;t<e;t++)o=n[t],null!=(a=this.tiles.getTile(u.x+o.x,u.y+o.y))&&a.room!==r?(W.call(this.corners,o)<0&&(l=this.tiles.getTile(u.x+2*o.x,u.y+2*o.y),s=null!=(null!=l?l.room:void 0)?l.room:null,r.addWall(a,s),null!=s&&s.addWall(a,r)),a.factory=this.wallFactory,i.push(this.allocateTile(a))):i.push(void 0);return i}.call(this));return i},e.prototype.createDoors=function(){var r,t,e,n,i,o,a;for(i=[],t=0,e=(n=this.rooms).length;t<e;t++)o=n[t],i.push(function(){var t,e,n,i;for(i=[],t=0,e=(n=o.wallsByRooms()).length;t<e;t++)null!=(a=n[t]).room&&o.doorsForRoom(a.room)<1?((r=a.tiles[Math.floor(this.rng()*a.tiles.length)]).factory=this.doorFactory,r.factoryOptions={direction:this.tiles.getTile(r.x+1,r.y).factory===this.floorFactory?s.directions.vertical:s.directions.horizontal},o.addDoor(r,a.room),i.push(a.room.addDoor(r,o))):i.push(void 0);return i}.call(this));return i},e.prototype.allocateTile=function(t,e){var n;if(null==e&&(e=null),null!=e&&(e.addTile(t),t.factory=this.floorFactory),-1<(n=this.free.indexOf(t)))return this.free.splice(n,1)},e.prototype.tileOffsetIsFree=function(t,e,n){return null==n&&(n=1),this.tileIsFree(t.x+e.x*n,t.y+e.y*n)},e.prototype.tileIsFree=function(t,e){var n;return null!=(n=this.tiles.getTile(t,e))&&0<=W.call(this.free,n)&&n},e.prototype.randomFreeTile=function(){return this.free[Math.floor(this.rng()*this.free.length)]},e}()).Room=function(){function t(){this.tiles=[],this.walls=[],this.doors=[]}return t.prototype.addTile=function(t){return this.tiles.push(t),t.room=this},t.prototype.containsWall=function(t){var e,n,i,r;for(e=0,n=(i=this.walls).length;e<n;e++)if((r=i[e]).tile===t)return r;return!1},t.prototype.addWall=function(t,e){var n;return(n=this.containsWall(t))?n.nextRoom=e:this.walls.push({tile:t,nextRoom:e})},t.prototype.wallsByRooms=function(){var t,e,n,i,r,o,a;for(o=[],r=[],t=0,e=(i=this.walls).length;t<e;t++)a=i[t],-1===(n=o.indexOf(a.nextRoom))&&(n=o.length,o.push(a.nextRoom),r.push({room:a.nextRoom,tiles:[]})),r[n].tiles.push(a.tile);return r},t.prototype.addDoor=function(t,e){return this.doors.push({tile:t,nextRoom:e})},t.prototype.doorsForRoom=function(t){var e,n,i,r,o;for(o=[],n=0,i=(r=this.doors).length;n<i;n++)(e=r[n]).nextRoom===t&&o.push(e.tile);return o},t}(),e},p.RoomGenerator=D(),p.RoomGenerator.definition=D,A=function(t){var n,e;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,(e=function(t){function e(t,e){this.x=t,this.y=e,this.init()}return N(e,n),e.properties({x:{},y:{},links:{collection:{findStar:function(e){return this.find(function(t){return t.star2===e||t.star1===e})}}}}),e.prototype.init=function(){},e.prototype.linkTo=function(t){if(!this.links.findStar(t))return this.addLink(new this.constructor.Link(this,t))},e.prototype.addLink=function(t){return this.links.add(t),t.otherStar(this).links.add(t),t},e.prototype.dist=function(t,e){var n,i;return n=this.x-t,i=this.y-e,Math.sqrt(n*n+i*i)},e.collenctionFn={closest:function(n,i){var r,o;return o=r=null,this.forEach(function(t){var e;if(e=t.dist(n,i),null==r||e<o)return r=t,o=e}),r},closests:function(e,n){var t;return(t=this.map(function(t){return{dist:t.dist(e,n),star:t}})).sort(function(t,e){return t.dist-e.dist}),this.copy(t.map(function(t){return t.star}))}},e}()).Link=function(t){function e(t,e){this.star1=t,this.star2=e}return N(e,n),e.prototype.remove=function(){return this.star1.links.remove(this),this.star2.links.remove(this)},e.prototype.otherStar=function(t){return t===this.star1?this.star2:this.star1},e.prototype.getLength=function(){return this.star1.dist(this.star2.x,this.star2.y)},e.prototype.inBoundaryBox=function(t,e,n){var i,r,o,a;return null==n&&(n=0),i=Math.min(this.star1.x,this.star2.x)-n,o=Math.min(this.star1.y,this.star2.y)-n,r=Math.max(this.star1.x,this.star2.x)+n,a=Math.max(this.star1.y,this.star2.y)+n,i<=t&&t<=r&&o<=e&&e<=a},e.prototype.closeToPoint=function(t,e,n){var i,r,o,a,s,l,u,p,c,h;return!!this.inBoundaryBox(t,e,n)&&(i=this.star1,l={x:t,y:e},u=(s=this.star2).x-i.x,c=s.y-i.y,Math.sqrt(u*u+c*c),o=Math.atan(c/u),p=l.x-i.x,h=l.y-i.y,a=Math.sqrt(p*p+h*h),r=o-Math.atan(h/p),Math.abs(Math.sin(r)*a)<=n)},e.prototype.intersectLink=function(t){var e,n,i,r,o,a,s,l,u,p,c,h;return s=this.star1.x,p=this.star1.y,l=this.star2.x,c=this.star2.y,u=t.star1.x,h=t.star1.y,a=((r=t.star2.x-u)*(p-h)-(o=t.star2.y-h)*(s-u))/(-r*(i=c-p)+(n=l-s)*o),0<(e=(-i*(s-u)+n*(p-h))/(-r*i+n*o))&&e<1&&0<a&&a<1},e}(),e},p.Star=A(),p.Star.definition=A,I=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,function(t){function e(){e.__super__.constructor.call(this),this.queue=[],this.limiters=[]}return N(e,n),e.prototype.addOperation=function(t,e){return null==e&&(e=1),e?this.queue.unshift(t):this.queue.push(t)},e.prototype.addLimiter=function(t){if(!this.findLimiter(t))return this.limiters.push(t)},e.prototype.findLimiter=function(t){return-1<this.limiters.indexOf(t)},e.prototype.start=function(){var t;for(t=[];this.queue.length;)t.push(this.step());return t},e.prototype.step=function(){var t;return 0===this.queue.length?this.done():(t=this.queue.shift(t))(this)},e.prototype.done=function(){},e}()},p.SignalOperation=I(),p.SignalOperation.definition=I,M=function(t){var n,r;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,r=t.hasOwnProperty("SignalOperation")?t.SignalOperation:p.SignalOperation,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({signals:{collection:!0},inputs:{collection:!0},outputs:{collection:!0,itemAdded:function(e,t){return this.forwardedSignals.forEach((n=this,function(t){return n.forwardSignalTo(t,e)}));var n},itemRemoved:function(e,t){return this.forwardedSignals.forEach((n=this,function(t){return n.stopForwardedSignalTo(t,e)}));var n}},forwardedSignals:{collection:!0}}),e.prototype.canConnectTo=function(t){return"function"==typeof t.addSignal},e.prototype.acceptSignal=function(t){return!0},e.prototype.onAddConnection=function(t){},e.prototype.onRemoveConnection=function(t){},e.prototype.onNewSignalType=function(t){},e.prototype.onAddSignal=function(t,e){},e.prototype.onRemoveSignal=function(t,e){},e.prototype.onRemoveSignalType=function(t,e){},e.prototype.onReplaceSignal=function(t,e,n){},e.prototype.containsSignal=function(e,n,i){return null==n&&(n=!1),this.signals.find(function(t){return t.match(e,n,i)})},e.prototype.addSignal=function(e,n){var t,i;return(null!=n?n.findLimiter(this):void 0)||(n||(n=new r,t=!0),n.addOperation((i=this,function(){var t;if(!i.containsSignal(e,!0)&&i.acceptSignal(e)&&(t=i.containsSignal(e),i.signals.push(e),i.onAddSignal(e,n),!t))return i.onNewSignalType(e,n)})),t&&n.start()),e},e.prototype.removeSignal=function(e,n){var t,i;if(!(null!=n?n.findLimiter(this):void 0)&&(n||(n=new r,t=!0),n.addOperation((i=this,function(){var t;if((t=i.containsSignal(e,!0))&&i.acceptSignal(e)&&(i.signals.splice(i.signals.indexOf(t),1),i.onRemoveSignal(e,n),n.addOperation(function(){var t;return(t=i.containsSignal(e))?i.onReplaceSignal(e,t,n):i.onRemoveSignalType(e,n)},0)),stepByStep)return n.step()})),t))return n.start()},e.prototype.prepForwardedSignal=function(t){return t.last===this?t:t.withLast(this)},e.prototype.forwardSignal=function(e,n){var i;return this.forwardedSignals.add(e),i=this.prepForwardedSignal(e),this.outputs.forEach(function(t){if(e.last!==t)return t.addSignal(i,n)})},e.prototype.forwardAllSignalsTo=function(n,i){return this.signals.forEach((r=this,function(t){var e;return e=r.prepForwardedSignal(t),n.addSignal(e,i)}));var r},e.prototype.stopForwardedSignal=function(e,n){var i;return this.forwardedSignals.remove(e),i=this.prepForwardedSignal(e),this.outputs.forEach(function(t){if(e.last!==t)return t.removeSignal(i,n)})},e.prototype.stopAllForwardedSignalTo=function(n,i){return this.signals.forEach((r=this,function(t){var e;return e=r.prepForwardedSignal(t),n.removeSignal(e,i)}));var r},e.prototype.forwardSignalTo=function(t,e,n){var i;if(i=this.prepForwardedSignal(t),t.last!==e)return e.addSignal(i,n)},e.prototype.stopForwardedSignalTo=function(t,e,n){var i;if(i=this.prepForwardedSignal(t),t.last!==e)return e.removeSignal(i,n)},e}()},p.Connected=M(),p.Connected.definition=M,F=function(t){var e;return null==t&&(t={}),e=t.hasOwnProperty("Element")?t.Element:p.Spark.Element,function(t){function i(t,e,n){this.origin=t,this.type=null!=e?e:"signal",this.exclusive=null!=n&&n,i.__super__.constructor.call(this),this.last=this.origin}return N(i,e),i.prototype.withLast=function(t){var e;return(e=new this.__proto__.constructor(this.origin,this.type,this.exclusive)).last=t,e},i.prototype.copy=function(){var t;return(t=new this.__proto__.constructor(this.origin,this.type,this.exclusive)).last=this.last,t},i.prototype.match=function(t,e,n){return null==e&&(e=!1),null==n&&(n=this.exclusive),(!e||t.last===this.last)&&(n||t.origin===this.origin)&&t.type===this.type},i}()},p.Signal=F(),p.Signal.definition=F,R=function(t){var n,i,r;return null==t&&(t={}),n=t.hasOwnProperty("Connected")?t.Connected:p.Connected,i=t.hasOwnProperty("Signal")?t.Signal:p.Signal,r=t.hasOwnProperty("SignalOperation")?t.SignalOperation:p.SignalOperation,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e.properties({activated:{change:function(){var t;return t=new r,this.activated?this.forwardSignal(this.signal,t):this.stopForwardedSignal(this.signal,t),t.start()}},signal:{calcul:function(){return new i(this,"power",!0)}}}),e}()},p.SignalSource=R(),p.SignalSource.definition=R,j=function(t){var n;return null==t&&(t={}),n=t.hasOwnProperty("Connected")?t.Connected:p.Connected,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return N(e,n),e}()},p.Switch=j(),p.Switch.definition=j,L=function(t){var n,i;return null==t&&(t={}),i=t.hasOwnProperty("Tiled")?t.Tiled:p.Tiled,t.hasOwnProperty("Direction")?t.Direction:p.Direction,n=t.hasOwnProperty("Connected")?t.Connected:p.Connected,function(t){function e(t){this.wireType=null!=t?t:"red",e.__super__.constructor.call(this)}return N(e,i),e.extend(n),e.properties({outputs:{calcul:function(n){var t,i;return(t=n.prop("tile"))?n.prop("adjacentTiles",t).reduce((i=this,function(t,e){return t.concat(n.prop("children",e).filter(function(t){return i.canConnectTo(t)}).toArray())}),[]):[]}},connectedDirections:{calcul:function(t){return t.prop("outputs").reduce((n=this,function(e,t){return n.findDirectionsTo(t).forEach(function(t){if(W.call(e,t)<0)return e.push(t)}),e}),[]);var n}}}),e.prototype.findDirectionsTo=function(t){var e;return(null!=t.tiles?t.tiles.map((e=this,function(t){return e.tile.findDirectionOf(t)})):[this.tile.findDirectionOf(t)]).filter(function(t){return null!=t})},e.prototype.canConnectTo=function(t){return n.prototype.canConnectTo.call(this,t)&&(null==t.wireType||t.wireType===this.wireType)},e.prototype.onNewSignalType=function(t,e){return this.forwardSignal(t,e)},e}()},p.Wire=L(),p.Wire.definition=L,B=function(t){var n,i,r,o;return null==t&&(t={}),r=t.hasOwnProperty("Tiled")?t.Tiled:p.Tiled,o=t.hasOwnProperty("Timing")?t.Timing:p.Timing,n=t.hasOwnProperty("Damageable")?t.Damageable:p.Damageable,i=t.hasOwnProperty("Projectile")?t.Projectile:p.Projectile,function(t){function e(t){this.setProperties(t),e.__super__.constructor.call(this)}return N(e,r),e.extend(n),e.properties({rechargeTime:{default:1e3},power:{default:10},blastRange:{default:1},propagationType:{default:null},projectileSpeed:{default:10},target:{default:null,change:function(){if(this.autoFire)return this.fire()}},charged:{default:!0},charging:{default:!0},enabled:{default:!0},autoFire:{default:!0},criticalHealth:{default:.3},canFire:{get:function(){return this.target&&this.enabled&&this.charged&&this.health/this.maxHealth>=this.criticalHealth}},timing:{calcul:function(){return new o}}}),e.prototype.fire=function(){var t;if(this.canFire)return(t=new i({origin:this,target:this.target,power:this.power,blastRange:this.blastRange,propagationType:this.propagationType,speed:this.projectileSpeed,timing:this.timing})).launch(),this.charged=!1,this.recharge(),t},e.prototype.recharge=function(){return this.charging=!0,this.chargeTimeout=this.timing.setTimeout((t=this,function(){return t.charging=!1,t.recharged()}),this.rechargeTime);var t},e.prototype.recharged=function(){if(this.charged=!0,this.autoFire)return this.fire()},e}()},p.Weapon=B(),p.Weapon.definition=B}).call(this),function(){var a,s,t,e,n,i,r,o,l,u,p,c,h,d,f=function(t,e){for(var n in e)y.call(e,n)&&(t[n]=e[n]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},y={}.hasOwnProperty;a="undefined"!=typeof module&&null!==module?(null==(s=module.exports).DOM&&(s.DOM={}),s.DOM):(s=this.Parallelio,null==this.Parallelio.DOM&&(this.Parallelio.DOM={}),this.Parallelio.DOM),t=function(t){var n,e;return null==t&&(t={}),n=t.hasOwnProperty("BaseUpdater")?t.BaseUpdater:s.Spark.Updater,(e=function(t){function e(){var t;e.__super__.constructor.call(this),this.updateCallback=(t=this,function(){return t.update()}),this.binded=!1}return f(e,n),e.prototype.update=function(){if(e.__super__.update.call(this),this.binded=!1,0<this.callbacks.length)return this.requestFrame()},e.prototype.requestFrame=function(){if(!this.binded)return window.requestAnimationFrame(this.updateCallback),this.binded=!0},e.prototype.addCallback=function(t){return e.__super__.addCallback.call(this,t),this.requestFrame()},e}()).instance=new e,e},a.Updater=t(),a.Updater.definition=t,e=function(t){var n,i;return null==t&&(t={}),n=t.hasOwnProperty("Element")?t.Element:s.Element,i=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return f(e,n),e.include(EventEmitter.prototype),e.properties({displayContainer:{updater:i.instance,default:null,change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},cls:{updater:i.instance,change:function(t){if(this.getPropertyInstance("display").calculated&&(null!=t&&this.display.removeClass(t),null!=this.cls))return this.display.addClass(this.cls)}},display:{calcul:function(){var t,e;return e=document.createElement("div"),(t=jQuery(e).addClass(this.baseCls).addClass(this.cls).css({top:this.displayY,left:this.displayX})).get(0)._parallelio_obj=this,t}},displayX:{updater:i.instance,default:0,change:function(t){if(this.getPropertyInstance("display").calculated)return this.display.css({left:this.displayX})}},displayY:{updater:i.instance,default:0,change:function(t){if(this.getPropertyInstance("display").calculated)return this.display.css({top:this.displayY})}}}),e.prototype.initDisplay=function(){return this.displayContainer},e.prototype.destroyDisplay=function(){if(null!=this._display)return this.display.remove()},e}()},a.Display=e(),a.Display.definition=e,n=function(t){var n,i;return null==t&&(t={}),n=t.hasOwnProperty("BaseTiled")?t.BaseTiled:s.Tiled,i=t.hasOwnProperty("Display")?t.Display:a.Display,function(t){function e(){e.__super__.constructor.call(this),this.initDisplay()}return f(e,n),e.extend(i),e.include(EventEmitter.prototype),e.properties({displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return t.prop("displayContainer",e)}},displayX:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayX+e.tileToDisplayX(t.prop("offsetX"))}},displayY:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayY+e.tileToDisplayY(t.prop("offsetY"))}}}),e}()},a.Tiled=n(),a.Tiled.definition=n,i=function(t){var n,e;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:a.Tiled,n=t.hasOwnProperty("BaseCharacter")?t.BaseCharacter:s.Character.definition({Tiled:e}),t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(){e.__super__.constructor.call(this),this.baseCls="character"}return f(e,n),e}()},a.Character=i(),a.Character.definition=i,r=function(t){var n,i,r;return null==t&&(t={}),n=t.hasOwnProperty("BaseDamageable")?t.BaseDamageable:s.Damageable,i=t.hasOwnProperty("Display")?t.Display:a.Display,r=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(){e.__super__.constructor.call(this),this.healthCls(),this.initDisplay()}return f(e,n),e.extend(i),e.include(EventEmitter.prototype),e.properties({healthClsSteps:{default:10},healthCls:{updater:r.instance,active:function(t){return t.propInitiated("display")},calcul:function(t){return"health-"+Math.ceil(t.prop("health")/t.prop("maxHealth")*t.prop("healthClsSteps"))},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.healthCls)return this.display.addClass(this.healthCls)}}}),e}()},a.Damageable=r(),a.Damageable.definition=r,o=function(t){var n,e,i;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:a.Tiled,n=t.hasOwnProperty("BaseDoor")?t.BaseDoor:s.Door.definition({Tiled:e}),i=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(t){this.baseCls="door",e.__super__.constructor.call(this,t)}return f(e,n),e.properties({direction:{updater:i.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.direction)return this.display.addClass(this.direction)}}}),e}()},a.Door=o(),a.Door.definition=o,l=function(t){var n,i,r;return null==t&&(t={}),n=t.hasOwnProperty("BaseProjectile")?t.BaseProjectile:s.Projectile,i=t.hasOwnProperty("Display")?t.Display:a.Display,r=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return f(e,n),e.extend(i),e.prototype.init=function(){return e.__super__.init.call(this),this.baseCls="projectile",this.initDisplay()},e.properties({displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):t.prop("originTile").displayContainer}},displayX:{calcul:function(t){return this.originTile.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.originTile.tileToDisplayY(t.prop("y"))}},moving:{change:function(){return this.moving?r.instance.addCallback(this.callback("invalidatePrcPath")):r.instance.removeCallback(this.callback("invalidatePrcPath"))}}}),e.prototype.destroy=function(){return this.destroyDisplay(),r.instance.removeCallback(this.callback("invalidatePrcPath"))},e}()},a.Projectile=l(),a.Projectile.definition=l,u=function(t){var n,i,e,r;return null==t&&(t={}),n=t.hasOwnProperty("BaseTile")?t.BaseTile:s.Tile,e=t.hasOwnProperty("Floor")?t.Floor:s.Floor,i=t.hasOwnProperty("Display")?t.Display:a.Display,(r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return f(e,n),e.extend(i),e.size=20,e.prototype.init=function(){return e.__super__.init.call(this),this.baseCls="tile",this.initDisplay()},e.properties({container:{},displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):void 0}},displayX:{calcul:function(t){return this.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.tileToDisplayY(t.prop("y"))}}}),e.prototype.tileToDisplayX=function(t){return t*e.size},e.prototype.tileToDisplayY=function(t){return t*e.size},e}()).Floor=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return f(e,t),e.prototype.init=function(){return e.__super__.init.call(this),this.cls="floor"},e}(e.definition({Tile:r})),r},a.Tile=u(),a.Tile.definition=u,p=function(t){var n,i,e,r,o;return null==t&&(t={}),r=t.hasOwnProperty("Tile")?t.Tile:a.Tile,o=t.hasOwnProperty("TileContainer")?t.TileContainer:s.TileContainer,n=t.hasOwnProperty("DefaultGenerator")?t.DefaultGenerator:s.RoomGenerator,i=t.hasOwnProperty("Door")?t.Door:a.Door,(e=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return f(n,o),n.include(EventEmitter.prototype),n.prototype.init=function(){return n.__super__.init.call(this),this.displayContainer},n.properties({container:{},displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("container"))?e.getProperty("display"):void 0)return e.display},change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},display:{calcul:function(){var t;return(t=$(document.createElement("div")).addClass("ship")).get(0)._parallelio_obj=this,t}}}),n.prototype.generate=function(t){return(t=t||(new n.Generator).tap(function(){})).getTiles().forEach((e=this,function(t){return e.addTile(t)}));var e},n}()).Generator=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return f(e,n),e.prototype.wallFactory=function(t){return new r(t.x,t.y).tap(function(){return this.cls="wall",this.walkable=!1})},e.prototype.floorFactory=function(t){return new r.Floor(t.x,t.y)},e.prototype.doorFactory=function(t){return new r.Floor(t.x,t.y).tap(function(){return this.addChild(new i(t.direction))})},e}(),e},a.Ship=p(),a.Ship.definition=p,c=function(t){var e;return null==t&&(t={}),e=t.hasOwnProperty("Element")?t.Element:s.Element,function(t){function i(t){this.display=null!=t?t:null,this.hovered=!1,this.keysInterval={}}return f(i,e),i.directionkeys={38:{name:"top",x:0,y:-1},39:{name:"right",x:1,y:0},40:{name:"bottom",x:0,y:1},37:{name:"left",x:-1,y:0}},i.properties({x:{default:0,change:function(){return this.updateDisplayPos()}},y:{default:0,change:function(){return this.updateDisplayPos()}},display:{change:function(){return 0===$(".viewContent",this.display).length&&$(this.display).append('<div class="viewContent"></div>'),this.updateDisplayPos(),$(this.display).mouseenter(this.callback("mouseEnter")),$(this.display).mouseleave(this.callback("mouseLeave"))}}}),i.prototype.mouseEnter=function(){return this.hovered=!0,$("body").keydown(this.callback("keyDown")),$("body").keyup(this.callback("keyUp"))},i.prototype.mouseLeave=function(){var t,e,n,i;for(t in this.hovered=!1,$("body").off("keydown",this.callback("keyDown")),$("body").off("keyup",this.callback("keyUp")),i=[],n=this.keysInterval)e=n[t],i.push(clearInterval(e));return i},i.prototype.keyDown=function(t){var e,n;if(null!=i.directionkeys[t.which])return e=i.directionkeys[t.which],null!=this.keysInterval[e.name]&&clearInterval(this.keysInterval[e.name]),this.keysInterval[e.name]=setInterval((n=this,function(){return n.x+=2*e.x,n.y+=2*e.y}),10)},i.prototype.keyUp=function(t){var e;if(null!=i.directionkeys[t.which]&&(e=i.directionkeys[t.which],null!=this.keysInterval[e.name]))return clearInterval(this.keysInterval[e.name])},i.prototype.updateDisplayPos=function(){return $(".viewContent",this.display).css({left:this.x+"px",top:this.y+"px"})},i.prototype.containsPoint=function(t,e){var n;for(n=this.display[0];n;)t-=n.offsetLeft,e-=n.offsetTop,n=n.offsetParent;return 0<=t&&t<=this.display.width()&&0<=e&&e<=this.display.height()},i}()},a.View=c(),a.View.definition=c,h=function(t){var n,e,i,r,o;return null==t&&(t={}),r=t.hasOwnProperty("Tiled")?t.Tiled:a.Tiled,i=t.hasOwnProperty("Projectile")?t.Projectile:a.Projectile,e=t.hasOwnProperty("Damageable")?t.Damageable:a.Damageable,n=t.hasOwnProperty("BaseWeapon")?t.BaseWeapon:s.Weapon.definition({Tiled:r,Damageable:e,Projectile:i}),o=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(t){this.baseCls="weapon",e.__super__.constructor.call(this,t)}return f(e,n),e.properties({direction:{updater:o.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t.name),null!=this.direction.name)return this.display.addClass(this.direction.name)}}}),e}()},a.Weapon=h(),a.Weapon.definition=h,d=function(t){var n,e,i;return null==t&&(t={}),e=t.hasOwnProperty("Tiled")?t.Tiled:a.Tiled,n=t.hasOwnProperty("BaseWire")?t.BaseWire:s.Wire.definition({Tiled:e}),i=t.hasOwnProperty("Updater")?t.Updater:a.Updater,function(t){function e(t){e.__super__.constructor.call(this,t),this.baseCls="wire",this.connectedDirections}return f(e,n),e.properties({display:{calcul:function(t,e){return e()}},connectedDirections:{updater:i.instance,active:function(t){return t.propInitiated("display")},change:function(t){var e,n;return t&&t.forEach((e=this,function(t){return e.display.removeClass(e.getClassFromDirection(t))})),this.connectedDirections.forEach((n=this,function(t){return n.display.addClass(n.getClassFromDirection(t))}))}},wireType:{updater:i.instance,active:function(t){return t.propInitiated("display")},change:function(t){return t&&this.display.removeClass(t),this.display.addClass(this.wireType)}}}),e.prototype.getClassFromDirection=function(t){return"conn"+t.name.charAt(0).toUpperCase()+t.name.slice(1)},e}()},a.Wire=d(),a.Wire.definition=d}.call(this);