(function(){var t,e,i=[].indexOf;null==(t="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Parallelio&&(this.Parallelio={}),this.Parallelio)).Spark&&(t.Spark={}),t.strings={greekAlphabet:["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"],starNames:["Achernar","Maia","Atlas","Salm","Alnilam","Nekkar","Elnath","Thuban","Achird","Marfik","Auva","Sargas","Alnitak","Nihal","Enif","Torcularis","Acrux","Markab","Avior","Sarin","Alphard","Nunki","Etamin","Turais","Acubens","Matar","Azelfafage","Sceptrum","Alphekka","Nusakan","Fomalhaut","Tyl","Adara","Mebsuta","Azha","Scheat","Alpheratz","Peacock","Fornacis","Unukalhai","Adhafera","Megrez","Azmidiske","Segin","Alrai","Phad","Furud","Vega","Adhil","Meissa","Baham","Seginus","Alrisha","Phaet","Gacrux","Vindemiatrix","Agena","Mekbuda","Becrux","Sham","Alsafi","Pherkad","Gianfar","Wasat","Aladfar","Menkalinan","Beid","Sharatan","Alsciaukat","Pleione","Gomeisa","Wezen","Alathfar","Menkar","Bellatrix","Shaula","Alshain","Polaris","Graffias","Wezn","Albaldah","Menkent","Betelgeuse","Shedir","Alshat","Pollux","Grafias","Yed","Albali","Menkib","Botein","Sheliak","Alsuhail","Porrima","Grumium","Yildun","Albireo","Merak","Brachium","Sirius","Altair","Praecipua","Hadar","Zaniah","Alchiba","Merga","Canopus","Situla","Altarf","Procyon","Haedi","Zaurak","Alcor","Merope","Capella","Skat","Alterf","Propus","Hamal","Zavijah","Alcyone","Mesarthim","Caph","Spica","Aludra","Rana","Hassaleh","Zibal","Alderamin","Metallah","Castor","Sterope","Alula","Ras","Heze","Zosma","Aldhibah","Miaplacidus","Cebalrai","Sualocin","Alya","Rasalgethi","Hoedus","Aquarius","Alfirk","Minkar","Celaeno","Subra","Alzirr","Rasalhague","Homam","Aries","Algenib","Mintaka","Chara","Suhail","Ancha","Rastaban","Hyadum","Cepheus","Algieba","Mira","Chort","Sulafat","Angetenar","Regulus","Izar","Cetus","Algol","Mirach","Cursa","Syrma","Ankaa","Rigel","Jabbah","Columba","Algorab","Miram","Dabih","Tabit","Anser","Rotanev","Kajam","Coma","Alhena","Mirphak","Deneb","Talitha","Antares","Ruchba","Kaus","Corona","Alioth","Mizar","Denebola","Tania","Arcturus","Ruchbah","Keid","Crux","Alkaid","Mufrid","Dheneb","Tarazed","Arkab","Rukbat","Kitalpha","Draco","Alkalurops","Muliphen","Diadem","Taygeta","Arneb","Sabik","Kocab","Grus","Alkes","Murzim","Diphda","Tegmen","Arrakis","Sadalachbia","Kornephoros","Hydra","Alkurhah","Muscida","Dschubba","Tejat","Ascella","Sadalmelik","Kraz","Lacerta","Almaak","Naos","Dsiban","Terebellum","Asellus","Sadalsuud","Kuma","Mensa","Alnair","Nash","Dubhe","Thabit","Asterope","Sadr","Lesath","Maasym","Alnath","Nashira","Electra","Theemim","Atik","Saiph","Phoenix","Norma"]},e=function(){return function(){class t{static extend(t){if(this.Extension.make(t,this),null!=t.prototype)return this.Extension.make(t.prototype,this.prototype)}static include(t){return this.Extension.make(t,this.prototype)}}return t.Extension={make:function(t,e){var i,n,r,a;for(i=0,n=(a=this.getExtensionProperties(t,e)).length;i<n;i++)r=a[i],Object.defineProperty(e,r.name,r);if(e.extensions=(e.extensions||[]).concat([t]),"function"==typeof t.extended)return t.extended(e)},alwaysFinal:["extended","extensions","__super__","constructor"],getExtensionProperties:function(t,e){var n,r,a;return n=this.alwaysFinal,a=this.getPrototypeChain(e),r=[],this.getPrototypeChain(t).every(function(s){var o;if(!a.includes(s))return o=n,null!=t.getFinalProperties&&(o=o.concat(t.getFinalProperties())),"function"==typeof s&&(o=o.concat(["length","prototype","name"])),r=r.concat(Object.getOwnPropertyNames(s).filter(t=>!e.hasOwnProperty(t)&&"__"!==t.substr(0,2)&&i.call(o,t)<0&&!r.find(function(e){return e.name===t})).map(function(t){var e;return(e=Object.getOwnPropertyDescriptor(s,t)).name=t,e})),!0}),r},getPrototypeChain:function(t){var e,i;for(i=[],e=Object.getPrototypeOf(Object);i.push(t),(t=Object.getPrototypeOf(t))&&t!==Object&&t!==e;);return i}},t}.call(this)},t.Spark.Mixable=e(),t.Spark.Mixable.definition=e,function(e){t.Spark.PropertyOwner=e(),t.Spark.PropertyOwner.definition=e}(function(){return class{getProperty(t){return this._properties&&this._properties.find(function(e){return e.name===t})}getPropertyInstance(t){var e;if(e=this.getProperty(t))return e.getInstance(this)}getProperties(){return this._properties.slice()}getPropertyInstances(){return this._properties.map(t=>t.getInstance(this))}getInstantiatedProperties(){return this._properties.filter(t=>t.isInstantiated(this)).map(t=>t.getInstance(this))}getManualDataProperties(){return this._properties.reduce((t,e)=>{var i;return e.isInstantiated(this)&&(i=e.getInstance(this)).calculated&&i.manual&&(t[e.name]=i.value),t},{})}setProperties(t,e={}){var i,n,r;for(i in t)r=t[i],null!=e.whitelist&&-1===e.whitelist.indexOf(i)||null!=e.blacklist&&-1!==e.blacklist.indexOf(i)||null!=(n=this.getPropertyInstance(i))&&n.set(r);return this}destroyProperties(){return this.getInstantiatedProperties().forEach(t=>t.destroy()),this._properties=[],!0}listenerAdded(t,e){return this._properties.forEach(e=>{if(e.getInstanceType().prototype.changeEventName===t)return e.getInstance(this).get()})}extended(t){return t.listenerAdded=this.listenerAdded}}}),function(e){t.Spark.BasicProperty=e(),t.Spark.BasicProperty.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Mixable")?e.Mixable:t.Spark.Mixable,class t extends i{constructor(t,e){super(),this.property=t,this.obj=e,this.init()}init(){return this.value=this.ingest(this.default),this.calculated=!1}get(){return this.calculated=!0,this.output()}set(t){return this.setAndCheckChanges(t)}callbackSet(t){return this.callOptionFunct("set",t),this}setAndCheckChanges(t){var e;return t=this.ingest(t),this.revalidated(),this.checkChanges(t,this.value)&&(e=this.value,this.value=t,this.manual=!0,this.changed(e)),this}checkChanges(t,e){return t!==e}destroy(){}callOptionFunct(t,...e){return"string"==typeof t&&(t=this.property.options[t]),"function"==typeof t.overrided&&e.push((...e)=>this.callOptionFunct(t.overrided,...e)),t.apply(this.obj,e)}revalidated(){return this.calculated=!0,this.initiated=!0}ingest(t){return"function"==typeof this.property.options.ingest?this.callOptionFunct("ingest",t):t}output(){return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.value}changed(t){return this.callChangedFunctions(t),"function"==typeof this.obj.emitEvent&&(this.obj.emitEvent(this.updateEventName,[t]),this.obj.emitEvent(this.changeEventName,[t])),this}callChangedFunctions(t){if("function"==typeof this.property.options.change)return this.callOptionFunct("change",t)}hasChangedFunctions(){return"function"==typeof this.property.options.change}hasChangedEvents(){return"function"==typeof this.obj.getListeners&&this.obj.getListeners(this.changeEventName).length>0}static compose(e){return null==e.instanceType&&(e.instanceType=class extends t{}),"function"==typeof e.options.set?e.instanceType.prototype.set=this.prototype.callbackSet:e.instanceType.prototype.set=this.prototype.setAndCheckChanges,e.instanceType.prototype.default=e.options.default,e.instanceType.prototype.initiated=void 0!==e.options.default,this.setEventNames(e)}static setEventNames(t){return t.instanceType.prototype.changeEventName=t.options.changeEventName||t.name+"Changed",t.instanceType.prototype.updateEventName=t.options.updateEventName||t.name+"Updated",t.instanceType.prototype.invalidateEventName=t.options.invalidateEventName||t.name+"Invalidated"}static bind(t,e){var i,n;return i=e.name.charAt(0).toUpperCase()+e.name.slice(1),n={configurable:!0,get:function(){return e.getInstance(this).get()}},!1!==e.options.set&&(n.set=function(t){return e.getInstance(this).set(t)}),Object.defineProperty(t,e.name,n),t["get"+i]=function(){return e.getInstance(this).get()},!1!==e.options.set&&(t["set"+i]=function(t){return e.getInstance(this).set(t),this}),t["invalidate"+i]=function(){return e.getInstance(this).invalidate(),this}}}}),function(e){t.Spark.Binder=e(),t.Spark.Binder.definition=e}(function(){return class{bind(){return this.binded||null==this.callback||null==this.target||this.doBind(),this.binded=!0}doBind(){throw new Error("Not implemented")}unbind(){return this.binded&&null!=this.callback&&null!=this.target&&this.doUnbind(),this.binded=!1}doUnbind(){throw new Error("Not implemented")}equals(t){return this.constructor.compareRefered(t,this)}static compareRefered(t,e){return t===e||null!=t&&null!=e&&t.constructor===e.constructor&&this.compareRef(t.ref,e.ref)}static compareRef(t,e){return null!=t&&null!=e&&(t===e||Array.isArray(t)&&Array.isArray(t)&&t.every((i,n)=>this.compareRefered(t[n],e[n]))||"object"==typeof t&&"object"==typeof e&&Object.keys(t).join()===Object.keys(e).join()&&Object.keys(t).every(i=>this.compareRefered(t[i],e[i])))}}}),function(e){t.Spark.Updater=e(),t.Spark.Updater.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Binder")?e.Binder:t.Spark.Binder,(n=class t{constructor(){this.callbacks=[],this.next=[],this.updating=!1}update(){for(this.updating=!0,this.next=this.callbacks.slice();this.callbacks.length>0;)this.callbacks.shift()();return this.callbacks=this.next,this.updating=!1,this}addCallback(t){if(this.callbacks.includes(t)||this.callbacks.push(t),this.updating&&!this.next.includes(t))return this.next.push(t)}nextTick(t){return this.updating?this.next.includes(t)?void 0:this.next.push(t):this.addCallback(t)}removeCallback(t){var e;if(-1!==(e=this.callbacks.indexOf(t))&&this.callbacks.splice(e,1),-1!==(e=this.next.indexOf(t)))return this.next.splice(e,1)}getBinder(){return new t.Binder(this)}destroy(){return this.callbacks=[],this.next=[]}}).Binder=function(t){return class extends t{constructor(t,e){super(),this.target=t,this.callback=e,this.ref={target:this.target,callback:this.callback}}doBind(){return this.target.addCallback(this.callback)}doUnbind(){return this.target.removeCallback(this.callback)}}}.call(this,i),n}),function(e){t.Timing=e(),t.Timing.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("BaseUpdater")?e.BaseUpdater:t.Spark.Updater,(n=class{constructor(t=!0){this.running=t,this.children=[]}addChild(t){var e;return e=this.children.indexOf(t),this.updater&&(t.updater.dispatcher=this.updater),-1===e&&this.children.push(t),t.parent=this,this}removeChild(t){var e;return(e=this.children.indexOf(t))>-1&&this.children.splice(e,1),t.parent===this&&(t.parent=null),this}toggle(t){return void 0===t&&(t=!this.running),this.running=t,this.children.forEach(function(e){return e.toggle(t)})}setTimeout(t,e){var i;return i=new this.constructor.Timer(e,t,this.running),this.addChild(i),i}setInterval(t,e){var i;return i=new this.constructor.Timer(e,t,this.running,!0),this.addChild(i),i}pause(){return this.toggle(!1)}unpause(){return this.toggle(!0)}}).Timer=class{constructor(t,e,r=!0,a=!1){this.time=t,this.running=r,this.repeat=a,this.remainingTime=this.time,this.updater=new n.Updater(this),this.dispatcher=new i,e&&this.dispatcher.addCallback(e),this.running&&this._start()}static now(){var t;return null!=("undefined"!=typeof window&&null!==window&&null!=(t=window.performance)?t.now:void 0)?window.performance.now():null!=("undefined"!=typeof process&&null!==process?process.uptime:void 0)?1e3*process.uptime():Date.now()}toggle(t){return void 0===t&&(t=!this.running),t?this._start():this._stop()}pause(){return this.toggle(!1)}unpause(){return this.toggle(!0)}getElapsedTime(){return this.running?this.constructor.now()-this.startTime+this.time-this.remainingTime:this.time-this.remainingTime}setElapsedTime(t){return this._stop(),this.remainingTime=this.time-t,this._start()}getPrc(){return this.getElapsedTime()/this.time}setPrc(t){return this.setElapsedTime(this.time*t)}_start(){return this.running=!0,this.updater.forwardCallbacks(),this.startTime=this.constructor.now(),this.repeat&&!this.interupted?this.id=setInterval(this.tick.bind(this),this.remainingTime):this.id=setTimeout(this.tick.bind(this),this.remainingTime)}_stop(){var t;return t=this.interupted,this.running=!1,this.updater.unforwardCallbacks(),this.remainingTime=this.time-(this.constructor.now()-this.startTime),this.interupted=this.remainingTime!==this.time,this.repeat&&!t?clearInterval(this.id):clearTimeout(this.id)}tick(){var t;return t=this.interupted,this.interupted=!1,this.repeat?this.remainingTime=this.time:this.remainingTime=0,this.dispatcher.update(),this.repeat?t?this._start():this.startTime=this.constructor.now():this.destroy()}destroy(){if(this.repeat?clearInterval(this.id):clearTimeout(this.id),this.updater.destroy(),this.dispatcher.destroy(),this.running=!1,this.parent)return this.parent.removeChild(this)}},n.Updater=class{constructor(t){this.parent=t,this.dispatcher=new i,this.callbacks=[]}addCallback(t){var e;if(this.callbacks.includes(t)||this.callbacks.push(t),(null!=(e=this.parent)?e.running:void 0)&&this.dispatcher)return this.dispatcher.addCallback(t)}removeCallback(t){var e;if(-1!==(e=this.callbacks.indexOf(t))&&this.callbacks.splice(e,1),this.dispatcher)return this.dispatcher.removeCallback(t)}getBinder(){if(this.dispatcher)return new i.Binder(this)}forwardCallbacks(){if(this.dispatcher)return this.callbacks.forEach(t=>this.dispatcher.addCallback(t))}unforwardCallbacks(){if(this.dispatcher)return this.callbacks.forEach(t=>this.dispatcher.removeCallback(t))}destroy(){return this.unforwardCallbacks(),this.callbacks=[],this.parent=null}},n}),function(e){t.Spark.Overrider=e(),t.Spark.Overrider.definition=e}(function(){return function(){class t{static overrides(t){return this.Override.applyMany(this.prototype,this.name,t)}getFinalProperties(){return null!=this._overrides?["_overrides"].concat(Object.keys(this._overrides)):[]}extended(e){if(null!=this._overrides&&this.constructor.Override.applyMany(e,this.constructor.name,this._overrides),this.constructor===t)return e.extended=this.extended}}return t.Override={makeMany:function(t,e,i){var n,r,a;for(r in a=[],i)n=i[r],a.push(this.make(t,e,r,n));return a},applyMany:function(t,e,i){var n,r,a;for(n in a=[],i)"function"==typeof(r=i[n])&&(r=this.make(t,e,n,r)),a.push(this.apply(t,e,r));return a},make:function(t,e,i,n){var r;return(r={fn:{current:n},name:i}).fn["with"+e]=n,r},emptyFn:function(){},apply:function(t,e,i){var n,r,a,s,o;return n=i.name,r=null!=t._overrides?Object.assign({},t._overrides):{},o=(null!=(a=t._overrides)&&null!=(s=a[n])?s.fn.current:void 0)||t[n],i=Object.assign({},i),null!=r[n]?i.fn=Object.assign({},r[n].fn,i.fn):i.fn=Object.assign({},i.fn),i.fn["without"+e]=o||this.emptyFn,null==o?i.missingWithout="without"+e:i.missingWithout&&(i.fn[i.missingWithout]=o),Object.defineProperty(t,n,{configurable:!0,get:function(){var t,e,r,a;for(r in t=i.fn.current.bind(this),a=i.fn)e=a[r],t[r]=e.bind(this);return this.constructor.prototype!==this&&Object.defineProperty(this,n,{value:t}),t}}),r[n]=i,t._overrides=r}},t}.call(this)}),function(e){t.Spark.Collection=e(),t.Spark.Collection.definition=e}(function(){var t;return t=function(){class t{constructor(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}changed(){}checkChanges(t,e=!0,i=null){return null==i&&(i=function(t,e){return t===e}),t=this.copy(t.slice()),this.count()!==t.length||(e?this.some(function(e,n){return!i(t.get(n),e)}):this.some(function(e){return!t.pluck(function(t){return i(e,t)})}))}get(t){return this._array[t]}set(t,e){var i;return this._array[t]!==e&&(i=this.toArray(),this._array[t]=e,this.changed(i)),e}add(t){if(!this._array.includes(t))return this.push(t)}remove(t){var e,i;if(-1!==(e=this._array.indexOf(t)))return i=this.toArray(),this._array.splice(e,1),this.changed(i)}pluck(t){var e,i,n;return(i=this._array.findIndex(t))>-1?(n=this.toArray(),e=this._array[i],this._array.splice(i,1),this.changed(n),e):null}toArray(){return this._array.slice()}count(){return this._array.length}static newSubClass(t,e){var i;return"object"==typeof t?(i=class extends(this){},Object.assign(i.prototype,t),new i(e)):new this(e)}copy(t){return null==t&&(t=this.toArray()),new this.constructor(t)}equals(t){return this.count()===("function"==typeof t.count?t.count():t.length)&&this.every(function(e,i){return t[i]===e})}getAddedFrom(t){return this._array.filter(function(e){return!t.includes(e)})}getRemovedFrom(t){return t.filter(t=>!this.includes(t))}}return t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(e){return t.prototype[e]=function(...t){return this._array[e](...t)}}),t.readListFunctions.forEach(function(e){return t.prototype[e]=function(...t){return this.copy(this._array[e](...t))}}),t.writefunctions.forEach(function(e){return t.prototype[e]=function(...t){var i,n;return i=this.toArray(),n=this._array[e](...t),this.changed(i),n}}),t}.call(this),Object.defineProperty(t.prototype,"length",{get:function(){return this.count()}}),("undefined"!=typeof Symbol&&null!==Symbol?Symbol.iterator:void 0)&&(t.prototype[Symbol.iterator]=function(){return this._array[Symbol.iterator]()}),t}),function(e){t.Spark.EventBind=e(),t.Spark.EventBind.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Binder")?e.Binder:t.Spark.Binder,class extends i{constructor(t,e,i){super(),this.event=t,this.target=e,this.callback=i,this.ref={event:this.event,target:this.target,callback:this.callback}}doBind(){if("function"==typeof this.target.addEventListener)return this.target.addEventListener(this.event,this.callback);if("function"==typeof this.target.addListener)return this.target.addListener(this.event,this.callback);if("function"==typeof this.target.on)return this.target.on(this.event,this.callback);throw new Error("No function to add event listeners was found")}doUnbind(){if("function"==typeof this.target.removeEventListener)return this.target.removeEventListener(this.event,this.callback);if("function"==typeof this.target.removeListener)return this.target.removeListener(this.event,this.callback);if("function"==typeof this.target.off)return this.target.off(this.event,this.callback);throw new Error("No function to remove event listeners was found")}equals(t){return super.equals(t)&&t.event===this.event}match(t,e){return t===this.event&&e===this.target}static checkEmitter(t,e=!0){if("function"==typeof t.addEventListener||"function"==typeof t.addListener||"function"==typeof t.on)return!0;if(e)throw new Error("No function to add event listeners was found");return!1}}}),function(e){t.Spark.Invalidator=e(),t.Spark.Invalidator.definition=e}(function(e={}){var i,n,r;return i=e.hasOwnProperty("Binder")?e.Binder:t.Spark.Binder,n=e.hasOwnProperty("EventBind")?e.EventBind:t.Spark.EventBind,r=function(t,e){var i,n;return(n=t.findIndex(e))>-1?(i=t[n],t.splice(n,1),i):null},function(){class t extends i{constructor(t,e=null){super(),this.property=t,this.obj=e,this.invalidationEvents=[],this.recycled=[],this.unknowns=[],this.strict=this.constructor.strict,this.invalidated=!1,this.invalidateCallback=(()=>(this.invalidate(),null))}invalidate(){var t;return this.invalidated=!0,"function"==typeof this.property?this.property():"function"==typeof this.callback?this.callback():null!=this.property&&"function"==typeof this.property.invalidate?this.property.invalidate():"string"==typeof this.property?(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null):void 0}unknown(){return"function"==typeof this.property.unknown?this.property.unknown():this.invalidate()}addEventBind(t,e,i){return this.addBinder(new n(t,e,i))}addBinder(t){if(null==t.callback&&(t.callback=this.invalidateCallback),!this.invalidationEvents.some(function(e){return e.equals(t)}))return this.invalidationEvents.push(r(this.recycled,function(e){return e.equals(t)})||t)}getUnknownCallback(t,e){var i;return(i=(()=>this.addUnknown(function(){return e[t]},t,e))).ref={prop:t,target:e},i}addUnknown(t,e,i){if(!this.findUnknown(e,i))return t.ref={prop:e,target:i},this.unknowns.push(t),this.unknown()}findUnknown(t,e){if(null!=t||null!=e)return this.unknowns.find(function(i){return i.ref.prop===t&&i.ref.target===e})}event(t,e=this.obj){if(this.checkEmitter(e))return this.addEventBind(t,e)}value(t,e,i=this.obj){return this.event(e,i),t}prop(t,e=this.obj){if("string"!=typeof t)throw new Error("Property name must be a string");return this.checkEmitter(e)?(this.addEventBind(t+"Invalidated",e,this.getUnknownCallback(t,e)),this.value(e[t],t+"Updated",e)):e[t]}propInitiated(t,e=this.obj){var i;return!(i=e.getPropertyInstance(t).initiated)&&this.checkEmitter(e)&&this.event(t+"Updated",e),i}funct(e){var i,n;return i=new t(()=>this.addUnknown(()=>{var t;if(t=e(i),n!==t)return this.invalidate()},i)),n=e(i),this.invalidationEvents.push(i),n}validateUnknowns(t,e=this.obj){var i;return i=this.unknowns,this.unknowns=[],i.forEach(function(t){return t()})}isEmpty(){return 0===this.invalidationEvents.length}bind(){return this.invalidated=!1,this.invalidationEvents.forEach(function(t){return t.bind()})}recycle(t){var e,i;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],e=(()=>(this.recycled.forEach(function(t){return t.unbind()}),this.recycled=[])),"function"==typeof t?t.length>1?t(this,e):(i=t(this),e(),i):e}checkEmitter(t){return n.checkEmitter(t,this.strict)}unbind(){return this.invalidationEvents.forEach(function(t){return t.unbind()})}}return t.strict=!0,t}.call(this)}),function(e){t.Spark.DynamicProperty=e(),t.Spark.DynamicProperty.definition=e}(function(e={}){var i;return e.hasOwnProperty("Invalidator")?e.Invalidator:t.Spark.Invalidator,i=e.hasOwnProperty("BasicProperty")?e.BasicProperty:t.Spark.BasicProperty,class t extends i{init(){return super.init(),this.initRevalidate()}initRevalidate(){return this.revalidateCallback=(()=>this.get())}callbackGet(){var t;return t=this.callOptionFunct("get"),this.revalidated(),t}invalidate(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()),this}revalidate(){return super.revalidate(),this.revalidateUpdater()}revalidateUpdater(){if(null!=this.getUpdater())return this.getUpdater().unbind()}_invalidateNotice(){return this.isImmediate()?(this.get(),!1):("function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.invalidateEventName),null!=this.getUpdater()&&this.getUpdater().bind(),!0)}getUpdater(){return void 0===this.updater&&(null!=this.property.options.updater?(this.updater=this.property.options.updater,"function"==typeof this.updater.getBinder&&(this.updater=this.updater.getBinder()),"function"!=typeof this.updater.bind||"function"!=typeof this.updater.unbind?this.updater=null:this.updater.callback=this.revalidateCallback):this.updater=null),this.updater}isImmediate(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||("function"==typeof this.property.options.immediate?this.callOptionFunct("immediate"):null==this.getUpdater()&&(this.hasChangedEvents()||this.hasChangedFunctions())))}static compose(e){if("function"!=typeof e.options.get&&"function"!=typeof e.options.calcul&&"function"!=typeof e.options.active||null==e.instanceType&&(e.instanceType=class extends t{}),"function"==typeof e.options.get)return e.instanceType.prototype.get=this.prototype.callbackGet}}}),function(e){t.Spark.ActivableProperty=e(),t.Spark.ActivableProperty.definition=e}(function(e={}){var i,n,r;return n=e.hasOwnProperty("Invalidator")?e.Invalidator:t.Spark.Invalidator,i=e.hasOwnProperty("BasicProperty")?e.BasicProperty:t.Spark.BasicProperty,r=e.hasOwnProperty("Overrider")?e.Overrider:t.Spark.Overrider,function(){class t extends i{isActive(){return!0}manualActive(){return this.active}callbackActive(){return(this.activeInvalidator||new n(this,this.obj)).recycle((t,e)=>(this.active=this.callOptionFunct(this.activeFunct,t),e(),this.active||t.isEmpty()?(t.unbind(),this.activeInvalidator=null):(this.invalidator=t,this.activeInvalidator=t,t.bind()))),this.active}static compose(e){if(void 0!==e.options.active){if(e.instanceType.extend(t),"boolean"==typeof e.options.active)return e.instanceType.prototype.active=e.options.active,e.instanceType.prototype.isActive=this.prototype.manualActive;if("function"==typeof e.options.active)return e.instanceType.prototype.activeFunct=e.options.active,e.instanceType.prototype.isActive=this.prototype.callbackActive}}}return t.extend(r),t.overrides({get:function(){var t;return this.isActive()?(t=this.get.withoutActivableProperty(),this.pendingChanges&&this.changed(this.pendingOld),t):void(this.initiated=!0)},changed:function(t){return this.isActive()?(this.pendingChanges=!1,this.pendingOld=void 0,this.changed.withoutActivableProperty(t)):(this.pendingChanges=!0,void 0===this.pendingOld&&(this.pendingOld=t)),this}}),t}.call(this)}),function(e){t.Spark.CollectionProperty=e(),t.Spark.CollectionProperty.definition=e}(function(e={}){var i,n;return n=e.hasOwnProperty("DynamicProperty")?e.DynamicProperty:t.Spark.DynamicProperty,i=e.hasOwnProperty("Collection")?e.Collection:t.Spark.Collection,function(){class t extends n{ingest(t){return"function"==typeof this.property.options.ingest&&(t=this.callOptionFunct("ingest",t)),null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]}checkChangedItems(t,e){var n;return"function"==typeof this.collectionOptions.compare&&(n=this.collectionOptions.compare),new i(t).checkChanges(e,this.collectionOptions.ordered,n)}output(){var t,e,n;return n=this.value,"function"==typeof this.property.options.output&&(n=this.callOptionFunct("output",this.value)),e=this,(t=i.newSubClass(this.collectionOptions,n)).changed=function(t){return e.changed(t)},t}callChangedFunctions(t){return"function"==typeof this.property.options.itemAdded&&this.value.forEach((e,i)=>{if(!t.includes(e))return this.callOptionFunct("itemAdded",e,i)}),"function"==typeof this.property.options.itemRemoved&&t.forEach((t,e)=>{if(!this.value.includes(t))return this.callOptionFunct("itemRemoved",t,e)}),super.callChangedFunctions(t)}hasChangedFunctions(){return super.hasChangedFunctions()||"function"==typeof this.property.options.itemAdded||"function"==typeof this.property.options.itemRemoved}static compose(e){if(null!=e.options.collection&&(e.instanceType=class extends t{},e.instanceType.prototype.collectionOptions=Object.assign({},this.defaultCollectionOptions,"object"==typeof e.options.collection?e.options.collection:{}),null!=e.options.collection.compare))return e.instanceType.prototype.checkChanges=this.prototype.checkChangedItems}}return t.defaultCollectionOptions={compare:!1,ordered:!0},t}.call(this)}),function(e){t.Spark.CalculatedProperty=e(),t.Spark.CalculatedProperty.definition=e}(function(e={}){var i,n;return e.hasOwnProperty("Invalidator")?e.Invalidator:t.Spark.Invalidator,i=e.hasOwnProperty("DynamicProperty")?e.DynamicProperty:t.Spark.DynamicProperty,n=e.hasOwnProperty("Overrider")?e.Overrider:t.Spark.Overrider,function(){class t extends i{calcul(){return this.value=this.callOptionFunct(this.calculFunct),this.manual=!1,this.revalidated(),this.value}static compose(e){if("function"==typeof e.options.calcul&&(e.instanceType.prototype.calculFunct=e.options.calcul,!(e.options.calcul.length>0)))return e.instanceType.extend(t)}}return t.extend(n),t.overrides({get:function(){var t,e;return this.invalidator&&this.invalidator.validateUnknowns(),this.calculated||(e=this.value,t=this.initiated,this.calcul(),this.checkChanges(this.value,e)&&(t?this.changed(e):"function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.updateEventName,[e]))),this.output()}}),t}.call(this)}),function(e){t.Spark.ComposedProperty=e(),t.Spark.ComposedProperty.definition=e}(function(e={}){var i,n,r,a;return i=e.hasOwnProperty("CalculatedProperty")?e.CalculatedProperty:t.Spark.CalculatedProperty,a=e.hasOwnProperty("Invalidator")?e.Invalidator:t.Spark.Invalidator,n=e.hasOwnProperty("Collection")?e.Collection:t.Spark.Collection,(r=function(){class t extends i{init(){return super.init(),this.initComposed()}initComposed(){return this.property.options.hasOwnProperty("default")?this.default=this.property.options.default:this.default=this.value=!0,this.members=new t.Members(this.property.options.members),this.members.changed=(t=>this.invalidate()),this.join="function"==typeof this.property.options.composed?this.property.options.composed:!1===this.property.options.default?t.joinFunctions.or:t.joinFunctions.and}calcul(){return this.invalidator||(this.invalidator=new a(this,this.obj)),this.invalidator.recycle((t,e)=>(this.value=this.members.reduce((t,e)=>{var i;return i="function"==typeof e?e(this.invalidator):e,this.join(t,i)},this.default),e(),t.isEmpty()?this.invalidator=null:t.bind())),this.revalidated(),this.value}static compose(e){if(null!=e.options.composed)return e.instanceType=class extends t{}}static bind(t,e){return i.bind(t,e),Object.defineProperty(t,e.name+"Members",{configurable:!0,get:function(){return e.getInstance(this).members}})}}return t.joinFunctions={and:function(t,e){return t&&e},or:function(t,e){return t||e}},t}.call(this)).Members=class extends n{addPropertyRef(t,e){var i;if(-1===this.findRefIndex(t,e))return(i=function(i){return i.prop(t,e)}).ref={name:t,obj:e},this.push(i)}addValueRef(t,e,i){var n;if(-1===this.findRefIndex(e,i))return(n=function(e){return t}).ref={name:e,obj:i,val:t},this.push(n)}setValueRef(t,e,i){var n,r;return-1===(r=this.findRefIndex(e,i))?this.addValueRef(t,e,i):this.get(r).ref.val!==t?((n=function(e){return t}).ref={name:e,obj:i,val:t},this.set(r,n)):void 0}getValueRef(t,e){return this.findByRef(t,e).ref.val}addFunctionRef(t,e,i){if(-1===this.findRefIndex(e,i))return t.ref={name:e,obj:i},this.push(t)}findByRef(t,e){return this._array[this.findRefIndex(t,e)]}findRefIndex(t,e){return this._array.findIndex(function(i){return null!=i.ref&&i.ref.obj===e&&i.ref.name===t})}removeRef(t,e){var i,n;if(-1!==(i=this.findRefIndex(t,e)))return n=this.toArray(),this._array.splice(i,1),this.changed(n)}},r}),function(e){t.Spark.InvalidatedProperty=e(),t.Spark.InvalidatedProperty.definition=e}(function(e={}){var i,n;return n=e.hasOwnProperty("Invalidator")?e.Invalidator:t.Spark.Invalidator,i=e.hasOwnProperty("CalculatedProperty")?e.CalculatedProperty:t.Spark.CalculatedProperty,function(){class t extends i{unknown(){return(this.calculated||!1===this.active)&&this._invalidateNotice(),this}static compose(e){if("function"==typeof e.options.calcul&&e.options.calcul.length>0)return e.instanceType.extend(t)}}return t.overrides({calcul:function(){return this.invalidator||(this.invalidator=new n(this,this.obj)),this.invalidator.recycle((t,e)=>(this.value=this.callOptionFunct(this.calculFunct,t),this.manual=!1,e(),t.isEmpty()?this.invalidator=null:t.bind())),this.revalidated(),this.value},destroy:function(){if(this.destroy.withoutInvalidatedProperty(),null!=this.invalidator)return this.invalidator.unbind()},invalidate:function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()&&null!=this.invalidator&&this.invalidator.unbind()),this}}),t}.call(this)}),function(e){t.Spark.Property=e(),t.Spark.Property.definition=e}(function(e={}){var i,n,r,a,s,o,l,h,u;return n=e.hasOwnProperty("BasicProperty")?e.BasicProperty:t.Spark.BasicProperty,a=e.hasOwnProperty("CollectionProperty")?e.CollectionProperty:t.Spark.CollectionProperty,s=e.hasOwnProperty("ComposedProperty")?e.ComposedProperty:t.Spark.ComposedProperty,o=e.hasOwnProperty("DynamicProperty")?e.DynamicProperty:t.Spark.DynamicProperty,r=e.hasOwnProperty("CalculatedProperty")?e.CalculatedProperty:t.Spark.CalculatedProperty,l=e.hasOwnProperty("InvalidatedProperty")?e.InvalidatedProperty:t.Spark.InvalidatedProperty,i=e.hasOwnProperty("ActivableProperty")?e.ActivableProperty:t.Spark.ActivableProperty,u=e.hasOwnProperty("PropertyOwner")?e.PropertyOwner:t.Spark.PropertyOwner,h=e.hasOwnProperty("Mixable")?e.Mixable:t.Spark.Mixable,function(){class t{constructor(t,e={}){this.name=t,this.options=e}bind(t){var e;return this,"function"==typeof t.getProperty&&t.getProperty(this.name)===this||("function"==typeof t.getProperty&&null!=(e=t.getProperty(this.name))&&this.override(e),this.getInstanceType().bind(t,this),t._properties=(t._properties||[]).concat([this]),null!=e&&(t._properties=t._properties.filter(function(t){return t!==e})),this.makeOwner(t)),this}override(t){var e,i,n,r;if(null==this.options.parent){for(e in this.options.parent=t.options,n=[],i=t.options)r=i[e],"function"==typeof this.options[e]&&"function"==typeof r?n.push(this.options[e].overrided=r):void 0===this.options[e]?n.push(this.options[e]=r):n.push(void 0);return n}}makeOwner(t){var e;if(!(null!=(e=t.extensions)?e.includes(u.prototype):void 0))return h.Extension.make(u.prototype,t)}getInstanceVarName(){return this.options.instanceVarName||"_"+this.name}isInstantiated(t){return null!=t[this.getInstanceVarName()]}getInstance(t){var e,i;return i=this.getInstanceVarName(),this.isInstantiated(t)||(e=this.getInstanceType(),t[i]=new e(this,t)),t[i]}getInstanceType(){return this.instanceType||this.composers.forEach(t=>t.compose(this)),this.instanceType}}return t.prototype.composers=[s,a,o,n,r,l,i],t}.call(this)}),function(e){t.Spark.Element=e(),t.Spark.Element.definition=e}(function(e={}){var i,n;return n=e.hasOwnProperty("Property")?e.Property:t.Spark.Property,i=e.hasOwnProperty("Mixable")?e.Mixable:t.Spark.Mixable,class extends i{tap(t){var e;return e=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,e.slice(1)):this[t].apply(this,e.slice(1)),this}callback(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=((...e)=>(this[t].apply(this,e),null))}getFinalProperties(){return null!=this._properties?["_properties"].concat(this._properties.map(function(t){return t.name})):[]}extended(t){var e,i,r,a,s,o;if(null!=this._properties){for(o=[],e=0,i=(s=this._properties).length;e<i;e++)a=s[e],r=Object.assign({},a.options),o.push(new n(a.name,r).bind(t));return o}}static property(t,e){return new n(t,e).bind(this.prototype)}static properties(t){var e,i,n;for(i in n=[],t)e=t[i],n.push(this.property(i,e));return n}}}),function(e){t.PathWalk=e(),t.PathWalk.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,n=e.hasOwnProperty("Timing")?e.Timing:t.Timing,function(){class t extends i{constructor(t,e,i){super(),this.walker=t,this.path=e,this.setProperties(i)}start(){if(this.path.solution||this.path.calcul(),this.path.solution)return this.pathTimeout=this.timing.setTimeout(()=>this.end(),this.totalTime),this.pathTimeout.updater.addCallback(this.callback("update"))}stop(){return this.pathTimeout.pause()}update(){var t;return t=this.path.getPosAtPrc(this.pathTimeout.getPrc()),this.walker.tile=t.tile,this.walker.offsetX=t.offsetX,this.walker.offsetY=t.offsetY}end(){return this.update(),this.destroy()}destroy(){return this.pathTimeout.destroy(),this.destroyProperties()}}return t.properties({speed:{default:5},timing:{calcul:function(){return new n}},pathLength:{calcul:function(){return this.path.solution.getTotalLength()}},totalTime:{calcul:function(){return this.pathLength/this.speed*1e3}}}),t}.call(this)}),function(e){t.Damageable=e(),t.Damageable.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,function(){class t extends i{damage(t){return this.health=Math.max(0,this.health-t)}whenNoHealth(){}}return t.properties({damageable:{default:!0},maxHealth:{default:1e3},health:{default:1e3,change:function(){if(0===this.health)return this.whenNoHealth()}}}),t}.call(this)}),function(e){t.PathFinder=e(),t.PathFinder.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,(n=function(){class t extends i{constructor(t,e,i,n={}){super(),this.tilesContainer=t,this.from=e,this.to=i,this.reset(),null!=n.validTile&&(this.validTileCallback=n.validTile)}reset(){return this.queue=[],this.paths={},this.solution=null,this.started=!1}calcul(){for(;!this.solution&&(!this.started||this.queue.length);)this.step();return this.getPath()}step(){var t;return this.queue.length?(t=this.queue.pop(),this.addNextSteps(t),!0):this.started?void 0:(this.started=!0,this.addNextSteps(),!0)}getPath(){var t,e;if(this.solution){for(t=[this.solution],e=this.solution;null!=e.prev;)t.unshift(e.prev),e=e.prev;return t}}getPosAtPrc(t){if(isNaN(t))throw new Error("Invalid number");if(this.solution)return this.getPosAtTime(this.solution.getTotalLength()*t)}getPosAtTime(t){var e,i;if(this.solution){if(t>=this.solution.getTotalLength())return this.solution.posToTileOffset(this.solution.getExit().x,this.solution.getExit().y);for(i=this.solution;i.getStartLength()>t&&null!=i.prev;)i=i.prev;return e=(t-i.getStartLength())/i.getLength(),i.posToTileOffset(i.getEntry().x+(i.getExit().x-i.getEntry().x)*e,i.getEntry().y+(i.getExit().y-i.getEntry().y)*e)}}tileIsValid(t){return null!=this.validTileCallback?this.validTileCallback(t):!t.emulated||0!==t.tile&&!1!==t.tile}getTile(t,e){var i;return null!=this.tilesContainer.getTile?this.tilesContainer.getTile(t,e):null!=(null!=(i=this.tilesContainer[e])?i[t]:void 0)?{x:t,y:e,tile:this.tilesContainer[e][t],emulated:!0}:void 0}getConnectedToTile(t){var e,i;return null!=t.getConnected?t.getConnected():(e=[],(i=this.getTile(t.x+1,t.y))&&e.push(i),(i=this.getTile(t.x-1,t.y))&&e.push(i),(i=this.getTile(t.x,t.y+1))&&e.push(i),(i=this.getTile(t.x,t.y-1))&&e.push(i),e)}addNextSteps(e=null){var i,n,r,a,s,o;for(o=null!=e?e.nextTile:this.from,s=[],i=0,n=(a=this.getConnectedToTile(o)).length;i<n;i++)r=a[i],this.tileIsValid(r)?s.push(this.addStep(new t.Step(this,null!=e?e:null,o,r))):s.push(void 0);return s}tileEqual(t,e){return t===e||(t.emulated||e.emulated)&&t.x===e.x&&t.y===e.y}addStep(e){if(null==this.paths[e.getExit().x]&&(this.paths[e.getExit().x]={}),!(null!=this.paths[e.getExit().x][e.getExit().y]&&this.paths[e.getExit().x][e.getExit().y].getTotalLength()<=e.getTotalLength())&&(null!=this.paths[e.getExit().x][e.getExit().y]&&this.removeStep(this.paths[e.getExit().x][e.getExit().y]),this.paths[e.getExit().x][e.getExit().y]=e,this.queue.splice(this.getStepRank(e),0,e),this.tileEqual(e.nextTile,this.to)&&!(null!=this.solution&&this.solution.prev.getTotalLength()<=e.getTotalLength())))return this.solution=new t.Step(this,e,e.nextTile,null)}removeStep(t){var e;if((e=this.queue.indexOf(t))>-1)return this.queue.splice(e,1)}best(){return this.queue[this.queue.length-1]}getStepRank(t){return 0===this.queue.length?0:this._getStepRank(t.getEfficiency(),0,this.queue.length-1)}_getStepRank(t,e,i){var n,r;return r=Math.floor((i-e)/2)+e,(n=this.queue[r].getEfficiency())===t?r:n>t?r===e?e:this._getStepRank(t,e,r-1):r===i?i+1:this._getStepRank(t,r+1,i)}}return t.properties({validTileCallback:{}}),t}.call(this)).Step=class{constructor(t,e,i,n){this.pathFinder=t,this.prev=e,this.tile=i,this.nextTile=n}posToTileOffset(t,e){var i;return{x:t,y:e,tile:i=Math.floor(t)===this.tile.x&&Math.floor(e)===this.tile.y?this.tile:null!=this.nextTile&&Math.floor(t)===this.nextTile.x&&Math.floor(e)===this.nextTile.y?this.nextTile:null!=this.prev&&Math.floor(t)===this.prev.tile.x&&Math.floor(e)===this.prev.tile.y?this.prev.tile:console.log("Math.floor("+t+") == "+this.tile.x,"Math.floor("+e+") == "+this.tile.y,this),offsetX:t-i.x,offsetY:e-i.y}}getExit(){return null==this.exit&&(null!=this.nextTile?this.exit={x:(this.tile.x+this.nextTile.x+1)/2,y:(this.tile.y+this.nextTile.y+1)/2}:this.exit={x:this.tile.x+.5,y:this.tile.y+.5}),this.exit}getEntry(){return null==this.entry&&(null!=this.prev?this.entry={x:(this.tile.x+this.prev.tile.x+1)/2,y:(this.tile.y+this.prev.tile.y+1)/2}:this.entry={x:this.tile.x+.5,y:this.tile.y+.5}),this.entry}getLength(){return null==this.length&&(this.length=null==this.nextTile||null==this.prev?.5:this.prev.tile.x===this.nextTile.x||this.prev.tile.y===this.nextTile.y?1:Math.sqrt(.5)),this.length}getStartLength(){return null==this.startLength&&(this.startLength=null!=this.prev?this.prev.getTotalLength():0),this.startLength}getTotalLength(){return null==this.totalLength&&(this.totalLength=this.getStartLength()+this.getLength()),this.totalLength}getEfficiency(){return null==this.efficiency&&(this.efficiency=1.1*-this.getRemaining()-this.getTotalLength()),this.efficiency}getRemaining(){var t,e,i,n;return null==this.remaining&&(t=this.getExit(),i=(e={x:this.pathFinder.to.x+.5,y:this.pathFinder.to.y+.5}).x-t.x,n=e.y-t.y,this.remaining=Math.sqrt(i*i+n*n)),this.remaining}},n}),function(e){t.Tiled=e(),t.Tiled.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,function(){class t extends i{}return t.properties({tile:{change:function(t){if(null!=t&&t.removeChild(this),this.tile)return this.tile.addChild(this)}},offsetX:{default:0},offsetY:{default:0}}),t}.call(this)}),function(e){t.Door=e(),t.Door.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Tiled")?e.Tiled:t.Tiled,function(){class t extends i{constructor(e=t.directions.horizontal){super(),this.direction=e}updateTileMembers(t){var e,i,n,r;if(null!=t&&(null!=(e=t.walkableMembers)&&e.removeRef("open",this),null!=(i=t.transparentMembers)&&i.removeRef("open",this)),this.tile)return null!=(n=this.tile.walkableMembers)&&n.addPropertyRef("open",this),null!=(r=this.tile.transparentMembers)?r.addPropertyRef("open",this):void 0}}return t.properties({tile:{change:function(t,e){return e(),this.updateTileMembers(t)}},open:{default:!1},direction:{}}),t.directions={horizontal:"horizontal",vertical:"vertical"},t}.call(this)}),function(e){t.Character=e(),t.Character.definition=e}(function(e={}){var i,n,r,a;return a=e.hasOwnProperty("Tiled")?e.Tiled:t.Tiled,n=e.hasOwnProperty("PathFinder")?e.PathFinder:t.PathFinder,r=e.hasOwnProperty("PathWalk")?e.PathWalk:t.PathWalk,i=e.hasOwnProperty("Damageable")?e.Damageable:t.Damageable,function(){class t extends a{constructor(t){super(),this.name=t}walkTo(t){var e;return null!=this.walk&&this.walk.end(),e=new n(this.tile.container,this.tile,t,{validTile:function(t){return t.walkable}}),this.walk=new r(this,e),this.walk.start()}}return t.extend(i),t}.call(this)}),function(e){t.AutomaticDoor=e(),t.AutomaticDoor.definition=e}(function(e={}){var i,n;return n=e.hasOwnProperty("Door")?e.Door:t.Door,i=e.hasOwnProperty("Character")?e.Character:t.Character,function(){class t extends n{updateTileMembers(t){var e,i,n,r;if(null!=t&&(null!=(e=t.walkableMembers)&&e.removeRef("unlocked",this),null!=(i=t.transparentMembers)&&i.removeRef("open",this)),this.tile)return null!=(n=this.tile.walkableMembers)&&n.addPropertyRef("unlocked",this),null!=(r=this.tile.transparentMembers)?r.addPropertyRef("open",this):void 0}init(){return super.init(),this.open}isActivatorPresent(t){return this.getReactiveTiles().some(e=>{return(t?t.prop("children",e):e.children).some(t=>this.canBeActivatedBy(t))})}canBeActivatedBy(t){return t instanceof i}getReactiveTiles(){return this.direction===n.directions.horizontal?[this.tile,this.tile.getRelativeTile(0,1),this.tile.getRelativeTile(0,-1)].filter(function(t){return null!=t}):[this.tile,this.tile.getRelativeTile(1,0),this.tile.getRelativeTile(-1,0)].filter(function(t){return null!=t})}}return t.properties({open:{calcul:function(t){return!t.prop("locked")&&this.isActivatorPresent(t)}},locked:{default:!1},unlocked:{calcul:function(t){return!t.prop("locked")}}}),t}.call(this)}),function(e){t.Direction=e(),t.Direction.definition=e}(function(){var t;return(t=class{constructor(t,e,i,n){this.name=t,this.x=e,this.y=i,this.inverseName=n}getInverse(){return this.constructor[this.inverseName]}}).up=new t("up",0,-1,"down"),t.down=new t("down",0,1,"up"),t.left=new t("left",-1,0,"right"),t.right=new t("right",1,0,"left"),t.adjacents=[t.up,t.down,t.left,t.right],t.topLeft=new t("topLeft",-1,-1,"bottomRight"),t.topRight=new t("topRight",1,-1,"bottomLeft"),t.bottomRight=new t("bottomRight",1,1,"topLeft"),t.bottomLeft=new t("bottomLeft",-1,1,"topRight"),t.corners=[t.topLeft,t.topRight,t.bottomRight,t.bottomLeft],t.all=[t.up,t.down,t.left,t.right,t.topLeft,t.topRight,t.bottomRight,t.bottomLeft],t}),function(e){t.LineOfSight=e(),t.LineOfSight.definition=e}(function(){return class{constructor(t,e=0,i=0,n=0,r=0){this.tiles=t,this.x1=e,this.y1=i,this.x2=n,this.y2=r}setX1(t){return this.x1=t,this.invalidade()}setY1(t){return this.y1=t,this.invalidade()}setX2(t){return this.x2=t,this.invalidade()}setY2(t){return this.y2=t,this.invalidade()}invalidade(){return this.endPoint=null,this.success=null,this.calculated=!1}testTile(t,e,i){return null!=this.traversableCallback?this.traversableCallback(t,e,i):null!=t&&("function"==typeof t.getTransparent?t.getTransparent():void 0===typeof t.transparent||t.transparent)}testTileAt(t,e,i,n){return this.testTile(this.tiles.getTile(Math.floor(t),Math.floor(e)),i,n)}calcul(){var t,e,i,n,r,a,s,o,l,h;for(r=(this.x2-this.x1)/(this.y2-this.y1),o=Math.abs(this.x2-this.x1)+Math.abs(this.y2-this.y1),i=this.x2-this.x1>=0,n=this.y2-this.y1>=0,a=l=this.x1,s=h=this.y1;o>Math.abs(l-this.x1)+Math.abs(h-this.y1)&&this.testTileAt(a,s,l,h);)t=i?Math.floor(l)+1:Math.ceil(l)-1,e=n?Math.floor(h)+1:Math.ceil(h)-1,this.x2-this.x1==0?h=e:this.y2-this.y1==0?l=t:Math.abs((t-l)/(this.x2-this.x1))<Math.abs((e-h)/(this.y2-this.y1))?(l=t,h=(t-this.x1)/r+this.y1):(l=(e-this.y1)*r+this.x1,h=e),a=i?l:Math.ceil(l)-1,s=n?h:Math.ceil(h)-1;return o<=Math.abs(l-this.x1)+Math.abs(h-this.y1)?(this.endPoint={x:this.x2,y:this.y2,tile:this.tiles.getTile(Math.floor(this.x2),Math.floor(this.y2))},this.success=!0):(this.endPoint={x:l,y:h,tile:this.tiles.getTile(Math.floor(a),Math.floor(s))},this.success=!1)}getSuccess(){return this.calculated||this.calcul(),this.success}getEndPoint(){return this.calculated||this.calcul(),this.endPoint}}}),function(e){t.DamagePropagation=e(),t.DamagePropagation.definition=e}(function(e={}){var i,n,r,a;return r=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,a=e.hasOwnProperty("LineOfSight")?e.LineOfSight:t.LineOfSight,n=e.hasOwnProperty("Direction")?e.Direction:t.Direction,(i=function(){class t extends r{constructor(t){super(),this.setProperties(t)}getTileContainer(){return this.tile.container}apply(){var t,e,i,n,r;for(r=[],e=0,i=(n=this.getDamaged()).length;e<i;e++)t=n[e],r.push(t.target.damage(t.damage));return r}getInitialTiles(){return this.getTileContainer().inRange(this.tile,this.range)}getInitialDamages(){var t,e,i,n,r,a;for(t=[],i=0,n=(a=this.getInitialTiles()).length;i<n;i++)(r=a[i]).damageable&&(e=this.initialDamage(r,a.length))&&t.push(e);return t}getDamaged(){var t;if(null==this._damaged)for(t=null;t=this.step(t););return this._damaged}step(t){return null==t?this._damaged=this.getInitialDamages():null!=this.extendedDamage?(t=this.extend(t),this._damaged=t.concat(this._damaged),t.length>0&&t):void 0}inDamaged(t,e){var i,n,r;for(i=n=0,r=e.length;n<r;i=++n)if(e[i].target===t)return i;return!1}extend(t){var e,i,r,a,s,o,l,h,u,c,p,d,f,y,g,m;for(i=this.getTileContainer(),e=[],l=0,u=t.length;l<u;l++){if(d=[],null!=(r=t[l]).target.x)for(h=0,c=(y=n.adjacents).length;h<c;h++)a=y[h],null!=(m=i.getTile(r.target.x+a.x,r.target.y+a.y))&&m.damageable&&!1===this.inDamaged(m,this._damaged)&&d.push(m);for(f=0,p=d.length;f<p;f++)g=d[f],(s=this.extendedDamage(g,r,d.length))&&(!1===(o=this.inDamaged(g,e))?e.push(s):e[o]=this.mergeDamage(e[o],s))}return e}mergeDamage(t,e){return{target:t.target,power:t.power+e.power,damage:t.damage+e.damage}}modifyDamage(t,e){return"function"==typeof t.modifyDamage?Math.floor(t.modifyDamage(e,this.type)):Math.floor(e)}}return t.properties({tile:{default:null},power:{default:10},range:{default:1},type:{default:null}}),t}.call(this)).Normal=class extends i{initialDamage(t,e){var i;if((i=this.modifyDamage(t,this.power))>0)return{target:t,power:this.power,damage:i}}},i.Thermic=class extends i{extendedDamage(t,e,i){var n,r;if(r=(e.damage-1)/2/i*Math.min(1,e.target.health/e.target.maxHealth*5),(n=this.modifyDamage(t,r))>0)return{target:t,power:r,damage:n}}initialDamage(t,e){var i,n;if(n=this.power/e,(i=this.modifyDamage(t,n))>0)return{target:t,power:n,damage:i}}},i.Kinetic=class extends i{extendedDamage(t,e,i){var n,r;if(r=(e.power-e.damage)*Math.min(1,e.target.health/e.target.maxHealth*2)-1,(n=this.modifyDamage(t,r))>0)return{target:t,power:r,damage:n}}initialDamage(t,e){var i;if((i=this.modifyDamage(t,this.power))>0)return{target:t,power:this.power,damage:i}}modifyDamage(t,e){return"function"==typeof t.modifyDamage?Math.floor(t.modifyDamage(e,this.type)):Math.floor(.25*e)}mergeDamage(t,e){return{target:t.target,power:Math.floor((t.power+e.power)/2),damage:Math.floor((t.damage+e.damage)/2)}}},i.Explosive=function(){class t extends i{getDamaged(){var t,e,i,n,r,a,s;for(this._damaged=[],a=Math.pow(this.range+1,2),r=this.power/a,(e=this.tile.health<=this.modifyDamage(this.tile,r))&&(r*=4),i=0,n=a;0<=n?i<=n:i>=n;0<=n?++i:--i)t=this.rng()*Math.PI*2,null!=(s=this.getTileHitByShard(e,t))&&this._damaged.push({target:s,power:r,damage:this.modifyDamage(s,r)});return this._damaged}getTileHitByShard(t,e){var i,n,r,s;return i=this.getTileContainer(),n=this.range*this.rng(),r={x:this.tile.x+.5+n*Math.cos(e),y:this.tile.y+.5+n*Math.sin(e)},t?((s=new a(i,this.tile.x+.5,this.tile.y+.5,r.x,r.y)).traversableCallback=(e=>!t||null!=e&&this.traversableCallback(e)),s.getEndPoint().tile):i.getTile(Math.floor(r.x),Math.floor(r.y))}}return t.properties({rng:{default:Math.random},traversableCallback:{default:function(t){return!("function"==typeof t.getSolid&&t.getSolid())}}}),t}.call(this),i}),function(e){t.Element=e(),t.Element.definition=e}(function(e={}){return e.hasOwnProperty("Element")?e.Element:t.Spark.Element}),function(e){t.Tile=e(),t.Tile.definition=e}(function(e={}){var i,n;return n=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,i=e.hasOwnProperty("Direction")?e.Direction:t.Direction,function(){class t extends n{constructor(t,e){super(),this.x=t,this.y=e,this.init()}init(){return null}getRelativeTile(t,e){if(null!=this.container)return this.container.getTile(this.x+t,this.y+e)}findDirectionOf(t){if(t.tile&&(t=t.tile),null!=t.x&&null!=t.y)return i.all.find(e=>e.x===t.x-this.x&&e.y===t.y-this.y)}addChild(t,e=!0){return-1===this.children.indexOf(t)&&this.children.push(t),e&&(t.tile=this),t}removeChild(t,e=!0){var i;if((i=this.children.indexOf(t))>-1&&this.children.splice(i,1),e&&t.tile===this)return t.tile=null}dist(t){var e,i,n,r;return null==(null!=t?t.x:void 0)||null==t.y||null==this.x||null==this.y||this.container!==t.container&&!(e=null!=(i=this.container)&&"function"==typeof i.dist?i.dist(t.container):void 0)?null:(n=t.x-this.x,r=t.y-this.y,e&&(n+=e.x,r+=e.y),{x:n,y:r,length:Math.sqrt(n*n+r*r)})}}return t.properties({children:{collection:!0},container:{change:function(){return this.adjacentTiles.forEach(function(t){return t.invalidateAdjacentTiles()})}},adjacentTiles:{calcul:function(t){if(null!=this.container)return i.adjacents.map(t=>this.getRelativeTile(t.x,t.y)).filter(t=>null!=t)},collection:!0}}),t}.call(this)}),function(e){t.Floor=e(),t.Floor.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Tile")?e.Tile:t.Tile,function(){class t extends i{}return t.properties({walkable:{composed:!0},transparent:{composed:!0}}),t}.call(this)}),function(e){t.Projectile=e(),t.Projectile.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,n=e.hasOwnProperty("Timing")?e.Timing:t.Timing,function(){class t extends i{constructor(t){super(),this.setProperties(t),this.init()}init(){}launch(){return this.moving=!0,this.pathTimeout=this.timing.setTimeout(()=>(this.deliverPayload(),this.moving=!1),this.pathLength/this.speed*1e3)}deliverPayload(){var t;return(t=new this.propagationType({tile:this.target.tile||this.target,power:this.power,range:this.blastRange})).apply(),this.payloadDelivered(),t}payloadDelivered(){return this.destroy()}destroy(){return this.destroyProperties()}}return t.properties({origin:{default:null},target:{default:null},power:{default:10},blastRange:{default:1},propagationType:{default:null},speed:{default:10},pathLength:{calcul:function(){var t;return null!=this.originTile&&null!=this.targetTile&&(t=this.originTile.dist(this.targetTile))?t.length:100}},originTile:{calcul:function(t){var e;if(null!=(e=t.prop("origin")))return e.tile||e}},targetTile:{calcul:function(t){var e;if(null!=(e=t.prop("target")))return e.tile||e}},container:{calcul:function(t){var e,i;return e=t.prop("originTile"),i=t.prop("targetTile"),e.container===i.container?e.container:t.prop("prcPath")>.5?i.container:e.container}},x:{calcul:function(t){var e;return e=t.prop("startPos"),(t.prop("targetPos").x-e.x)*t.prop("prcPath")+e.x}},y:{calcul:function(t){var e;return e=t.prop("startPos"),(t.prop("targetPos").y-e.y)*t.prop("prcPath")+e.y}},startPos:{calcul:function(t){var e,i,n,r;return r=t.prop("originTile"),e=t.prop("container"),n=this.startOffset,r.container!==e&&(i=e.dist(r.container),n.x+=i.x,n.y+=i.y),{x:r.x+n.x,y:r.y+n.y}},output:function(t){return Object.assign({},t)}},targetPos:{calcul:function(t){var e,i,n,r;return r=t.prop("targetTile"),e=t.prop("container"),n=this.targetOffset,r.container!==e&&(i=e.dist(r.container),n.x+=i.x,n.y+=i.y),{x:r.x+n.x,y:r.y+n.y}},output:function(t){return Object.assign({},t)}},startOffset:{default:{x:.5,y:.5},output:function(t){return Object.assign({},t)}},targetOffset:{default:{x:.5,y:.5},output:function(t){return Object.assign({},t)}},prcPath:{calcul:function(){var t;return(null!=(t=this.pathTimeout)?t.getPrc():void 0)||0}},timing:{calcul:function(){return new n}},moving:{default:!1}}),t}.call(this)}),function(e){t.TileContainer=e(),t.TileContainer.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,function(){class t extends i{constructor(){super(),this.init()}_addToBondaries(t,e){if((null==e.top||t.y<e.top)&&(e.top=t.y),(null==e.left||t.x<e.left)&&(e.left=t.x),(null==e.bottom||t.y>e.bottom)&&(e.bottom=t.y),null==e.right||t.x>e.right)return e.right=t.x}init(){return this.coords={},this.tiles=[]}addTile(t){var e;return this.tiles.includes(t)||(this.tiles.push(t),null==this.coords[t.x]&&(this.coords[t.x]={}),this.coords[t.x][t.y]=t,t.container=this,(null!=(e=this._boundaries)?e.calculated:void 0)&&this._addToBondaries(t,this._boundaries.value)),this}removeTile(t){var e,i;if((e=this.tiles.indexOf(t))>-1&&(this.tiles.splice(e,1),delete this.coords[t.x][t.y],t.container=null,(null!=(i=this._boundaries)?i.calculated:void 0)&&(this.boundaries.top===t.y||this.boundaries.bottom===t.y||this.boundaries.left===t.x||this.boundaries.right===t.x)))return this.invalidateBoundaries()}removeTileAt(t,e){var i;if(i=this.getTile(t,e))return this.removeTile(i)}getTile(t,e){var i;if(null!=(null!=(i=this.coords[t])?i[e]:void 0))return this.coords[t][e]}loadMatrix(t){var e,i,n,r,a;for(a in t)for(r in i=t[a])n=i[r],e={x:parseInt(r),y:parseInt(a)},"function"==typeof n?this.addTile(n(e)):(n.x=e.x,n.y=e.y,this.addTile(n));return this}inRange(t,e){var i,n,r,a,s,o,l,h,u,c;for(h=[],e--,u=n=a=t.x-e,s=t.x+e;a<=s?n<=s:n>=s;u=a<=s?++n:--n)for(c=r=o=t.y-e,l=t.y+e;o<=l?r<=l:r>=l;c=o<=l?++r:--r)Math.sqrt((u-t.x)*(u-t.x)+(c-t.y)*(c-t.y))<=e&&null!=(i=this.getTile(u,c))&&h.push(i);return h}allTiles(){return this.tiles.slice()}clearAll(){var t,e,i;for(t=0,e=(i=this.tiles).length;t<e;t++)i[t].container=null;return this.coords={},this.tiles=[],this}}return t.properties({boundaries:{calcul:function(){var t;return t={top:null,left:null,bottom:null,right:null},this.tiles.forEach(e=>this._addToBondaries(e,t)),t},output:function(t){return Object.assign({},t)}}}),t}.call(this)}),function(e){t.RoomGenerator=e(),t.RoomGenerator.definition=e}(function(e={}){var n,r,a,s,o;return r=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,o=e.hasOwnProperty("TileContainer")?e.TileContainer:t.TileContainer,s=e.hasOwnProperty("Tile")?e.Tile:t.Tile,n=e.hasOwnProperty("Door")?e.Door:t.Door,(a=function(){class t extends r{constructor(t){super(),this.setProperties(t),this.directions=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],this.corners=[{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}],this.allDirections=this.directions.concat(this.corners)}init(){return this.finalTiles=null,this.rooms=[],this.free=this.tileContainer.allTiles().filter(t=>{var e,i,n,r;for(i=0,n=(r=this.allDirections).length;i<n;i++)if(e=r[i],null==this.tileContainer.getTile(t.x+e.x,t.y+e.y))return!1;return!0})}calcul(){for(this.init(),0;this.step()||this.newRoom();)0;return this.createDoors(),this.rooms,this.makeFinalTiles()}makeFinalTiles(){return this.finalTiles=this.tileContainer.allTiles().map(t=>{var e;if(null!=t.factory)return e={x:t.x,y:t.y},null!=t.factoryOptions&&(e=Object.assign(e,t.factoryOptions)),t.factory(e)}).filter(t=>null!=t)}getTiles(){return null==this.finalTiles&&this.calcul(),this.finalTiles}newRoom(){if(this.free.length)return this.volume=Math.floor(this.rng()*(this.maxVolume-this.minVolume))+this.minVolume,this.room=new t.Room}randomDirections(){var t,e,i,n;for(e=void 0,n=void 0,t=(i=this.directions.slice()).length;t;)e=Math.floor(this.rng()*t),n=i[--t],i[t]=i[e],i[e]=n;return i}step(){var t,e;if(this.room){if(this.free.length&&this.room.tiles.length<this.volume-1){if(this.room.tiles.length){for(e=this.randomDirections(),t=!1;e.length&&!t;)t=this.expand(this.room,e.pop(),this.volume);return t||this.roomDone(),t}return this.allocateTile(this.randomFreeTile(),this.room),!0}return this.roomDone(),!1}}roomDone(){return this.rooms.push(this.room),this.allocateWalls(this.room),this.room=null}expand(t,e,i=0){var n,r,a,s,o,l,h;for(l=!1,n=0,r=(s=t.tiles).length;n<r;n++)h=s[n],(0===i||t.tiles.length<i)&&((a=this.tileOffsetIsFree(h,e))&&(this.allocateTile(a,t),l=!0),(o=this.tileOffsetIsFree(h,e,2))&&!this.tileOffsetIsFree(h,e,3)&&this.allocateTile(o,t));return l}allocateWalls(t){var e,n,r,a,s,o,l,h,u;for(h=[],n=0,r=(l=t.tiles).length;n<r;n++)u=l[n],h.push(function(){var n,r,l,h;for(h=[],n=0,r=(l=this.allDirections).length;n<r;n++)e=l[n],null!=(a=this.tileContainer.getTile(u.x+e.x,u.y+e.y))&&a.room!==t?(i.call(this.corners,e)<0&&(o=this.tileContainer.getTile(u.x+2*e.x,u.y+2*e.y),s=null!=(null!=o?o.room:void 0)?o.room:null,t.addWall(a,s),null!=s&&s.addWall(a,t)),a.factory=this.wallFactory,h.push(this.allocateTile(a))):h.push(void 0);return h}.call(this));return h}createDoors(){var t,e,i,r,a,s,o;for(a=[],e=0,i=(r=this.rooms).length;e<i;e++)s=r[e],a.push(function(){var e,i,r,a;for(a=[],e=0,i=(r=s.wallsByRooms()).length;e<i;e++)null!=(o=r[e]).room&&s.doorsForRoom(o.room)<1?((t=o.tiles[Math.floor(this.rng()*o.tiles.length)]).factory=this.doorFactory,t.factoryOptions={direction:this.tileContainer.getTile(t.x+1,t.y).factory===this.floorFactory?n.directions.vertical:n.directions.horizontal},s.addDoor(t,o.room),a.push(o.room.addDoor(t,s))):a.push(void 0);return a}.call(this));return a}allocateTile(t,e=null){var i;if(null!=e&&(e.addTile(t),t.factory=this.floorFactory),(i=this.free.indexOf(t))>-1)return this.free.splice(i,1)}tileOffsetIsFree(t,e,i=1){return this.tileIsFree(t.x+e.x*i,t.y+e.y*i)}tileIsFree(t,e){var n;return null!=(n=this.tileContainer.getTile(t,e))&&i.call(this.free,n)>=0&&n}randomFreeTile(){return this.free[Math.floor(this.rng()*this.free.length)]}}return t.properties({rng:{default:Math.random},maxVolume:{default:25},minVolume:{default:50},width:{default:30},height:{default:15},tileContainer:{calcul:function(){var t,e,i,n,r,a,l;for(r=new o,a=t=0,i=this.width;0<=i?t<=i:t>=i;a=0<=i?++t:--t)for(l=e=0,n=this.height;0<=n?e<=n:e>=n;l=0<=n?++e:--e)r.addTile(new s(a,l));return r}},floorFactory:{default:function(t){return new s(t.x,t.y)}},wallFactory:{default:null},doorFactory:{calcul:function(){return this.floorFactory}}}),t}.call(this)).Room=class{constructor(){this.tiles=[],this.walls=[],this.doors=[]}addTile(t){return this.tiles.push(t),t.room=this}containsWall(t){var e,i,n,r;for(e=0,i=(n=this.walls).length;e<i;e++)if((r=n[e]).tile===t)return r;return!1}addWall(t,e){var i;return(i=this.containsWall(t))?i.nextRoom=e:this.walls.push({tile:t,nextRoom:e})}wallsByRooms(){var t,e,i,n,r,a,s;for(a=[],r=[],t=0,e=(n=this.walls).length;t<e;t++)s=n[t],-1===(i=a.indexOf(s.nextRoom))&&(i=a.length,a.push(s.nextRoom),r.push({room:s.nextRoom,tiles:[]})),r[i].tiles.push(s.tile);return r}addDoor(t,e){return this.doors.push({tile:t,nextRoom:e})}doorsForRoom(t){var e,i,n,r,a;for(a=[],i=0,n=(r=this.doors).length;i<n;i++)(e=r[i]).nextRoom===t&&a.push(e.tile);return a}},a}),function(e){t.Star=e(),t.Star.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,(n=function(){class t extends i{constructor(t,e){super(),this.x=t,this.y=e,this.init()}init(){}linkTo(t){if(!this.links.findStar(t))return this.addLink(new this.constructor.Link(this,t))}addLink(t){return this.links.add(t),t.otherStar(this).links.add(t),t}dist(t,e){var i,n;return i=this.x-t,n=this.y-e,Math.sqrt(i*i+n*n)}}return t.properties({x:{},y:{},links:{collection:{findStar:function(t){return this.find(function(e){return e.star2===t||e.star1===t})}}}}),t.collenctionFn={closest:function(t,e){var i,n;return i=null,n=null,this.forEach(function(r){var a;if(a=r.dist(t,e),null==i||n>a)return i=r,n=a}),i},closests:function(t,e){var i;return(i=this.map(function(i){return{dist:i.dist(t,e),star:i}})).sort(function(t,e){return t.dist-e.dist}),this.copy(i.map(function(t){return t.star}))}},t}.call(this)).Link=class extends i{constructor(t,e){super(),this.star1=t,this.star2=e}remove(){return this.star1.links.remove(this),this.star2.links.remove(this)}otherStar(t){return t===this.star1?this.star2:this.star1}getLength(){return this.star1.dist(this.star2.x,this.star2.y)}inBoundaryBox(t,e,i=0){var n,r,a,s;return n=Math.min(this.star1.x,this.star2.x)-i,a=Math.min(this.star1.y,this.star2.y)-i,r=Math.max(this.star1.x,this.star2.x)+i,s=Math.max(this.star1.y,this.star2.y)+i,t>=n&&t<=r&&e>=a&&e<=s}closeToPoint(t,e,i){var n,r,a,s,o,l,h,u,c,p;return!!this.inBoundaryBox(t,e,i)&&(n=this.star1,l={x:t,y:e},h=(o=this.star2).x-n.x,c=o.y-n.y,Math.sqrt(h*h+c*c),a=Math.atan(c/h),u=l.x-n.x,p=l.y-n.y,s=Math.sqrt(u*u+p*p),r=a-Math.atan(p/u),Math.abs(Math.sin(r)*s)<=i)}intersectLink(t){var e,i,n,r,a,s,o,l,h,u,c,p;return o=this.star1.x,u=this.star1.y,l=this.star2.x,c=this.star2.y,h=t.star1.x,p=t.star1.y,s=((r=t.star2.x-h)*(u-p)-(a=t.star2.y-p)*(o-h))/(-r*(n=c-u)+(i=l-o)*a),(e=(-n*(o-h)+i*(u-p))/(-r*n+i*a))>0&&e<1&&s>0&&s<1}},n}),function(e){t.Weapon=e(),t.Weapon.definition=e}(function(e={}){var i,n,r,a;return r=e.hasOwnProperty("Tiled")?e.Tiled:t.Tiled,a=e.hasOwnProperty("Timing")?e.Timing:t.Timing,i=e.hasOwnProperty("Damageable")?e.Damageable:t.Damageable,n=e.hasOwnProperty("Projectile")?e.Projectile:t.Projectile,function(){class t extends r{constructor(t){super(),this.setProperties(t)}fire(){var t;if(this.canFire)return(t=new n({origin:this,target:this.target,power:this.power,blastRange:this.blastRange,propagationType:this.propagationType,speed:this.projectileSpeed,timing:this.timing})).launch(),this.charged=!1,this.recharge(),t}recharge(){return this.charging=!0,this.chargeTimeout=this.timing.setTimeout(()=>(this.charging=!1,this.recharged()),this.rechargeTime)}recharged(){if(this.charged=!0,this.autoFire)return this.fire()}}return t.extend(i),t.properties({rechargeTime:{default:1e3},power:{default:10},blastRange:{default:1},propagationType:{default:null},projectileSpeed:{default:10},target:{default:null,change:function(){if(this.autoFire)return this.fire()}},charged:{default:!0},charging:{default:!0},enabled:{default:!0},autoFire:{default:!0},criticalHealth:{default:.3},canFire:{get:function(){return this.target&&this.enabled&&this.charged&&this.health/this.maxHealth>=this.criticalHealth}},timing:{calcul:function(){return new a}}}),t}.call(this)}),function(e){t.SignalOperation=e(),t.SignalOperation.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,class extends i{constructor(){super(),this.queue=[],this.limiters=[]}addOperation(t,e=1){return e?this.queue.unshift(t):this.queue.push(t)}addLimiter(t){if(!this.findLimiter(t))return this.limiters.push(t)}findLimiter(t){return this.limiters.indexOf(t)>-1}start(){var t;for(t=[];this.queue.length;)t.push(this.step());return t}step(){var t;return 0===this.queue.length?this.done():(t=this.queue.shift(t))(this)}done(){}}}),function(e){t.Connected=e(),t.Connected.definition=e}(function(e={}){var i,n;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,n=e.hasOwnProperty("SignalOperation")?e.SignalOperation:t.SignalOperation,function(){class t extends i{canConnectTo(t){return"function"==typeof t.addSignal}acceptSignal(t){return!0}onAddConnection(t){}onRemoveConnection(t){}onNewSignalType(t){}onAddSignal(t,e){}onRemoveSignal(t,e){}onRemoveSignalType(t,e){}onReplaceSignal(t,e,i){}containsSignal(t,e=!1,i){return this.signals.find(function(n){return n.match(t,e,i)})}addSignal(t,e){var i;return(null!=e?e.findLimiter(this):void 0)||(e||(e=new n,i=!0),e.addOperation(()=>{var i;if(!this.containsSignal(t,!0)&&this.acceptSignal(t)&&(i=this.containsSignal(t),this.signals.push(t),this.onAddSignal(t,e),!i))return this.onNewSignalType(t,e)}),i&&e.start()),t}removeSignal(t,e){var i;if(!(null!=e?e.findLimiter(this):void 0)&&(e||(e=new n,i=!0),e.addOperation(()=>{var i;if((i=this.containsSignal(t,!0))&&this.acceptSignal(t)&&(this.signals.splice(this.signals.indexOf(i),1),this.onRemoveSignal(t,e),e.addOperation(()=>{var i;return(i=this.containsSignal(t))?this.onReplaceSignal(t,i,e):this.onRemoveSignalType(t,e)},0)),stepByStep)return e.step()}),i))return e.start()}prepForwardedSignal(t){return t.last===this?t:t.withLast(this)}forwardSignal(t,e){var i;return this.forwardedSignals.add(t),i=this.prepForwardedSignal(t),this.outputs.forEach(function(n){if(t.last!==n)return n.addSignal(i,e)})}forwardAllSignalsTo(t,e){return this.signals.forEach(i=>{var n;return n=this.prepForwardedSignal(i),t.addSignal(n,e)})}stopForwardedSignal(t,e){var i;return this.forwardedSignals.remove(t),i=this.prepForwardedSignal(t),this.outputs.forEach(function(n){if(t.last!==n)return n.removeSignal(i,e)})}stopAllForwardedSignalTo(t,e){return this.signals.forEach(i=>{var n;return n=this.prepForwardedSignal(i),t.removeSignal(n,e)})}forwardSignalTo(t,e,i){var n;if(n=this.prepForwardedSignal(t),t.last!==e)return e.addSignal(n,i)}stopForwardedSignalTo(t,e,i){var n;if(n=this.prepForwardedSignal(t),t.last!==e)return e.removeSignal(n,i)}}return t.properties({signals:{collection:!0},inputs:{collection:!0},outputs:{collection:!0,itemAdded:function(t,e){return this.forwardedSignals.forEach(e=>this.forwardSignalTo(e,t))},itemRemoved:function(t,e){return this.forwardedSignals.forEach(e=>this.stopForwardedSignalTo(e,t))}},forwardedSignals:{collection:!0}}),t}.call(this)}),function(e){t.Signal=e(),t.Signal.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Element")?e.Element:t.Spark.Element,class extends i{constructor(t,e="signal",i=!1){super(),this.origin=t,this.type=e,this.exclusive=i,this.last=this.origin}withLast(t){var e;return(e=new this.__proto__.constructor(this.origin,this.type,this.exclusive)).last=t,e}copy(){var t;return(t=new this.__proto__.constructor(this.origin,this.type,this.exclusive)).last=this.last,t}match(t,e=!1,i=this.exclusive){return(!e||t.last===this.last)&&(i||t.origin===this.origin)&&t.type===this.type}}}),function(e){t.SignalSource=e(),t.SignalSource.definition=e}(function(e={}){var i,n,r;return i=e.hasOwnProperty("Connected")?e.Connected:t.Connected,n=e.hasOwnProperty("Signal")?e.Signal:t.Signal,r=e.hasOwnProperty("SignalOperation")?e.SignalOperation:t.SignalOperation,function(){class t extends i{}return t.properties({activated:{change:function(){var t;return t=new r,this.activated?this.forwardSignal(this.signal,t):this.stopForwardedSignal(this.signal,t),t.start()}},signal:{calcul:function(){return new n(this,"power",!0)}}}),t}.call(this)}),function(e){t.Switch=e(),t.Switch.definition=e}(function(e={}){var i;return i=e.hasOwnProperty("Connected")?e.Connected:t.Connected,class extends i{}}),function(e){t.Wire=e(),t.Wire.definition=e}(function(e={}){var n,r;return r=e.hasOwnProperty("Tiled")?e.Tiled:t.Tiled,e.hasOwnProperty("Direction")?e.Direction:t.Direction,n=e.hasOwnProperty("Connected")?e.Connected:t.Connected,function(){class t extends r{constructor(t="red"){super(),this.wireType=t}findDirectionsTo(t){return(null!=t.tiles?t.tiles.map(t=>this.tile.findDirectionOf(t)):[this.tile.findDirectionOf(t)]).filter(function(t){return null!=t})}canConnectTo(t){return n.prototype.canConnectTo.call(this,t)&&(null==t.wireType||t.wireType===this.wireType)}onNewSignalType(t,e){return this.forwardSignal(t,e)}}return t.extend(n),t.properties({outputs:{calcul:function(t){var e;return(e=t.prop("tile"))?t.prop("adjacentTiles",e).reduce((e,i)=>e.concat(t.prop("children",i).filter(t=>this.canConnectTo(t)).toArray()),[]):[]}},connectedDirections:{calcul:function(t){return t.prop("outputs").reduce((t,e)=>(this.findDirectionsTo(e).forEach(function(e){if(i.call(t,e)<0)return t.push(e)}),t),[])}}}),t}.call(this)}),function(e){t.Spark.EventEmitter=e(),t.Spark.EventEmitter.definition=e}(function(){return function(){class t{getAllEvents(){return this._events||(this._events={})}getListeners(t){var e;return(e=this.getAllEvents())[t]||(e[t]=[])}hasListener(t,e){return this.getListeners(t).includes(e)}addListener(t,e){if(!this.hasListener(t,e))return this.getListeners(t).push(e),this.listenerAdded(t,e)}listenerAdded(t,e){}removeListener(t,e){var i,n;if(-1!==(i=(n=this.getListeners(t)).indexOf(e)))return n.splice(i,1),this.listenerRemoved(t,e)}listenerRemoved(t,e){}emitEvent(t,...e){return this.getListeners(t).forEach(function(t){return t(...e)})}}return t.prototype.emit=t.prototype.emitEvent,t.prototype.trigger=t.prototype.emitEvent,t.prototype.on=t.prototype.addListener,t.prototype.off=t.prototype.removeListener,t}.call(this)})}).call(this),function(){var t,e,i;t="undefined"!=typeof module&&null!==module?(null==(e=module.exports).DOM&&(e.DOM={}),e.DOM):(e=this.Parallelio,null==this.Parallelio.DOM&&(this.Parallelio.DOM={}),this.Parallelio.DOM),i=function(t={}){var i,n;return i=t.hasOwnProperty("BaseUpdater")?t.BaseUpdater:e.Spark.Updater,(n=class extends i{constructor(){super(),this.updateCallback=(()=>this.update()),this.binded=!1}update(){if(super.update(),this.binded=!1,this.callbacks.length>0)return this.requestFrame()}requestFrame(){if(!this.binded)return window.requestAnimationFrame(this.updateCallback),this.binded=!0}addCallback(t){return super.addCallback(t),this.requestFrame()}}).instance=new n,n},t.Updater=i(),t.Updater.definition=i,function(e){t.Display=e(),t.Display.definition=e}(function(i={}){var n,r;return n=i.hasOwnProperty("Element")?i.Element:e.Element,r=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{initDisplay(){return this.cls,this.displayX,this.displayY,this.displayContainer}destroyDisplay(){if(null!=this._display)return this.display.remove()}}return t.include(EventEmitter.prototype),t.properties({displayContainer:{updater:r.instance,default:null,change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},cls:{updater:r.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.cls)return this.display.addClass(this.cls)}},display:{calcul:function(){var t,e;return e=document.createElement("div"),(t=jQuery(e).addClass(this.baseCls)).get(0)._parallelio_obj=this,t}},displayX:{updater:r.instance,active:function(t){return t.propInitiated("display")},change:function(t){return this.display.css({left:this.displayX})}},displayY:{updater:r.instance,active:function(t){return t.propInitiated("display")},change:function(t){return this.display.css({top:this.displayY})}}}),t}.call(this)}),function(e){t.Tiled=e(),t.Tiled.definition=e}(function(i={}){var n,r;return n=i.hasOwnProperty("BaseTiled")?i.BaseTiled:e.Tiled,r=i.hasOwnProperty("Display")?i.Display:t.Display,function(){class t extends n{constructor(){super(),this.initDisplay()}}return t.extend(r),t.include(EventEmitter.prototype),t.properties({displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return t.prop("displayContainer",e)}},displayX:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayX+e.tileToDisplayX(t.prop("offsetX"))}},displayY:{calcul:function(t){var e;if(null!=(e=t.prop("tile")))return e.displayY+e.tileToDisplayY(t.prop("offsetY"))}}}),t}.call(this)}),function(e){t.Character=e(),t.Character.definition=e}(function(i={}){var n,r;return r=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,n=i.hasOwnProperty("BaseCharacter")?i.BaseCharacter:e.Character.definition({Tiled:r}),i.hasOwnProperty("Updater")?i.Updater:t.Updater,class extends n{constructor(){super(),this.baseCls="character"}}}),function(e){t.Damageable=e(),t.Damageable.definition=e}(function(i={}){var n,r,a;return n=i.hasOwnProperty("BaseDamageable")?i.BaseDamageable:e.Damageable,r=i.hasOwnProperty("Display")?i.Display:t.Display,a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{constructor(){super(),this.healthCls(),this.initDisplay()}}return t.extend(r),t.include(EventEmitter.prototype),t.properties({healthClsSteps:{default:10},healthCls:{updater:a.instance,active:function(t){return t.propInitiated("display")},calcul:function(t){return"health-"+Math.ceil(t.prop("health")/t.prop("maxHealth")*t.prop("healthClsSteps"))},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.healthCls)return this.display.addClass(this.healthCls)}}}),t}.call(this)}),function(e){t.Door=e(),t.Door.definition=e}(function(i={}){var n,r,a;return r=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,n=i.hasOwnProperty("BaseDoor")?i.BaseDoor:e.Door.definition({Tiled:r}),a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{constructor(t){super(t),this.baseCls="door"}}return t.properties({direction:{updater:a.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t),null!=this.direction)return this.display.addClass(this.direction)}}}),t}.call(this)}),function(e){t.Projectile=e(),t.Projectile.definition=e}(function(i={}){var n,r,a;return n=i.hasOwnProperty("BaseProjectile")?i.BaseProjectile:e.Projectile,r=i.hasOwnProperty("Display")?i.Display:t.Display,a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{init(){return super.init(),this.baseCls="projectile",this.initDisplay()}destroy(){return this.destroyDisplay(),a.instance.removeCallback(this.callback("invalidatePrcPath"))}}return t.extend(r),t.properties({displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):t.prop("originTile").displayContainer}},displayX:{calcul:function(t){return this.originTile.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.originTile.tileToDisplayY(t.prop("y"))}},moving:{change:function(){return this.moving?a.instance.addCallback(this.callback("invalidatePrcPath")):a.instance.removeCallback(this.callback("invalidatePrcPath"))}}}),t}.call(this)}),function(e){t.Tile=e(),t.Tile.definition=e}(function(i={}){var n,r,a,s;return r=i.hasOwnProperty("BaseTile")?i.BaseTile:e.Tile,n=i.hasOwnProperty("BaseFloor")?i.BaseFloor:e.Floor,a=i.hasOwnProperty("Display")?i.Display:t.Display,(s=function(){class t extends r{init(){return super.init(),this.baseCls="tile",this.initDisplay()}tileToDisplayX(e){return e*t.size}tileToDisplayY(e){return e*t.size}}return t.extend(a),t.size=20,t.properties({container:{},displayContainer:{calcul:function(t){var e;return(null!=(e=t.prop("container"))?e.getProperty("tileDisplay"):void 0)?t.prop("tileDisplay",e):(null!=e?e.getProperty("display"):void 0)?t.prop("display",e):void 0}},displayX:{calcul:function(t){return this.tileToDisplayX(t.prop("x"))}},displayY:{calcul:function(t){return this.tileToDisplayY(t.prop("y"))}}}),t}.call(this)).Floor=class extends(n.definition({Tile:s})){init(){return super.init(),this.cls="floor"}},s}),function(e){t.Ship=e(),t.Ship.definition=e}(function(i={}){var n,r,a,s,o;return s=i.hasOwnProperty("Tile")?i.Tile:t.Tile,o=i.hasOwnProperty("TileContainer")?i.TileContainer:e.TileContainer,n=i.hasOwnProperty("DefaultGenerator")?i.DefaultGenerator:e.RoomGenerator,r=i.hasOwnProperty("Door")?i.Door:t.Door,(a=function(){class t extends o{init(){return super.init(),this.displayContainer}generate(e){return(e=e||(new t.Generator).tap(function(){})).getTiles().forEach(t=>this.addTile(t))}}return t.include(EventEmitter.prototype),t.properties({container:{},displayContainer:{calcul:function(t){var e;if(null!=(e=t.prop("container"))?e.getProperty("display"):void 0)return e.display},change:function(){if(null!=this.displayContainer)return this.display.appendTo(this.displayContainer)}},display:{calcul:function(){var t;return(t=$(document.createElement("div")).addClass("ship")).get(0)._parallelio_obj=this,t}}}),t}.call(this)).Generator=class extends n{wallFactory(t){return new s(t.x,t.y).tap(function(){return this.cls="wall",this.walkable=!1})}floorFactory(t){return new s.Floor(t.x,t.y)}doorFactory(t){return new s.Floor(t.x,t.y).tap(function(){return this.addChild(new r(t.direction))})}},a}),function(e){t.View=e(),t.View.definition=e}(function(t={}){var i;return i=t.hasOwnProperty("Element")?t.Element:e.Element,function(){class t extends i{constructor(t=null){super(),this.display=t,this.hovered=!1,this.keysInterval={}}mouseEnter(){return this.hovered=!0,$("body").keydown(this.callback("keyDown")),$("body").keyup(this.callback("keyUp"))}mouseLeave(){var t,e,i,n;for(t in this.hovered=!1,$("body").off("keydown",this.callback("keyDown")),$("body").off("keyup",this.callback("keyUp")),n=[],i=this.keysInterval)e=i[t],n.push(clearInterval(e));return n}keyDown(e){var i;if(null!=t.directionkeys[e.which])return i=t.directionkeys[e.which],null!=this.keysInterval[i.name]&&clearInterval(this.keysInterval[i.name]),this.keysInterval[i.name]=setInterval(()=>(this.x+=2*i.x,this.y+=2*i.y),10)}keyUp(e){var i;if(null!=t.directionkeys[e.which]&&(i=t.directionkeys[e.which],null!=this.keysInterval[i.name]))return clearInterval(this.keysInterval[i.name])}updateDisplayPos(){return $(".viewContent",this.display).css({left:this.x+"px",top:this.y+"px"})}containsPoint(t,e){var i;for(i=this.display[0];i;)t-=i.offsetLeft,e-=i.offsetTop,i=i.offsetParent;return 0<=t&&t<=this.display.width()&&0<=e&&e<=this.display.height()}}return t.directionkeys={38:{name:"top",x:0,y:-1},39:{name:"right",x:1,y:0},40:{name:"bottom",x:0,y:1},37:{name:"left",x:-1,y:0}},t.properties({x:{default:0,change:function(){return this.updateDisplayPos()}},y:{default:0,change:function(){return this.updateDisplayPos()}},display:{change:function(){return 0===$(".viewContent",this.display).length&&$(this.display).append('<div class="viewContent"></div>'),this.updateDisplayPos(),$(this.display).mouseenter(this.callback("mouseEnter")),$(this.display).mouseleave(this.callback("mouseLeave"))}}}),t}.call(this)}),function(e){t.Weapon=e(),t.Weapon.definition=e}(function(i={}){var n,r,a,s,o;return s=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,a=i.hasOwnProperty("Projectile")?i.Projectile:t.Projectile,r=i.hasOwnProperty("Damageable")?i.Damageable:t.Damageable,n=i.hasOwnProperty("BaseWeapon")?i.BaseWeapon:e.Weapon.definition({Tiled:s,Damageable:r,Projectile:a}),o=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{constructor(t){super(t),this.baseCls="weapon"}}return t.properties({direction:{updater:o.instance,active:function(t){return t.propInitiated("display")},change:function(t){if(null!=t&&this.display.removeClass(t.name),null!=this.direction.name)return this.display.addClass(this.direction.name)}}}),t}.call(this)}),function(e){t.Wire=e(),t.Wire.definition=e}(function(i={}){var n,r,a;return r=i.hasOwnProperty("Tiled")?i.Tiled:t.Tiled,n=i.hasOwnProperty("BaseWire")?i.BaseWire:e.Wire.definition({Tiled:r}),a=i.hasOwnProperty("Updater")?i.Updater:t.Updater,function(){class t extends n{constructor(t){super(t),this.baseCls="wire",this.connectedDirections}getClassFromDirection(t){return"conn"+t.name.charAt(0).toUpperCase()+t.name.slice(1)}}return t.properties({display:{calcul:function(t,e){return e()}},connectedDirections:{updater:a.instance,active:function(t){return t.propInitiated("display")},change:function(t){return t&&t.forEach(t=>this.display.removeClass(this.getClassFromDirection(t))),this.connectedDirections.forEach(t=>this.display.addClass(this.getClassFromDirection(t)))}},wireType:{updater:a.instance,active:function(t){return t.propInitiated("display")},change:function(t){return t&&this.display.removeClass(t),this.display.addClass(this.wireType)}}}),t}.call(this)})}.call(this);